# IMPROVEMENTS.md

## Purpose
This document tracks architecture improvements in two independent passes:
1. Frontend context (`apps/filament-client-web`)
2. Backend context (`filament-server` + shared Rust crates)

Each pass should be actionable on its own while staying comparable through a shared structure.

## How To Iterate Across Separate Contexts
- Update only the relevant pass section for the current context.
- Keep completed items immutable; append deltas in the "Iteration Log".
- Preserve security posture from `AGENTS.md` (no relaxed limits/timeouts/validation).
- For each proposed change, include: objective, risk, smallest safe increment, success metric.

## Shared Scoring Rubric
Use this rubric in each pass for objective comparison.

| Dimension | 1 (Weak) | 3 (Moderate) | 5 (Strong) |
| --- | --- | --- | --- |
| Modularity | Large mixed modules, unclear seams | Some separation, partial seams | Small focused modules with clear boundaries |
| Correctness Safety | Sparse guards/tests | Good tests in core paths | Broad characterization + boundary contract tests |
| Security Hardening | Inconsistent input constraints | Core constraints present | Strict boundary validation + limits + hostile-input assumptions throughout |
| Operability | Hard to diagnose failures | Basic status/error surfacing | Explicit metrics/logging/debug signals and deterministic failure modes |
| Change Velocity | Refactors risky/slower | Manageable with care | Incremental changes are predictable and low-risk |

---

## Frontend Pass (Completed First Draft)
Date: 2026-02-12
Scope: `apps/filament-client-web`

### Evidence Sampled
- Routing/auth shell: `src/main.tsx`, `src/App.tsx`, `src/components/RouteGuards.tsx`
- Composition runtime: `src/pages/AppShellPage.tsx`, `src/features/app-shell/runtime/create-app-shell-runtime.ts`
- Boundaries/domain: `src/lib/api.ts`, `src/lib/gateway.ts`, `src/domain/auth.ts`
- State/selectors/controllers: `src/features/app-shell/state/*`, `src/features/app-shell/selectors/create-app-shell-selectors.ts`, `src/features/app-shell/controllers/*`
- Hardening + budget: `security/csp.json`, `scripts/check-app-shell-size.mjs`, `tests/api-boundary.test.ts`
- Refactor history: `plans/PLAN_WEB_REFACTOR.md`

### Objective Architecture Snapshot
- App uses a thin route/auth entry and a feature-centric app shell.
- `create-app-shell-runtime.ts` acts as the composition root wiring multiple controllers and state slices.
- Domain newtypes and invariant constructors exist in `src/domain/*` and are used at API/gateway parsing boundaries.
- Security-first client constraints are explicit (strict CSP, bounded response parsing, timeout defaults, no HTML rendering path in sampled files).
- Test coverage is broad and feature-oriented (48 test files).

### Baseline Metrics
- `src/pages/AppShellPage.tsx`: 312 lines
- `src/features/app-shell/runtime/create-app-shell-runtime.ts`: 1048 lines
- `src/lib/api.ts`: 1293 lines
- `src/lib/gateway.ts`: 2259 lines
- Frontend test files: 48

### Scorecard (Current)
| Dimension | Score | Rationale |
| --- | --- | --- |
| Modularity | 4/5 | Strong controller/state extraction, but runtime + transport layers remain very large |
| Correctness Safety | 4/5 | Extensive targeted tests, especially boundary/controller behavior |
| Security Hardening | 5/5 | Clear hostile-input posture with caps/timeouts/CSP and strict domain parsing |
| Operability | 3/5 | Good user-facing status/error mapping, limited explicit client diagnostics/telemetry seams |
| Change Velocity | 3/5 | Most UI changes are safe; large runtime/transport files still concentrate change risk |

### Frontend Improvement Backlog
| ID | Priority | Area | Observation | Proposed Increment | Success Metric |
| --- | --- | --- | --- | --- | --- |
| FE-01 | P0 | Runtime composition | `create-app-shell-runtime.ts` is a >1k-line orchestration hub with many responsibilities | Split runtime into bounded domain composers (`workspace`, `messaging`, `voice`, `overlay`) with a thin top-level factory | Runtime file < 700 lines and no behavior regressions in existing controller/runtime tests |
| FE-02 | P0 | Gateway boundary | `lib/gateway.ts` is a very large mixed parser/transport/event-routing unit | Extract versioned event decoder registry (`{v,t,d}`) and per-domain event modules; keep strict caps | Gateway core < 900 lines; add contract tests for unknown event type/version handling |
| FE-03 | P0 | API boundary | `lib/api.ts` centralizes all endpoints and response handling into one large module | Keep shared bounded request primitives but split endpoint groups (`auth`, `messages`, `workspace`, `friends`, `voice`) | API modules independently testable; unchanged boundary-hardening tests pass |
| FE-04 | P1 | Async state model | Many independent status/error strings increase implicit state combinations | Introduce typed async operation states for high-churn flows (message send/history refresh/voice join) | Fewer impossible UI states; add reducer/state transition tests |
| FE-05 | P1 | Dependency boundaries | Feature internals are mostly clean, but imports rely on convention | Add lint/import-boundary rules to enforce `domain -> lib -> feature UI` layering | CI fails on boundary violations; no new cross-layer leaks |
| FE-06 | P1 | Operability | Failure mapping is deterministic, but diagnostics are mostly local UI status text | Add explicit client diagnostics hooks (structured event counters + dev-only debug panel wiring) without exposing sensitive data | Faster triage of gateway/API failures; no token leakage in logs/tests |
| FE-07 | P2 | Rendering scalability | Message/voice surfaces can grow in dense channels | Evaluate targeted list virtualization for message list while preserving scroll/history semantics | Stable scroll behavior with large histories and no regression in history scroll tests |

Item Status
- FE-01: Completed on 2026-02-13 (all planned slices 1–32 completed; runtime composition root `src/features/app-shell/runtime/create-app-shell-runtime.ts` reduced to 645 lines, meeting the FE-01 `<700 lines` success metric while preserving prior focused runtime/controller test coverage).
- FE-02: In progress (slices 1–27 completed on 2026-02-14: extracted strict `{v,t,d}` envelope parsing into `src/lib/gateway-envelope.ts`, extracted presence-domain decoder registry/parsing into `src/lib/gateway-presence-events.ts`, extracted friend-domain decoder registry/parsing into `src/lib/gateway-friend-events.ts`, extracted profile-domain decoder registry/parsing into `src/lib/gateway-profile-events.ts`, extracted message-domain decoder registry/parsing into `src/lib/gateway-message-events.ts`, extracted workspace-domain decoder registry/parsing into `src/lib/gateway-workspace-events.ts`, extracted voice-domain dispatch routing into `src/lib/gateway-voice-dispatch.ts`, extracted presence-domain dispatch routing into `src/lib/gateway-presence-dispatch.ts`, extracted friend-domain dispatch routing into `src/lib/gateway-friend-dispatch.ts`, extracted profile-domain dispatch routing into `src/lib/gateway-profile-dispatch.ts`, extracted message-domain dispatch routing into `src/lib/gateway-message-dispatch.ts`, extracted workspace-domain dispatch routing into `src/lib/gateway-workspace-dispatch.ts`, extracted ordered cross-domain dispatch orchestration into `src/lib/gateway-domain-dispatch.ts`, extracted ready-event parsing/dispatch into `src/lib/gateway-ready-dispatch.ts`, aligned voice-domain dispatch event classification to consume the decoder registry type guard from `src/lib/gateway-voice-events.ts` (removing duplicated voice event-type lists), extracted gateway payload/handler contracts into `src/lib/gateway-contracts.ts` so `src/lib/gateway.ts` stays transport/wiring-focused while preserving fail-closed behavior, extracted workspace role-event decoder registry/parsing into `src/lib/gateway-workspace-role-events.ts` while keeping `src/lib/gateway-workspace-events.ts` focused on non-role workspace events, extracted workspace member-event decoder registry/parsing into `src/lib/gateway-workspace-member-events.ts` while keeping `src/lib/gateway-workspace-events.ts` focused on role/member delegation plus non-role/non-member workspace events, aligned workspace-domain dispatch event classification to consume decoder-registry type guards from `src/lib/gateway-workspace-events.ts` (removing duplicated workspace event-type lists while preserving fail-closed handling), extracted workspace IP-ban event decoder/parsing into `src/lib/gateway-workspace-ip-ban-events.ts` while keeping `src/lib/gateway-workspace-events.ts` focused on role/member/IP-ban delegation plus remaining non-role workspace events, extracted workspace channel-override event decoder/parsing into `src/lib/gateway-workspace-channel-override-events.ts` while keeping `src/lib/gateway-workspace-events.ts` focused on role/member/IP-ban/channel-override delegation plus remaining non-role workspace events, extracted workspace update-event decoder/parsing into `src/lib/gateway-workspace-update-events.ts` while keeping `src/lib/gateway-workspace-events.ts` focused on role/member/IP-ban/channel-override/workspace-update delegation plus remaining non-role workspace events, extracted workspace channel-create decoder/parsing into `src/lib/gateway-workspace-channel-events.ts` while keeping `src/lib/gateway-workspace-events.ts` focused on role/member/IP-ban/channel-override/workspace-update/channel-create delegation, switched workspace-domain aggregate classification/decoding in `src/lib/gateway-workspace-events.ts` to explicit type-guard and decoder registries to remove ad hoc branch chains while preserving strict fail-closed decoding, extracted voice stream event decoder registry/parsing into `src/lib/gateway-voice-stream-events.ts` while keeping `src/lib/gateway-voice-events.ts` focused on participant events plus stream decoder delegation, extracted voice participant event decoder registry/parsing into `src/lib/gateway-voice-participant-events.ts` while keeping `src/lib/gateway-voice-events.ts` focused on aggregate participant/stream delegation, and switched voice-domain aggregate classification/decoding in `src/lib/gateway-voice-events.ts` to explicit type-guard and decoder registries to remove ad hoc branch chains while preserving strict fail-closed decoding).
- FE-02: In progress status delta on 2026-02-14 (slice 28 completed: extracted workspace role-assignment decoder registry/parsing into `src/lib/gateway-workspace-role-assignment-events.ts`, rewired `src/lib/gateway-workspace-role-events.ts` to delegate assignment event decoding/type classification, and preserved fail-closed behavior through focused assignment + aggregate regression tests).
- FE-02: In progress status delta on 2026-02-14 (slice 29 completed: extracted workspace role-reorder decoder registry/parsing into `src/lib/gateway-workspace-role-reorder-events.ts`, rewired `src/lib/gateway-workspace-role-events.ts` to delegate reorder event decoding/type classification, and preserved fail-closed behavior through focused reorder + aggregate workspace regression tests).
- FE-02: In progress status delta on 2026-02-14 (slice 30 completed: extracted workspace role-create decoder/parsing into `src/lib/gateway-workspace-role-create-events.ts`, rewired `src/lib/gateway-workspace-role-events.ts` to delegate create-event decoding/type classification, and preserved fail-closed behavior through focused create + aggregate workspace regression tests).
- FE-02: In progress status delta on 2026-02-14 (slice 31 completed: extracted workspace role-delete decoder/parsing into `src/lib/gateway-workspace-role-delete-events.ts`, rewired `src/lib/gateway-workspace-role-events.ts` to delegate delete-event decoding/type classification, and preserved fail-closed behavior through focused delete + aggregate workspace regression tests).
- FE-02: In progress status delta on 2026-02-14 (slice 32 completed: extracted workspace role-update decoder/parsing into `src/lib/gateway-workspace-role-update-events.ts`, rewired `src/lib/gateway-workspace-role-events.ts` to delegate update-event decoding/type classification, and preserved fail-closed behavior through focused update + aggregate workspace regression tests).
- FE-02: In progress status delta on 2026-02-14 (slice 33 completed: extracted workspace role-assignment-add decoder/parsing into `src/lib/gateway-workspace-role-assignment-add-events.ts`, rewired `src/lib/gateway-workspace-role-assignment-events.ts` to delegate add-event decoding/type classification, and preserved fail-closed behavior through focused assignment-add + aggregate workspace regression tests).
- FE-02: In progress status delta on 2026-02-14 (slice 34 completed: extracted workspace role-assignment-remove decoder/parsing into `src/lib/gateway-workspace-role-assignment-remove-events.ts`, rewired `src/lib/gateway-workspace-role-assignment-events.ts` to delegate remove-event decoding/type classification, and preserved fail-closed behavior through focused assignment-remove + aggregate workspace regression tests).
- FE-02: In progress status delta on 2026-02-14 (slice 35 completed: replaced ad hoc workspace role aggregate branching in `src/lib/gateway-workspace-role-events.ts` with explicit type-guard and decoder registries, kept role-assignment variants delegated through dedicated add/remove decoders to preserve strict typing and fail-closed decoding, and added focused type-guard regression coverage in `tests/gateway-workspace-role-events.test.ts`).
- FE-02: In progress status delta on 2026-02-14 (slice 36 completed: rewired `src/lib/gateway-workspace-role-events.ts` to delegate role-assignment variant payload decoding through aggregate `decodeWorkspaceRoleAssignmentGatewayEvent` from `src/lib/gateway-workspace-role-assignment-events.ts` instead of directly consuming add/remove decoders, preserving strict fail-closed behavior with focused invalid-assignment regression coverage in `tests/gateway-workspace-role-events.test.ts`).
- FE-02: In progress status delta on 2026-02-14 (slice 37 completed: replaced ad hoc aggregate role-assignment payload-decoder mapping in `src/lib/gateway-workspace-role-assignment-events.ts` with explicit type-guard and decoder registries that delegate directly to add/remove event decoders while preserving strict fail-closed behavior, and added focused invalid assignment-add regression coverage in `tests/gateway-workspace-role-assignment-events.test.ts`).
- FE-02: In progress status delta on 2026-02-14 (slice 38 completed: extracted role-assignment variant payload delegation from `src/lib/gateway-workspace-role-events.ts` into `src/lib/gateway-workspace-role-assignment-payload-events.ts`, rewired workspace role aggregate decoder registry to consume the dedicated payload helper, and preserved strict fail-closed behavior through focused payload-helper + aggregate workspace role regression tests).
- FE-02: In progress status delta on 2026-02-14 (slice 39 completed: extracted `workspace_member_update` decoder/parsing into `src/lib/gateway-workspace-member-update-events.ts`, rewired `src/lib/gateway-workspace-member-events.ts` to delegate update-event decoding/type classification to the dedicated module while preserving strict fail-closed behavior, and added focused update-module + aggregate member regression coverage).
- FE-02: In progress status delta on 2026-02-14 (slice 40 completed: extracted `workspace_member_add` decoder/parsing into `src/lib/gateway-workspace-member-add-events.ts`, rewired `src/lib/gateway-workspace-member-events.ts` to delegate add-event decoding/type classification to the dedicated module while preserving strict fail-closed behavior, and added focused add-module + aggregate member regression coverage).
- FE-02: In progress status delta on 2026-02-14 (slice 41 completed: extracted `workspace_member_remove` decoder/parsing into `src/lib/gateway-workspace-member-remove-events.ts`, rewired `src/lib/gateway-workspace-member-events.ts` to delegate remove-event decoding/type classification to the dedicated module while preserving strict fail-closed behavior, and added focused remove-module + aggregate member regression coverage).
- FE-02: In progress status delta on 2026-02-14 (slice 42 completed: extracted `workspace_member_ban` decoder/parsing into `src/lib/gateway-workspace-member-ban-events.ts`, rewired `src/lib/gateway-workspace-member-events.ts` to delegate ban-event decoding/type classification to the dedicated module while preserving strict fail-closed behavior, and added focused ban-module + aggregate member regression coverage).
- FE-02: In progress status delta on 2026-02-14 (slice 43 completed: hardened `src/lib/gateway-workspace-member-events.ts` aggregate member-event type classification to reject prototype-chain keys by switching from ad hoc `in` checks to own-property validation, preserving strict fail-closed decoding for hostile event types with focused aggregate regression coverage).
- FE-02: In progress status delta on 2026-02-14 (slice 44 completed: hardened `src/lib/gateway-presence-events.ts` presence-event type classification to reject prototype-chain keys by switching from `in` checks to own-property validation, preserving strict fail-closed decoding for hostile event types with focused presence regression coverage).
- FE-02: In progress status delta on 2026-02-14 (slice 45 completed: hardened `src/lib/gateway-voice-participant-events.ts` and `src/lib/gateway-voice-stream-events.ts` event-type classification to reject prototype-chain keys by switching from `in` checks to own-property validation, preserving strict fail-closed decoding for hostile event types with focused voice participant/stream/aggregate regression coverage).
- FE-02: In progress status delta on 2026-02-14 (slice 46 completed: hardened `src/lib/gateway-friend-events.ts` event-type classification to reject prototype-chain keys by switching from `in` checks to own-property validation, preserving strict fail-closed decoding for hostile event types (including `__proto__`) with focused friend-event regression coverage).
- FE-02: In progress status delta on 2026-02-14 (slice 47 completed: hardened `src/lib/gateway-profile-events.ts` event-type classification to reject prototype-chain keys by switching from `in` checks to own-property validation, preserving strict fail-closed decoding for hostile event types (including `__proto__`) with focused profile-event regression coverage).
- FE-02: In progress status delta on 2026-02-14 (slice 48 completed: hardened `src/lib/gateway-message-events.ts` event-type classification to reject prototype-chain keys by switching from `in` checks to own-property validation, preserving strict fail-closed decoding for hostile event types (including `__proto__`) with focused message-event regression coverage).
- FE-02: In progress status delta on 2026-02-14 (slice 49 completed: hardened `src/lib/gateway-workspace-role-events.ts` aggregate role-event type classification to reject prototype-chain keys by switching from `in` checks to own-property validation, preserving strict fail-closed decoding for hostile event types (including `__proto__`) with focused workspace-role regression coverage).
- FE-02: In progress status delta on 2026-02-14 (slice 50 completed: replaced ad hoc array-based workspace role-assignment aggregate classification/decoding in `src/lib/gateway-workspace-role-assignment-events.ts` with explicit typed type-guard and payload decoder registries plus own-property gating, preserving strict fail-closed behavior for hostile event types (including `__proto__`) with focused role-assignment aggregate regression coverage).
- FE-02: In progress status delta on 2026-02-14 (slice 51 completed: hardened `src/lib/gateway-envelope.ts` to require own-property `{ v, t, d }` envelope fields before decode acceptance, preserving strict fail-closed behavior for malformed/partial envelopes, with focused envelope regression coverage).
- FE-02: In progress status delta on 2026-02-14 (slice 52 completed: replaced ad hoc array-based workspace aggregate classification/decoding in `src/lib/gateway-workspace-events.ts` with explicit typed domain registries plus own-property-gated registry iteration, preserving strict fail-closed behavior and decode precedence, with focused hostile-type regression coverage for `__proto__`).
- FE-02: Completed on 2026-02-14 (closeout slice completed: verified FE-02 exit criteria with targeted contract validation for unknown event type/version and hardened envelope decoding plus gateway core size check; `src/lib/gateway.ts` is 151 lines, satisfying the `< 900 lines` success metric).
- FE-03: In progress status delta on 2026-02-14 (slice 1 completed: extracted auth endpoint group (`registerWithPassword`/`loginWithPassword`/`refreshAuthSession`/`logoutAuthSession`) into `src/lib/api-auth.ts` behind shared bounded request primitives delegated from `src/lib/api.ts`, preserving strict fail-closed response-shape validation and existing API boundary behavior with focused auth + boundary regression tests).
- FE-03: In progress status delta on 2026-02-14 (slice 2 completed: extracted friends endpoint group (`fetchFriends`/`fetchFriendRequests`/`createFriendRequest`/`acceptFriendRequest`/`deleteFriendRequest`/`removeFriend`) into `src/lib/api-friends.ts`, rewired `src/lib/api.ts` to delegate through the dedicated module while preserving strict fail-closed `acceptFriendRequest` response-shape validation and bounded request primitives, and added focused friends-module regression coverage).
- FE-03: In progress status delta on 2026-02-15 (slice 3 completed: extracted voice endpoint group (`issueVoiceToken`) into `src/lib/api-voice.ts`, rewired `src/lib/api.ts` to delegate voice token issuance through the dedicated module while preserving strict fail-closed DTO parsing via domain invariants, and added focused voice-module regression coverage).
- FE-03: In progress status delta on 2026-02-15 (slice 4 completed: extracted message endpoint group (`fetchChannelMessages`/`createChannelMessage`/`editChannelMessage`/`deleteChannelMessage`/`addMessageReaction`/`removeMessageReaction`) into `src/lib/api-messages.ts`, rewired `src/lib/api.ts` to delegate through the dedicated module while preserving bounded query constraints, strict DTO parsing, and fail-closed `protocol_mismatch` handling for attachment create fallbacks, and added focused message-module + API boundary regression coverage).
- FE-03: In progress status delta on 2026-02-15 (slice 5 completed: extracted workspace role endpoint group (`fetchGuildRoles`/`createGuildRole`/`updateGuildRole`/`deleteGuildRole`/`reorderGuildRoles`/`assignGuildRole`/`unassignGuildRole`) into `src/lib/api-workspace.ts`, rewired `src/lib/api.ts` to delegate through the dedicated module while preserving strict fail-closed role-update/reorder validation and DTO parsing, and added focused workspace-module + API boundary regression coverage).
- FE-03: In progress status delta on 2026-02-15 (slice 6 completed: extracted workspace guild core endpoint group (`createGuild`/`fetchGuilds`/`updateGuild`) into `src/lib/api-workspace.ts`, rewired `src/lib/api.ts` to delegate through the dedicated module while preserving strict fail-closed guild-list shape validation and DTO parsing, and added focused workspace-module + API boundary regression coverage).
- FE-03: In progress status delta on 2026-02-15 (slice 7 completed: extracted public workspace directory endpoint group (`fetchPublicGuildDirectory`/`joinPublicGuild`) into `src/lib/api-workspace.ts`, rewired `src/lib/api.ts` to delegate directory listing/join through the dedicated module while preserving bounded query limits and strict fail-closed directory/join DTO parsing, and added focused workspace-module + API boundary regression coverage).
- FE-03: In progress status delta on 2026-02-15 (slice 8 completed: extracted workspace channel endpoint group (`fetchGuildChannels`/`createChannel`/`fetchChannelPermissionSnapshot`) into `src/lib/api-workspace.ts`, rewired `src/lib/api.ts` to delegate channel list/create/permission snapshot through the dedicated module while preserving strict fail-closed channel-list shape validation and channel/permission DTO parsing, and added focused workspace-module + API boundary regression coverage).
- FE-03: In progress status delta on 2026-02-15 (slice 9 completed: extracted workspace moderation endpoint group (`addGuildMember`/`updateGuildMemberRole`/`kickGuildMember`/`banGuildMember`/`setChannelRoleOverride`) into `src/lib/api-workspace.ts`, rewired `src/lib/api.ts` to delegate through the dedicated module while preserving strict fail-closed moderation DTO parsing and bounded override payload forwarding, and added focused workspace-module + API boundary regression coverage).
- FE-03: In progress status delta on 2026-02-15 (slice 10 completed: extracted search endpoint group (`searchGuildMessages`/`rebuildGuildSearchIndex`/`reconcileGuildSearchIndex`) into `src/lib/api-messages.ts`, rewired `src/lib/api.ts` to delegate search operations through the dedicated module while preserving bounded search query limits and strict fail-closed search/search-reconcile DTO parsing, and added focused message-module + API boundary regression coverage).
- FE-03: In progress status delta on 2026-02-15 (slice 11 completed: extracted channel attachment endpoint group (`uploadChannelAttachment`/`downloadChannelAttachment`/`downloadChannelAttachmentPreview`/`deleteChannelAttachment`) into `src/lib/api-messages.ts`, rewired `src/lib/api.ts` to delegate attachment operations through the dedicated module while preserving strict fail-closed attachment DTO parsing plus upload/download byte caps and preview timeout/size constraints, and added focused message-module + API boundary regression coverage).
- FE-03: In progress status delta on 2026-02-15 (slice 12 completed: extracted authenticated profile self-read endpoint wiring (`fetchMe`) into `src/lib/api-auth.ts`, rewired `src/lib/api.ts` to delegate `fetchMe` through the auth module while preserving strict fail-closed `/auth/me` shape validation and domain parsing, and added focused auth-module regression coverage).
- FE-03: In progress status delta on 2026-02-15 (slice 13 completed: extracted authenticated profile/user lookup endpoint group (`fetchUserProfile`/`updateMyProfile`/`lookupUsersByIds`) into `src/lib/api-auth.ts`, rewired `src/lib/api.ts` to delegate those endpoints through the auth module while preserving strict fail-closed profile DTO parsing and 1–64 user lookup bounds, and added focused auth-module regression coverage).
- FE-03: In progress status delta on 2026-02-15 (slice 14 completed: extracted authenticated profile avatar upload endpoint wiring (`uploadMyProfileAvatar`) into `src/lib/api-auth.ts`, rewired `src/lib/api.ts` to delegate avatar uploads through the auth module while preserving strict fail-closed profile DTO parsing and existing avatar size/content-type guardrails, and added focused auth-module regression coverage).
- FE-03: In progress status delta on 2026-02-15 (slice 15 completed: extracted system endpoint group (`fetchHealth`/`echoMessage`) into `src/lib/api-system.ts`, rewired `src/lib/api.ts` to delegate through the dedicated module while preserving strict fail-closed response-shape validation and existing API boundary hardening behavior, and added focused system-module regression coverage).
- FE-03: In progress status delta on 2026-02-15 (slice 16 completed: extracted auth-profile avatar URL construction (`profileAvatarUrl`) into `src/lib/api-auth.ts` behind the auth module boundary, rewired `src/lib/api.ts` to delegate avatar URL generation through `authApi`, preserved non-negative integer avatar-version normalization semantics, and added focused auth-module regression coverage).
- FE-03: In progress status delta on 2026-02-15 (slice 17 completed: extracted auth endpoint export-wiring/delegation from `src/lib/api.ts` into new `src/lib/api-auth-client.ts` facade, rewired `src/lib/api.ts` to consume the dedicated auth client while preserving strict fail-closed auth boundary behavior and existing bounded request primitives, and added focused auth-client delegation regression coverage).
- FE-03: In progress status delta on 2026-02-15 (slice 18 completed: extracted message endpoint export-wiring/delegation from `src/lib/api.ts` into new `src/lib/api-messages-client.ts` facade, rewired `src/lib/api.ts` to consume the dedicated messages client while preserving strict fail-closed message boundary behavior and existing bounded request/response primitives, and added focused message-client delegation regression coverage).
- FE-03: In progress status delta on 2026-02-15 (slice 19 completed: extracted friends endpoint export-wiring/delegation from `src/lib/api.ts` into new `src/lib/api-friends-client.ts`, rewired `src/lib/api.ts` to consume the dedicated friends client facade while preserving strict fail-closed friends boundary behavior and existing bounded request/response primitives, and added focused friends-client delegation regression coverage).
- FE-03: In progress status delta on 2026-02-15 (slice 20 completed: extracted workspace endpoint export-wiring/delegation from `src/lib/api.ts` into new `src/lib/api-workspace-client.ts`, rewired `src/lib/api.ts` to consume the dedicated workspace client facade while preserving strict fail-closed workspace boundary behavior and existing bounded request/response primitives, and added focused workspace-client delegation regression coverage).
- FE-03: In progress status delta on 2026-02-15 (slice 21 completed: extracted voice endpoint export-wiring/delegation from `src/lib/api.ts` into new `src/lib/api-voice-client.ts`, rewired `src/lib/api.ts` to consume the dedicated voice client facade while preserving strict fail-closed voice token DTO parsing and existing bounded request primitives, and added focused voice-client delegation regression coverage).
- FE-03: In progress status delta on 2026-02-15 (slice 22 completed: extracted system endpoint export-wiring/delegation from `src/lib/api.ts` into new `src/lib/api-system-client.ts`, rewired `src/lib/api.ts` to consume the dedicated system client facade while preserving strict fail-closed health/echo response-shape validation in `src/lib/api-system.ts`, and added focused system-client delegation regression coverage).
- FE-03: In progress status delta on 2026-02-15 (slice 23 completed: extracted shared API transport/boundary request primitives (`fetchWithTimeout`/`sendRequest`/bounded JSON+binary readers/error mapping) from `src/lib/api.ts` into new `src/lib/api-transport.ts`, rewired `src/lib/api.ts` into a thin client composition root that delegates through `createApiTransport`, preserved strict fail-closed caps/timeouts/error mapping behavior, and added focused malformed `content-length` boundary regression coverage in `tests/api-boundary.test.ts`).
- FE-03: Completed on 2026-02-15 (closeout slice completed: validated FE-03 exit criteria by confirming API domain/client module split remains green and boundary-hardening behavior is preserved via focused typecheck + API suite runs).
- FE-04: In progress status delta on 2026-02-15 (slices 1–4 completed: introduced typed async operation state primitives in `src/features/app-shell/state/async-operation-state.ts`, added typed async state signals for message send/history refresh/voice join in `src/features/app-shell/state/message-state.ts` and `src/features/app-shell/state/voice-state.ts`, rewired message send and message history controllers to emit typed `idle/running/succeeded/failed` transitions while preserving fail-closed error mapping and bounded behavior, rewired voice join operations to emit typed join transitions while preserving existing least-privilege token request and fail-closed join errors, and added focused regression coverage in state/controller tests).
- FE-04: In progress status delta on 2026-02-15 (slices 5–6 completed: removed duplicate mutable busy flags for message send and voice join by deriving `isSendingMessage` and `isJoiningVoice` directly from typed async operation phase state in `src/features/app-shell/state/message-state.ts` and `src/features/app-shell/state/voice-state.ts`, rewired controllers/runtime wiring to consume phase-driven accessors without separate setter mutation in `src/features/app-shell/controllers/message-controller.ts`, `src/features/app-shell/controllers/voice-operations-controller.ts`, and `src/features/app-shell/runtime/create-app-shell-runtime.ts`, and added focused regression coverage in `tests/app-shell-state.test.ts`, `tests/app-shell-message-controller.test.ts`, and `tests/app-shell-voice-controller.test.ts`).
- FE-04: In progress status delta on 2026-02-15 (slice 7 completed: replaced duplicate mutable message-history loading flags in `src/features/app-shell/state/message-state.ts` with typed `messageHistoryLoadTarget` (`refresh`/`load-older`) and derived `isLoadingMessages`/`isLoadingOlder` accessors driven by async operation phase, reducing impossible mixed-loading combinations while preserving fail-closed async transitions; added focused derived-state regression coverage in `tests/app-shell-state.test.ts`).
- FE-04: In progress status delta on 2026-02-15 (slice 8 completed: rewired `src/features/app-shell/controllers/message-history-controller.ts` and runtime wiring in `src/features/app-shell/runtime/create-app-shell-runtime.ts` to drive typed `messageHistoryLoadTarget` instead of mutating independent loading booleans, preserving stale-request guards and fail-closed reset semantics; added focused controller regression coverage in `tests/app-shell-message-history-controller.test.ts`).
- FE-04: In progress status delta on 2026-02-15 (slice 9 completed: hardened `src/features/app-shell/controllers/voice-operations-controller.ts` join precondition handling so duplicate join/leave-in-progress attempts fail closed without resetting an active `voiceJoinState` transition, preserving deterministic async phase semantics for voice join flows; added focused duplicate-join transition regression coverage in `tests/app-shell-voice-controller.test.ts`).
- FE-04: In progress status delta on 2026-02-15 (slice 10 completed: hardened `src/features/app-shell/controllers/message-history-controller.ts` load-older preconditions by adding an explicit `isLoadingMessages` guard and wiring it through `src/features/app-shell/runtime/create-app-shell-runtime.ts`, preventing invalid overlap between refresh and load-older async operations while preserving fail-closed stale-request behavior; added focused overlap-block regression coverage in `tests/app-shell-message-history-controller.test.ts`).
- FE-04: In progress status delta on 2026-02-15 (slices 11–12 completed: strengthened duplicate voice-join anti-regression coverage by recording `voiceJoinState` phase transition history in `tests/app-shell-voice-controller.test.ts` and asserting duplicate join attempts during `running` do not emit `idle`/reset transitions, and added focused runtime/UI regression coverage in `tests/app-shell-voice-controls.test.tsx` to verify repeated `Join Voice` clicks while `voiceJoinState.phase === running` keep the loading affordance stable and do not trigger extra voice-token requests before completion).
- FE-04: In progress status delta on 2026-02-15 (slice 13 completed: introduced shared `isMessageHistoryLoadingForTarget` derivation in `src/features/app-shell/state/message-state.ts`, rewired `src/features/app-shell/controllers/message-history-controller.ts` to use canonical async-state + typed load-target accessors instead of duplicated loading booleans, and updated runtime wiring/tests to preserve fail-closed overlap guards and stale-request behavior).
- FE-04: In progress status delta on 2026-02-15 (slice 14 completed: centralized send-message async transition application in `src/features/app-shell/controllers/message-controller.ts` so `sendMessageState` updates atomically synchronize `messageStatus`/`messageError`, preventing stale success/error UI combinations while preserving fail-closed precondition and send-error handling).
- FE-04: In progress status delta on 2026-02-15 (slice 15 completed: centralized message-history async transition application in `src/features/app-shell/controllers/message-history-controller.ts` so `refreshMessagesState` updates atomically synchronize `messageError`, preventing stale refresh/load-older/reset error UI combinations while preserving fail-closed stale-request and overlap guard behavior).
- FE-04: In progress status delta on 2026-02-15 (slice 16 completed: centralized voice-join async transition application in `src/features/app-shell/controllers/voice-operations-controller.ts` so `voiceJoinState` updates atomically synchronize `voiceStatus`/`voiceError` for join `reset/start/succeed/fail` transitions, including fail-closed stale-status clearing when join preconditions are not met).
- FE-04: In progress status delta on 2026-02-15 (slice 17 completed: added focused microphone-activation-failure join regression coverage in `tests/app-shell-voice-controller.test.ts` to assert join transition remains `succeeded` while `voiceError` is populated, guarding centralized join-transition synchronization against stale/overwritten error behavior).
- FE-04: In progress status delta on 2026-02-15 (slice 18 completed: added focused fail-then-success join regression coverage in `tests/app-shell-voice-controller.test.ts` to assert stale `voiceError` from a failed join is cleared on a subsequent successful join transition, preserving deterministic fail-closed state progression).
- FE-04: In progress status delta on 2026-02-15 (slice 19 completed: hardened `src/features/app-shell/controllers/voice-operations-controller.ts` join preconditions to fail closed when the requested channel already matches the active `voiceSessionChannelKey`, preventing duplicate token issuance and preserving deterministic `voiceJoinState` success semantics; rewired runtime wiring in `src/features/app-shell/runtime/create-app-shell-runtime.ts` and added focused idempotent-join regression coverage in `tests/app-shell-voice-controller.test.ts`).
- FE-04: In progress status delta on 2026-02-15 (slice 20 completed: hardened `src/features/app-shell/controllers/voice-operations-controller.ts` leave teardown to always reset `voiceJoinState` via typed async `reset` transition after session teardown, preventing stale join failure/success phase leakage after leave while preserving explicit leave status messaging; added focused leave-reset regression coverage in `tests/app-shell-voice-controller.test.ts`).
- FE-04: In progress status delta on 2026-02-15 (slice 21 completed: hardened `src/features/app-shell/controllers/message-controller.ts` send precondition ordering to short-circuit duplicate submits while `sendMessageState.phase === running`, preventing invalid no-channel precondition failures from overwriting an active send transition and preserving deterministic fail-closed async state semantics; added focused running-duplicate regression coverage in `tests/app-shell-message-controller.test.ts`).
- FE-04: In progress status delta on 2026-02-15 (slice 22 completed: moved empty-composer/attachment validation ahead of send `start` transition in `src/features/app-shell/controllers/message-controller.ts`, removing transient `running` phase churn for invalid send attempts while preserving fail-closed validation errors; added focused transition-history regression coverage in `tests/app-shell-message-controller.test.ts`).
- FE-04: In progress status delta on 2026-02-15 (slice 23 completed: introduced shared `isMessageHistoryLoading` running-phase helper in `src/features/app-shell/state/message-state.ts` and rewired `isMessageHistoryLoadingForTarget` to consume it, preserving fail-closed interpretation for typed history async operation state).
- FE-04: In progress status delta on 2026-02-15 (slice 24 completed: hardened `loadOlderMessages` overlap preconditions in `src/features/app-shell/controllers/message-history-controller.ts` to fail closed whenever message-history async phase is `running` (including malformed/null target cases), and added focused overlap regression coverage in `tests/app-shell-message-history-controller.test.ts` plus helper coverage in `tests/app-shell-state.test.ts`).
- FE-04: In progress status delta on 2026-02-15 (slice 25 completed: added focused same-channel idempotent-join stale-state regression coverage in `tests/app-shell-voice-controller.test.ts` to assert stale failed `voiceJoinState`/`voiceError` are cleared through deterministic `succeeded` join transition semantics).
- FE-04: Completed on 2026-02-15 (closeout slice completed: validated FE-04 typed async-state objective with focused state/history/join anti-regression coverage and targeted typecheck, confirming fail-closed transition behavior for message send/history refresh/load-older and voice join flows remains deterministic).
- FE-05: In progress status delta on 2026-02-15 (slices 1–3 completed: introduced explicit import-boundary lint rules via `scripts/import-boundary-rules.mjs` and `scripts/check-import-boundaries.mjs` to enforce `domain !-> lib/features` and `lib !-> features` constraints, added focused rule + scanner regression coverage, and wired enforce-mode command `pnpm -C apps/filament-client-web run lint:boundaries` for CI-safe boundary gating).
- FE-05: In progress status delta on 2026-02-15 (slice 4 completed: hardened `scripts/check-import-boundaries.mjs` source-root input handling to fail closed for absolute and out-of-root `--source` values, added focused scanner regression coverage in `tests/check-import-boundaries.test.ts`, and preserved existing allowed/forbidden boundary classification behavior).
- FE-05: In progress status delta on 2026-02-15 (slice 5 completed: added explicit source file scan cap enforcement to `scripts/check-import-boundaries.mjs` with fail-closed behavior (`FILAMENT_IMPORT_BOUNDARY_MAX_SCANNED_FILES` or bounded default), and added focused cap regression coverage in `tests/check-import-boundaries.test.ts`).
- FE-05: In progress status delta on 2026-02-15 (slice 6 completed: wired import-boundary enforcement into `.github/workflows/ci.yml` web job (`npm run lint:boundaries`) so CI fails on layering violations before typecheck/tests/build).
- FE-05: Completed on 2026-02-15 (closeout slice completed: validated FE-05 success metric by enforcing boundary checks in CI and confirming current source layering remains compliant under enforce mode).
- FE-06: In progress status delta on 2026-02-15 (slice 1 completed: introduced bounded, typed client diagnostics event counters in `src/features/app-shell/state/diagnostics-event-counters.ts`, wired counter accessors/reset/increment helpers into `src/features/app-shell/state/diagnostics-state.ts`, and preserved fail-closed non-sensitive diagnostics modeling with focused state/counter regression coverage).
- FE-06: In progress status delta on 2026-02-15 (slice 2 completed: instrumented `src/features/app-shell/runtime/session-diagnostics-controller.ts` to record typed success/failure/logout diagnostics counter events for session refresh, health check, and echo operations; rewired runtime diagnostics action wiring in `src/features/app-shell/runtime/session-diagnostics-actions.ts` and `src/features/app-shell/runtime/create-app-shell-runtime.ts`; preserved fail-closed user-facing error mapping with focused controller/action regression coverage).
- FE-06: In progress status delta on 2026-02-15 (slice 3 completed: threaded diagnostics event counters and explicit dev-only visibility gating through support/utility panel wiring (`src/features/app-shell/runtime/support-panel-host-state-options.ts`, `src/features/app-shell/runtime/support-panel-prop-groups-options.ts`, `src/features/app-shell/runtime/utility-panel-props.ts`, `src/features/app-shell/adapters/panel-host-props.ts`) and rendered counters in `src/features/app-shell/components/panels/UtilityPanel.tsx` only when development mode is enabled; added focused utility/support-panel mapping + render regression coverage).
- FE-06: In progress status delta on 2026-02-15 (slice 4 completed: extended typed diagnostics counter modeling in `src/features/app-shell/state/diagnostics-event-counters.ts` with gateway connectivity events (`gateway_connected`/`gateway_disconnected`) and preserved bounded fail-closed counter saturation behavior through focused diagnostics/state regression coverage).
- FE-06: In progress status delta on 2026-02-15 (slice 5 completed: instrumented gateway connectivity diagnostics in `src/features/app-shell/controllers/gateway-controller.ts` and runtime wiring (`src/features/app-shell/runtime/gateway-controller-registration.ts`, `src/features/app-shell/runtime/create-app-shell-runtime.ts`) to record gateway open/close transitions without introducing payload logging, preserving fail-closed behavior with focused gateway controller regression coverage).
- FE-06: In progress status delta on 2026-02-15 (slice 6 completed: surfaced gateway connectivity diagnostics counters in the dev-only utility panel (`src/features/app-shell/components/panels/UtilityPanel.tsx`) and aligned support/panel-host utility prop mappings, preserving production-hidden diagnostics behavior with focused utility/support-panel regression coverage).
- FE-06: Completed on 2026-02-15 (closeout slice completed: validated FE-06 diagnostics objective by covering both API diagnostics outcomes and gateway connectivity triage counters under dev-only panel visibility with focused targeted regressions).
- FE-07: In progress status delta on 2026-02-15 (slices 1–2 completed: introduced bounded message-list render-window primitives in `src/features/app-shell/components/messages/message-list-window.ts` with strict fail-closed integer/default/hard-cap handling, rewired `src/features/app-shell/components/messages/MessageList.tsx` to render a trailing bounded window via the shared helper while preserving existing scroll/load-older controller behavior, and added focused helper/component/scroll anti-regression coverage).

### Recommended Iteration Order (Frontend)
1. FE-01 Runtime decomposition
2. FE-02 Gateway module split + decoder registry
3. FE-03 API module split
4. FE-04 Typed async state transitions
5. FE-05/FE-06 guardrails + diagnostics
6. FE-07 scalability optimization

### Frontend Target Architecture
- Keep a single top-level composition root, but keep it thin and wiring-only.
- Move behavior/policy/state transition logic into domain composers and focused boundary modules.
- Preserve strict boundary hardening (fail-closed parsing, payload caps, timeout expectations, and hostile-input assumptions).

### Frontend Exit Criteria Addendum
- FE-02 exit criteria:
	- Gateway dispatch uses an explicit decoder registry for versioned `{v,t,d}` events.
	- Event decoder concerns are split into domain-focused modules; `src/lib/gateway.ts` remains transport/wiring focused.
	- Contract tests for unknown event type/version and oversized envelope handling remain green.
- FE-03 exit criteria:
	- API client is split into domain modules (`auth`, `messages`, `workspace`, `friends`, `voice`) behind shared bounded request primitives.
	- Existing API boundary hardening behavior is preserved with focused boundary tests.

### Frontend Anti-Regression Guardrail
- Composition-root rule: no new domain behavior/policy logic is added to `create-app-shell-runtime.ts`; only orchestration/wiring is allowed.

### Frontend Iteration Log
- 2026-02-12: Initial objective assessment captured; no code behavior changed in this pass.
- 2026-02-12: FE-01 slice 1 completed. Extracted overlay/settings panel action orchestration into `src/features/app-shell/runtime/overlay-panel-actions.ts`, wired runtime to use it, and added targeted tests in `tests/app-shell-overlay-panel-actions.test.ts` (3 passing).
- 2026-02-12: FE-01 slice 2 completed. Extracted workspace settings save orchestration into `src/features/app-shell/runtime/workspace-settings-actions.ts`, wired `create-app-shell-runtime.ts` to consume the new helper, and added targeted tests in `tests/app-shell-workspace-settings-actions.test.ts` (3 passing).
- 2026-02-12: FE-01 slice 3 completed. Extracted voice device inventory/preference orchestration from `src/features/app-shell/runtime/create-app-shell-runtime.ts` into `src/features/app-shell/runtime/voice-device-actions.ts`, wired runtime to consume the new helper, and added targeted tests in `tests/app-shell-voice-device-actions.test.ts` (3 passing).
- 2026-02-12: FE-01 slice 4 completed. Extracted gateway workspace permission refresh orchestration from `src/features/app-shell/runtime/create-app-shell-runtime.ts` into `src/features/app-shell/runtime/workspace-permission-actions.ts`, wired runtime to consume the new helper, and added targeted tests in `tests/app-shell-workspace-permission-actions.test.ts` (3 passing).
- 2026-02-12: FE-01 slice 5 completed. Extracted workspace/channel selection panel actions from `src/features/app-shell/runtime/create-app-shell-runtime.ts` into `src/features/app-shell/runtime/workspace-selection-actions.ts`, wired runtime to consume the new helper, and added targeted tests in `tests/app-shell-workspace-selection-actions.test.ts` (3 passing).
- 2026-02-12: FE-01 slice 6 completed. Extracted workspace settings panel prop composition from `src/features/app-shell/runtime/create-app-shell-runtime.ts` into `src/features/app-shell/runtime/workspace-settings-panel-props.ts`, wired runtime to consume the new helper, and added targeted tests in `tests/app-shell-workspace-settings-panel-props.test.ts` (3 passing).
- 2026-02-12: FE-01 slice 7 completed. Extracted runtime side-effect registrations from `src/features/app-shell/runtime/create-app-shell-runtime.ts` into `src/features/app-shell/runtime/runtime-effects.ts`, wired runtime to consume the new helper, and added targeted tests in `tests/app-shell-runtime-effects.test.ts` (4 passing).
- 2026-02-12: FE-01 slice 7 follow-up completed. Aligned `overlay-panel-actions.ts` option typings with Solid setter/accessor contracts, updated `tests/app-shell-overlay-panel-actions.test.ts` to match strict `OverlayPanel` signal typing, and re-ran targeted validation (`pnpm -C apps/filament-client-web run typecheck`, `pnpm -C apps/filament-client-web exec vitest run tests/app-shell-overlay-panel-actions.test.ts tests/app-shell-runtime-effects.test.ts`) with all checks passing.
- 2026-02-12: FE-01 slice 8 completed. Extracted role-management panel prop composition from `src/features/app-shell/runtime/create-app-shell-runtime.ts` into `src/features/app-shell/runtime/role-management-panel-props.ts`, wired runtime to consume the new helper, and added targeted tests in `tests/app-shell-role-management-panel-props.test.ts` (2 passing). Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`, `pnpm -C apps/filament-client-web exec vitest run tests/app-shell-role-management-panel-props.test.ts`).
- 2026-02-12: FE-01 slice 9 completed. Extracted friendships panel prop composition from `src/features/app-shell/runtime/create-app-shell-runtime.ts` into `src/features/app-shell/runtime/friendships-panel-props.ts`, wired runtime to consume the new helper, and added targeted tests in `tests/app-shell-friendships-panel-props.test.ts` (1 passing). Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`, `pnpm -C apps/filament-client-web exec vitest run tests/app-shell-friendships-panel-props.test.ts`).
- 2026-02-12: FE-01 slice 10 completed. Extracted search panel prop composition from `src/features/app-shell/runtime/create-app-shell-runtime.ts` into `src/features/app-shell/runtime/search-panel-props.ts`, wired runtime to consume the new helper, and added targeted tests in `tests/app-shell-search-panel-props.test.ts` (1 passing). Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`, `pnpm -C apps/filament-client-web exec vitest run tests/app-shell-search-panel-props.test.ts`).
- 2026-02-12: FE-01 slice 11 completed. Extracted moderation panel prop composition from `src/features/app-shell/runtime/create-app-shell-runtime.ts` into `src/features/app-shell/runtime/moderation-panel-props.ts`, wired runtime to consume the new helper, and added targeted tests in `tests/app-shell-moderation-panel-props.test.ts` (1 passing). Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`, `pnpm -C apps/filament-client-web exec vitest run tests/app-shell-moderation-panel-props.test.ts`).
- 2026-02-12: FE-01 slice 12 completed. Extracted attachments panel prop composition from `src/features/app-shell/runtime/create-app-shell-runtime.ts` into `src/features/app-shell/runtime/attachments-panel-props.ts`, wired runtime to consume the new helper, and added targeted tests in `tests/app-shell-attachments-panel-props.test.ts` (1 passing). Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`, `pnpm -C apps/filament-client-web exec vitest run tests/app-shell-attachments-panel-props.test.ts`).
- 2026-02-12: FE-01 slice 13 completed. Extracted client settings panel prop composition from `src/features/app-shell/runtime/create-app-shell-runtime.ts` into `src/features/app-shell/runtime/client-settings-panel-props.ts`, wired runtime to consume the new helper, and added targeted tests in `tests/app-shell-client-settings-panel-props.test.ts` (2 passing). Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`, `pnpm -C apps/filament-client-web exec vitest run tests/app-shell-client-settings-panel-props.test.ts`).
- 2026-02-12: FE-01 slice 14 completed. Extracted utility panel prop composition from `src/features/app-shell/runtime/create-app-shell-runtime.ts` into `src/features/app-shell/runtime/utility-panel-props.ts`, wired runtime to consume the new helper, and added targeted tests in `tests/app-shell-utility-panel-props.test.ts` (1 passing). Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`, `pnpm -C apps/filament-client-web exec vitest run tests/app-shell-utility-panel-props.test.ts`).
- 2026-02-12: FE-01 slice 15 completed. Extracted public-directory panel prop composition from `src/features/app-shell/runtime/create-app-shell-runtime.ts` into `src/features/app-shell/runtime/public-directory-panel-props.ts`, wired runtime to consume the new helper, and added targeted tests in `tests/app-shell-public-directory-panel-props.test.ts` (1 passing). Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`, `pnpm -C apps/filament-client-web exec vitest run tests/app-shell-public-directory-panel-props.test.ts`).
- 2026-02-12: FE-01 slice 16 completed. Extracted workspace-create panel prop composition from `src/features/app-shell/runtime/create-app-shell-runtime.ts` into `src/features/app-shell/runtime/workspace-create-panel-props.ts`, wired runtime to consume the new helper, and added targeted tests in `tests/app-shell-workspace-create-panel-props.test.ts` (1 passing). Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`, `pnpm -C apps/filament-client-web exec vitest run tests/app-shell-workspace-create-panel-props.test.ts`).
- 2026-02-12: FE-01 slice 17 completed. Extracted channel-create panel prop composition from `src/features/app-shell/runtime/create-app-shell-runtime.ts` into `src/features/app-shell/runtime/channel-create-panel-props.ts`, wired runtime to consume the new helper, and added targeted tests in `tests/app-shell-channel-create-panel-props.test.ts` (1 passing). Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`, `pnpm -C apps/filament-client-web exec vitest run tests/app-shell-channel-create-panel-props.test.ts`).
- 2026-02-12: FE-01 slice 18 completed. Extracted session diagnostics orchestration wiring from `src/features/app-shell/runtime/create-app-shell-runtime.ts` into `src/features/app-shell/runtime/session-diagnostics-actions.ts`, wired runtime to consume the new helper, and added targeted tests in `tests/app-shell-session-diagnostics-actions.test.ts` (1 passing). Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`, `pnpm -C apps/filament-client-web exec vitest run tests/app-shell-session-diagnostics-actions.test.ts tests/app-shell-session-diagnostics-controller.test.ts`).
- 2026-02-12: FE-01 slice 19 completed. Extracted workspace/channel create panel group composition from `src/features/app-shell/runtime/create-app-shell-runtime.ts` into `src/features/app-shell/runtime/workspace-channel-create-panel-groups.ts`, wired runtime to consume the new helper, and added targeted tests in `tests/app-shell-workspace-channel-create-panel-groups.test.ts` (1 passing). Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`, `pnpm -C apps/filament-client-web exec vitest run tests/app-shell-workspace-channel-create-panel-groups.test.ts`).
- 2026-02-12: FE-01 slice 20 completed. Extracted grouped collaboration panel prop composition (friendships/search/attachments/moderation) from `src/features/app-shell/runtime/create-app-shell-runtime.ts` into `src/features/app-shell/runtime/collaboration-panel-prop-groups.ts`, wired runtime to consume the new helper, and added targeted tests in `tests/app-shell-collaboration-panel-prop-groups.test.ts` (1 passing). Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`, `pnpm -C apps/filament-client-web exec vitest run tests/app-shell-collaboration-panel-prop-groups.test.ts`).
- 2026-02-12: FE-01 slice 21 completed. Extracted grouped support panel prop composition (public directory/settings/workspace settings/role management/utility) from `src/features/app-shell/runtime/create-app-shell-runtime.ts` into `src/features/app-shell/runtime/support-panel-prop-groups.ts`, wired runtime to consume the new helper, and added targeted tests in `tests/app-shell-support-panel-prop-groups.test.ts` (1 passing). Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`, `pnpm -C apps/filament-client-web exec vitest run tests/app-shell-support-panel-prop-groups.test.ts`).
- 2026-02-12: FE-01 slice 22 completed. Extracted gateway-controller registration wiring from `src/features/app-shell/runtime/create-app-shell-runtime.ts` into `src/features/app-shell/runtime/gateway-controller-registration.ts`, wired runtime to consume the new helper, and added targeted tests in `tests/app-shell-gateway-controller-registration.test.ts` (1 passing). Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`, `pnpm -C apps/filament-client-web exec vitest run tests/app-shell-gateway-controller-registration.test.ts`).
- 2026-02-12: FE-01 slice 23 completed. Extracted panel-host prop-group composition from `src/features/app-shell/runtime/create-app-shell-runtime.ts` into `src/features/app-shell/runtime/panel-host-prop-groups.ts`, wired runtime to consume the new helper, and added targeted tests in `tests/app-shell-panel-host-prop-groups.test.ts` (1 passing). Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`, `pnpm -C apps/filament-client-web exec vitest run tests/app-shell-panel-host-prop-groups.test.ts`).
- 2026-02-13: FE-01 slice 24 completed. Extracted workspace/channel-create panel-group state option composition from `src/features/app-shell/runtime/create-app-shell-runtime.ts` into `src/features/app-shell/runtime/workspace-channel-create-panel-groups-options.ts`, wired runtime to consume the new helper, and added targeted tests in `tests/app-shell-workspace-channel-create-panel-groups-options.test.ts` (1 passing). Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`, `pnpm -C apps/filament-client-web exec vitest run tests/app-shell-workspace-channel-create-panel-groups-options.test.ts tests/app-shell-workspace-channel-create-panel-groups.test.ts`).
- 2026-02-13: FE-01 slice 25 completed. Extracted support panel-group state option composition from `src/features/app-shell/runtime/create-app-shell-runtime.ts` into `src/features/app-shell/runtime/support-panel-prop-groups-options.ts`, wired runtime to consume the new helper, and added targeted tests in `tests/app-shell-support-panel-prop-groups-options.test.ts` (1 passing). Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`, `pnpm -C apps/filament-client-web exec vitest run tests/app-shell-support-panel-prop-groups-options.test.ts tests/app-shell-support-panel-prop-groups.test.ts`).
- 2026-02-13: FE-01 slice 26 completed. Extracted collaboration panel-group state option composition from `src/features/app-shell/runtime/create-app-shell-runtime.ts` into `src/features/app-shell/runtime/collaboration-panel-prop-groups-options.ts`, wired runtime to consume the new helper, and added targeted tests in `tests/app-shell-collaboration-panel-prop-groups-options.test.ts` (1 passing). Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`, `pnpm -C apps/filament-client-web exec vitest run tests/app-shell-collaboration-panel-prop-groups-options.test.ts tests/app-shell-collaboration-panel-prop-groups.test.ts`).
- 2026-02-13: FE-01 slice 27 completed. Extracted panel-host grouped state option composition from `src/features/app-shell/runtime/create-app-shell-runtime.ts` into `src/features/app-shell/runtime/panel-host-prop-groups-options.ts`, wired runtime to consume the new helper, and added targeted tests in `tests/app-shell-panel-host-prop-groups-options.test.ts` (1 passing). Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`, `pnpm -C apps/filament-client-web exec vitest run tests/app-shell-panel-host-prop-groups-options.test.ts tests/app-shell-panel-host-prop-groups.test.ts`).
- 2026-02-13: FE-01 slice 28 completed. Extracted workspace/channel-create panel-host state option wiring from `src/features/app-shell/runtime/create-app-shell-runtime.ts` into `src/features/app-shell/runtime/workspace-channel-create-panel-host-state-options.ts`, wired runtime to consume the new helper, and added targeted tests in `tests/app-shell-workspace-channel-create-panel-host-state-options.test.ts` (1 passing). Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`, `pnpm -C apps/filament-client-web exec vitest run tests/app-shell-workspace-channel-create-panel-host-state-options.test.ts tests/app-shell-workspace-channel-create-panel-groups-options.test.ts`).
- 2026-02-13: FE-01 slice 29 completed. Extracted collaboration panel-host state option wiring from `src/features/app-shell/runtime/create-app-shell-runtime.ts` into `src/features/app-shell/runtime/collaboration-panel-host-state-options.ts`, wired runtime to consume the new helper, and added targeted tests in `tests/app-shell-collaboration-panel-host-state-options.test.ts` (1 passing). Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`, `pnpm -C apps/filament-client-web exec vitest run tests/app-shell-collaboration-panel-host-state-options.test.ts tests/app-shell-panel-host-prop-groups-options.test.ts`).
- 2026-02-13: FE-01 slice 30 completed. Extracted support panel-host state option wiring from `src/features/app-shell/runtime/create-app-shell-runtime.ts` into `src/features/app-shell/runtime/support-panel-host-state-options.ts`, wired runtime to consume the new helper, and added targeted tests in `tests/app-shell-support-panel-host-state-options.test.ts` (1 passing). Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`, `pnpm -C apps/filament-client-web exec vitest run tests/app-shell-support-panel-host-state-options.test.ts tests/app-shell-support-panel-prop-groups-options.test.ts`).
- 2026-02-13: FE-01 slice 31 completed. Extracted panel-host prop-group factory wiring from `src/features/app-shell/runtime/create-app-shell-runtime.ts` into `src/features/app-shell/runtime/panel-host-prop-groups-factory.ts`, wired runtime to consume the new helper, and added targeted tests in `tests/app-shell-panel-host-prop-groups-factory.test.ts` (1 passing). Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`, `pnpm -C apps/filament-client-web exec vitest run tests/app-shell-panel-host-prop-groups-factory.test.ts`).
- 2026-02-13: FE-01 slice 32 completed. Extracted workspace/channel operations controller wiring from `src/features/app-shell/runtime/create-app-shell-runtime.ts` into `src/features/app-shell/runtime/workspace-channel-operations-actions.ts`, wired runtime to consume the new helper, and added targeted tests in `tests/app-shell-workspace-channel-operations-actions.test.ts` (1 passing). Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`, `pnpm -C apps/filament-client-web exec vitest run tests/app-shell-workspace-channel-operations-actions.test.ts`).
- 2026-02-13: FE-01 marked complete after verifying `src/features/app-shell/runtime/create-app-shell-runtime.ts` is 645 lines (`wc -l`) and confirming FE-01 success criteria are met.
- 2026-02-13: FE-02 slice 1 completed. Extracted strict gateway envelope parsing from `src/lib/gateway.ts` into `src/lib/gateway-envelope.ts`, rewired gateway dispatch to use `parseGatewayEventEnvelope`, and added focused tests in `tests/gateway-envelope.test.ts` (5 passing). Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`, `pnpm -C apps/filament-client-web exec vitest run tests/gateway-envelope.test.ts tests/gateway.test.ts`).
- 2026-02-13: FE-02 slice 2 completed. Extracted presence-domain decoder registry and payload parsing from `src/lib/gateway.ts` into `src/lib/gateway-presence-events.ts`, rewired gateway dispatch to consume `decodePresenceGatewayEvent` for `presence_sync`/`presence_update`, and added focused tests in `tests/gateway-presence-events.test.ts` (3 passing, including unknown-type fail-closed behavior). Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`, `pnpm -C apps/filament-client-web exec vitest run tests/gateway-presence-events.test.ts tests/gateway.test.ts`).
- 2026-02-13: FE-02 slice 3 completed. Extracted friend-domain decoder registry and payload parsing from `src/lib/gateway.ts` into `src/lib/gateway-friend-events.ts`, rewired gateway dispatch to consume `decodeFriendGatewayEvent` for `friend_request_create`/`friend_request_update`/`friend_request_delete`/`friend_remove`, and added focused tests in `tests/gateway-friend-events.test.ts` (4 passing, including unknown-type and invalid-payload fail-closed behavior). Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`, `pnpm -C apps/filament-client-web exec vitest run tests/gateway-friend-events.test.ts tests/gateway.test.ts`).
- 2026-02-13: FE-02 slice 4 completed. Extracted profile-domain decoder registry and payload parsing from `src/lib/gateway.ts` into `src/lib/gateway-profile-events.ts`, rewired gateway dispatch to consume `decodeProfileGatewayEvent` for `profile_update`/`profile_avatar_update`, and added focused tests in `tests/gateway-profile-events.test.ts` (4 passing, including unknown-type and invalid-payload fail-closed behavior). Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`, `pnpm -C apps/filament-client-web exec vitest run tests/gateway-profile-events.test.ts tests/gateway.test.ts`).
- 2026-02-13: FE-02 slice 5 completed. Extracted message-domain decoder registry and payload parsing from `src/lib/gateway.ts` into `src/lib/gateway-message-events.ts`, rewired gateway dispatch to consume `decodeMessageGatewayEvent` for `message_create`/`message_update`/`message_delete`/`message_reaction`, and added focused tests in `tests/gateway-message-events.test.ts` (5 passing, including unknown-type and invalid-payload fail-closed behavior). Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`, `pnpm -C apps/filament-client-web exec vitest run tests/gateway-message-events.test.ts tests/gateway.test.ts`).
- 2026-02-13: FE-02 slice 6 completed. Extracted workspace-domain decoder registry and payload parsing (`channel_create` + `workspace_*`) from `src/lib/gateway.ts` into `src/lib/gateway-workspace-events.ts`, rewired gateway dispatch to consume `decodeWorkspaceGatewayEvent`, and added focused tests in `tests/gateway-workspace-events.test.ts` (5 passing, including unknown-type and invalid-payload fail-closed behavior plus reorder-cap enforcement). Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`, `pnpm -C apps/filament-client-web exec vitest run tests/gateway-workspace-events.test.ts tests/gateway.test.ts`).
- 2026-02-14: FE-02 slice 7 completed. Extracted voice-domain dispatch routing from `src/lib/gateway.ts` into `src/lib/gateway-voice-dispatch.ts`, rewired gateway message handling to use `dispatchVoiceGatewayEvent`, and added focused tests in `tests/gateway-voice-dispatch.test.ts` (3 passing, including non-voice-type passthrough and invalid-payload fail-closed behavior). Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck && pnpm -C apps/filament-client-web exec vitest run tests/gateway-voice-dispatch.test.ts tests/gateway.test.ts` -> 18/18 tests passing).
- 2026-02-14: FE-02 slice 8 completed. Extracted presence-domain dispatch routing from `src/lib/gateway.ts` into `src/lib/gateway-presence-dispatch.ts`, rewired gateway message handling to use `dispatchPresenceGatewayEvent`, and added focused tests in `tests/gateway-presence-dispatch.test.ts` (3 passing, including non-presence-type passthrough and invalid-payload fail-closed behavior). Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`, `pnpm -C apps/filament-client-web exec vitest run tests/gateway-presence-dispatch.test.ts tests/gateway.test.ts` -> 18/18 tests passing).
- 2026-02-14: FE-02 slice 9 completed. Extracted friend-domain dispatch routing from `src/lib/gateway.ts` into `src/lib/gateway-friend-dispatch.ts`, rewired gateway message handling to use `dispatchFriendGatewayEvent`, and added focused tests in `tests/gateway-friend-dispatch.test.ts` (3 passing, including non-friend-type passthrough and invalid-payload fail-closed behavior). Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`, `pnpm -C apps/filament-client-web exec vitest run tests/gateway-friend-dispatch.test.ts tests/gateway.test.ts` -> 18/18 tests passing).
- 2026-02-14: FE-02 slice 10 completed. Extracted profile-domain dispatch routing from `src/lib/gateway.ts` into `src/lib/gateway-profile-dispatch.ts`, rewired gateway message handling to use `dispatchProfileGatewayEvent`, and added focused tests in `tests/gateway-profile-dispatch.test.ts` (3 passing, including non-profile-type passthrough and invalid-payload fail-closed behavior). Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck && pnpm -C apps/filament-client-web exec vitest run tests/gateway-profile-dispatch.test.ts tests/gateway.test.ts` -> 18/18 tests passing).
- 2026-02-14: FE-02 slice 11 completed. Extracted message-domain dispatch routing from `src/lib/gateway.ts` into `src/lib/gateway-message-dispatch.ts`, rewired gateway message handling to use `dispatchMessageGatewayEvent`, and added focused tests in `tests/gateway-message-dispatch.test.ts` (3 passing, including non-message-type passthrough and invalid-payload fail-closed behavior). Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`, `pnpm -C apps/filament-client-web exec vitest run tests/gateway-message-dispatch.test.ts tests/gateway.test.ts` -> 18/18 tests passing).
- 2026-02-14: FE-02 slice 12 completed. Extracted workspace-domain dispatch routing from `src/lib/gateway.ts` into `src/lib/gateway-workspace-dispatch.ts`, rewired gateway message handling to use `dispatchWorkspaceGatewayEvent`, and added focused tests in `tests/gateway-workspace-dispatch.test.ts` (3 passing, including non-workspace-type passthrough and invalid-payload fail-closed behavior). Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`, `pnpm -C apps/filament-client-web exec vitest run tests/gateway-workspace-dispatch.test.ts tests/gateway.test.ts` -> 18/18 tests passing).
- 2026-02-14: FE-02 slice 13 completed. Extracted ordered cross-domain dispatch orchestration from `src/lib/gateway.ts` into `src/lib/gateway-domain-dispatch.ts`, rewired gateway message handling to use `dispatchGatewayDomainEvent`, and added focused tests in `tests/gateway-domain-dispatch.test.ts` (3 passing, including handled-event dispatch, invalid-known-type fail-closed behavior, and unknown-type passthrough). Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`, `pnpm -C apps/filament-client-web exec vitest run tests/gateway-domain-dispatch.test.ts tests/gateway.test.ts` -> 18/18 tests passing).
- 2026-02-14: FE-02 slice 14 completed. Extracted ready-event parsing/dispatch from `src/lib/gateway.ts` into `src/lib/gateway-ready-dispatch.ts`, rewired gateway message handling to use `dispatchReadyGatewayEvent`, and added focused tests in `tests/gateway-ready-dispatch.test.ts` (3 passing, including valid-ready dispatch, invalid-ready fail-closed behavior, and non-ready passthrough). Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`, `pnpm -C apps/filament-client-web exec vitest run tests/gateway-ready-dispatch.test.ts tests/gateway.test.ts` -> 18/18 tests passing).
- 2026-02-14: FE-02 slice 15 completed. Aligned voice-domain dispatch classification with decoder-registry ownership by exporting `isVoiceGatewayEventType` from `src/lib/gateway-voice-events.ts` and rewiring `src/lib/gateway-voice-dispatch.ts` to consume that guard (removing duplicated static voice type lists while keeping fail-closed handling unchanged), and added focused guard coverage in `tests/gateway-voice-events.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web exec vitest run tests/gateway-voice-events.test.ts tests/gateway-voice-dispatch.test.ts` -> 8/8 tests passing).
- 2026-02-14: FE-02 slice 16 completed. Extracted gateway payload and handler contracts from `src/lib/gateway.ts` into `src/lib/gateway-contracts.ts`, rewired gateway decoder/dispatch modules to import contracts directly, and kept `src/lib/gateway.ts` transport-focused with contract re-exports for compatibility. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`; `pnpm -C apps/filament-client-web exec vitest run tests/gateway.test.ts tests/gateway-message-events.test.ts tests/gateway-workspace-events.test.ts tests/gateway-voice-events.test.ts` -> 30/30 tests passing).
- 2026-02-14: FE-02 slice 17 completed. Extracted workspace role-event decoder registry/parsing from `src/lib/gateway-workspace-events.ts` into `src/lib/gateway-workspace-role-events.ts`, rewired `decodeWorkspaceGatewayEvent` to delegate role event decoding first and keep non-role workspace decoder logic isolated, and added focused tests in `tests/gateway-workspace-role-events.test.ts` (4 passing, including unknown-type and fail-closed cases). Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`; `pnpm -C apps/filament-client-web exec vitest run tests/gateway-workspace-role-events.test.ts tests/gateway-workspace-events.test.ts tests/gateway-workspace-dispatch.test.ts tests/gateway.test.ts` -> 27/27 tests passing).
- 2026-02-14: FE-02 slice 18 completed. Extracted workspace member-event decoder registry/parsing from `src/lib/gateway-workspace-events.ts` into `src/lib/gateway-workspace-member-events.ts`, rewired `decodeWorkspaceGatewayEvent` to delegate member event decoding after role event decoding while preserving fail-closed behavior for malformed payloads and unknown types, and added focused tests in `tests/gateway-workspace-member-events.test.ts` (4 passing, including unknown-type and invalid-payload cases). Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`; `pnpm -C apps/filament-client-web exec vitest run tests/gateway-workspace-member-events.test.ts tests/gateway-workspace-events.test.ts tests/gateway-workspace-dispatch.test.ts tests/gateway.test.ts` -> 27/27 tests passing).
- 2026-02-14: FE-02 slice 19 completed. Aligned workspace-domain dispatch classification with decoder-registry ownership by exporting `isWorkspaceMemberGatewayEventType` from `src/lib/gateway-workspace-member-events.ts`, adding a unified `isWorkspaceGatewayEventType` guard in `src/lib/gateway-workspace-events.ts`, and rewiring `src/lib/gateway-workspace-dispatch.ts` to consume that guard (removing duplicated workspace event-type lists while keeping fail-closed behavior unchanged); added focused guard coverage in `tests/gateway-workspace-events.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`; `pnpm -C apps/filament-client-web exec vitest run tests/gateway-workspace-events.test.ts tests/gateway-workspace-dispatch.test.ts` -> 9/9 tests passing).
- 2026-02-14: FE-02 slice 20 completed. Extracted workspace IP-ban event decoder/parsing from `src/lib/gateway-workspace-events.ts` into `src/lib/gateway-workspace-ip-ban-events.ts`, rewired `decodeWorkspaceGatewayEvent` and `isWorkspaceGatewayEventType` to delegate IP-ban event handling to the dedicated decoder module while preserving fail-closed behavior, and added focused tests in `tests/gateway-workspace-ip-ban-events.test.ts` (4 passing, including guard and invalid-payload coverage). Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`; `pnpm -C apps/filament-client-web exec vitest run tests/gateway-workspace-ip-ban-events.test.ts tests/gateway-workspace-events.test.ts tests/gateway-workspace-dispatch.test.ts` -> 13/13 tests passing).
- 2026-02-14: FE-02 slice 21 completed. Extracted workspace channel-override event decoder/parsing from `src/lib/gateway-workspace-events.ts` into `src/lib/gateway-workspace-channel-override-events.ts`, rewired `decodeWorkspaceGatewayEvent` and `isWorkspaceGatewayEventType` to delegate channel-override event handling to the dedicated decoder module while preserving fail-closed behavior, and added focused tests in `tests/gateway-workspace-channel-override-events.test.ts` (4 passing, including guard and invalid-payload coverage). Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`; `pnpm -C apps/filament-client-web exec vitest run tests/gateway-workspace-channel-override-events.test.ts tests/gateway-workspace-events.test.ts tests/gateway-workspace-dispatch.test.ts` -> 13/13 tests passing).
- 2026-02-14: FE-02 slice 22 completed. Extracted workspace update-event decoder/parsing from `src/lib/gateway-workspace-events.ts` into `src/lib/gateway-workspace-update-events.ts`, rewired `decodeWorkspaceGatewayEvent` and `isWorkspaceGatewayEventType` to delegate workspace-update event handling to the dedicated decoder module while preserving fail-closed behavior, and added focused tests in `tests/gateway-workspace-update-events.test.ts` (4 passing, including guard and no-delta fail-closed coverage). Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`; `pnpm -C apps/filament-client-web exec vitest run tests/gateway-workspace-update-events.test.ts tests/gateway-workspace-events.test.ts tests/gateway-workspace-dispatch.test.ts` -> 13/13 tests passing).
- 2026-02-14: FE-02 slice 23 completed. Extracted workspace channel-create decoder/parsing from `src/lib/gateway-workspace-events.ts` into `src/lib/gateway-workspace-channel-events.ts`, rewired `decodeWorkspaceGatewayEvent` and `isWorkspaceGatewayEventType` to delegate channel-create event handling to the dedicated decoder module while preserving fail-closed behavior, and added focused tests in `tests/gateway-workspace-channel-events.test.ts` (4 passing, including guard and invalid-payload fail-closed coverage). Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck && pnpm -C apps/filament-client-web exec vitest run tests/gateway-workspace-channel-events.test.ts tests/gateway-workspace-events.test.ts tests/gateway-workspace-dispatch.test.ts` -> 13/13 tests passing).
- 2026-02-14: FE-02 slice 24 completed. Replaced ad hoc workspace aggregate branching in `src/lib/gateway-workspace-events.ts` with explicit type-guard and decoder registries (preserving strict fail-closed behavior and decode precedence), and added focused regression coverage in `tests/gateway-workspace-events.test.ts` for delegated `workspace_update` decode handling. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`; `pnpm -C apps/filament-client-web exec vitest run tests/gateway-workspace-events.test.ts tests/gateway-workspace-dispatch.test.ts` -> 10/10 tests passing).
- 2026-02-14: FE-02 slice 25 completed. Extracted voice stream event decoder registry/parsing from `src/lib/gateway-voice-events.ts` into `src/lib/gateway-voice-stream-events.ts`, rewired `decodeVoiceGatewayEvent` and `isVoiceGatewayEventType` to delegate stream-event handling to the dedicated module while preserving strict fail-closed behavior, and added focused tests in `tests/gateway-voice-stream-events.test.ts` (4 passing). Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck && pnpm -C apps/filament-client-web exec vitest run tests/gateway-voice-stream-events.test.ts tests/gateway-voice-events.test.ts tests/gateway-voice-dispatch.test.ts` -> 12/12 tests passing).
- 2026-02-14: FE-02 slice 26 completed. Extracted voice participant event decoder registry/parsing from `src/lib/gateway-voice-events.ts` into `src/lib/gateway-voice-participant-events.ts`, rewired `decodeVoiceGatewayEvent` and `isVoiceGatewayEventType` to delegate participant-event handling to the dedicated module while preserving strict fail-closed behavior, and added focused tests in `tests/gateway-voice-participant-events.test.ts` (4 passing). Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`; `pnpm -C apps/filament-client-web exec vitest run tests/gateway-voice-participant-events.test.ts tests/gateway-voice-events.test.ts tests/gateway-voice-stream-events.test.ts tests/gateway-voice-dispatch.test.ts` -> 15/15 tests passing).
- 2026-02-14: FE-02 slice 27 completed. Replaced ad hoc voice aggregate branching in `src/lib/gateway-voice-events.ts` with explicit type-guard and decoder registries (preserving strict fail-closed behavior and decode precedence), and added focused regression coverage in `tests/gateway-voice-events.test.ts` for invalid `voice_participant_leave` payload fail-closed handling. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`; `pnpm -C apps/filament-client-web exec vitest run tests/gateway-voice-events.test.ts tests/gateway-voice-dispatch.test.ts tests/gateway-voice-participant-events.test.ts tests/gateway-voice-stream-events.test.ts` -> 16/16 tests passing).
- 2026-02-14: FE-02 slice 28 completed. Extracted workspace role-assignment event decoder registry/parsing from `src/lib/gateway-workspace-role-events.ts` into `src/lib/gateway-workspace-role-assignment-events.ts`, rewired `decodeWorkspaceRoleGatewayEvent` and `isWorkspaceRoleGatewayEventType` to delegate assignment-event handling to the dedicated module while preserving strict fail-closed behavior, and added focused tests in `tests/gateway-workspace-role-assignment-events.test.ts` plus aggregate delegation coverage in `tests/gateway-workspace-role-events.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`; `pnpm -C apps/filament-client-web exec vitest run tests/gateway-workspace-role-assignment-events.test.ts tests/gateway-workspace-role-events.test.ts tests/gateway-workspace-events.test.ts tests/gateway-workspace-dispatch.test.ts` -> 19/19 tests passing).
- 2026-02-14: FE-02 slice 29 completed. Extracted workspace role-reorder event decoder registry/parsing from `src/lib/gateway-workspace-role-events.ts` into `src/lib/gateway-workspace-role-reorder-events.ts`, rewired `decodeWorkspaceRoleGatewayEvent` and `isWorkspaceRoleGatewayEventType` to delegate reorder-event handling to the dedicated module while preserving strict fail-closed behavior, and added focused tests in `tests/gateway-workspace-role-reorder-events.test.ts` plus aggregate delegation coverage in `tests/gateway-workspace-role-events.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`; `pnpm -C apps/filament-client-web exec vitest run tests/gateway-workspace-role-reorder-events.test.ts tests/gateway-workspace-role-events.test.ts tests/gateway-workspace-events.test.ts tests/gateway-workspace-dispatch.test.ts` -> 20/20 tests passing).
- 2026-02-14: FE-02 slice 30 completed. Extracted workspace role-create event decoder/parsing from `src/lib/gateway-workspace-role-events.ts` into `src/lib/gateway-workspace-role-create-events.ts`, rewired `decodeWorkspaceRoleGatewayEvent` and `isWorkspaceRoleGatewayEventType` to delegate create-event handling to the dedicated module while preserving strict fail-closed behavior, and added focused tests in `tests/gateway-workspace-role-create-events.test.ts` plus aggregate delegation coverage in `tests/gateway-workspace-role-events.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`; `pnpm -C apps/filament-client-web exec vitest run tests/gateway-workspace-role-create-events.test.ts tests/gateway-workspace-role-events.test.ts tests/gateway-workspace-events.test.ts tests/gateway-workspace-dispatch.test.ts` -> 20/20 tests passing).
- 2026-02-14: FE-02 slice 31 completed. Extracted workspace role-delete event decoder/parsing from `src/lib/gateway-workspace-role-events.ts` into `src/lib/gateway-workspace-role-delete-events.ts`, rewired `decodeWorkspaceRoleGatewayEvent` and `isWorkspaceRoleGatewayEventType` to delegate delete-event handling to the dedicated module while preserving strict fail-closed behavior, and added focused tests in `tests/gateway-workspace-role-delete-events.test.ts` plus aggregate delegation coverage in `tests/gateway-workspace-role-events.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`; `pnpm -C apps/filament-client-web exec vitest run tests/gateway-workspace-role-delete-events.test.ts tests/gateway-workspace-role-events.test.ts tests/gateway-workspace-events.test.ts tests/gateway-workspace-dispatch.test.ts` -> 21/21 tests passing).
- 2026-02-14: FE-02 slice 32 completed. Extracted workspace role-update event decoder/parsing from `src/lib/gateway-workspace-role-events.ts` into `src/lib/gateway-workspace-role-update-events.ts`, rewired `decodeWorkspaceRoleGatewayEvent` and `isWorkspaceRoleGatewayEventType` to delegate update-event handling to the dedicated module while preserving strict fail-closed behavior, and added focused tests in `tests/gateway-workspace-role-update-events.test.ts` plus aggregate delegation coverage in `tests/gateway-workspace-role-events.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`; `pnpm -C apps/filament-client-web exec vitest run tests/gateway-workspace-role-update-events.test.ts tests/gateway-workspace-role-events.test.ts tests/gateway-workspace-events.test.ts tests/gateway-workspace-dispatch.test.ts` -> 22/22 tests passing).
- 2026-02-14: FE-02 slice 33 completed. Extracted workspace role-assignment-add event decoder/parsing from `src/lib/gateway-workspace-role-assignment-events.ts` into `src/lib/gateway-workspace-role-assignment-add-events.ts`, rewired `decodeWorkspaceRoleAssignmentGatewayEvent` and `isWorkspaceRoleAssignmentGatewayEventType` to delegate add-event handling to the dedicated module while preserving strict fail-closed behavior, and added focused tests in `tests/gateway-workspace-role-assignment-add-events.test.ts` plus aggregate delegation coverage in `tests/gateway-workspace-role-assignment-events.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`; `pnpm -C apps/filament-client-web exec vitest run tests/gateway-workspace-role-assignment-add-events.test.ts tests/gateway-workspace-role-assignment-events.test.ts tests/gateway-workspace-role-events.test.ts tests/gateway-workspace-events.test.ts tests/gateway-workspace-dispatch.test.ts` -> 26/26 tests passing).
- 2026-02-14: FE-02 slice 34 completed. Extracted workspace role-assignment-remove event decoder/parsing from `src/lib/gateway-workspace-role-assignment-events.ts` into `src/lib/gateway-workspace-role-assignment-remove-events.ts`, rewired `decodeWorkspaceRoleAssignmentGatewayEvent` and `isWorkspaceRoleAssignmentGatewayEventType` to delegate remove-event handling to the dedicated module while preserving strict fail-closed behavior, and added focused tests in `tests/gateway-workspace-role-assignment-remove-events.test.ts` plus aggregate delegation coverage in `tests/gateway-workspace-role-assignment-events.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`; `pnpm -C apps/filament-client-web exec vitest run tests/gateway-workspace-role-assignment-remove-events.test.ts tests/gateway-workspace-role-assignment-events.test.ts tests/gateway-workspace-role-events.test.ts tests/gateway-workspace-events.test.ts tests/gateway-workspace-dispatch.test.ts` -> 27/27 tests passing).
- 2026-02-14: FE-02 slice 35 completed. Replaced ad hoc workspace role aggregate branching in `src/lib/gateway-workspace-role-events.ts` with explicit type-guard and decoder registries (preserving strict fail-closed behavior and decode precedence), kept role-assignment variants delegated through dedicated add/remove decoders for precise payload typing, and added focused classification regression coverage in `tests/gateway-workspace-role-events.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`; `pnpm -C apps/filament-client-web exec vitest run tests/gateway-workspace-role-events.test.ts tests/gateway-workspace-events.test.ts tests/gateway-workspace-dispatch.test.ts` -> 19/19 tests passing).
- 2026-02-14: FE-02 slice 36 completed. Rewired workspace role aggregate assignment decoding in `src/lib/gateway-workspace-role-events.ts` to delegate assignment variant payload parsing through `decodeWorkspaceRoleAssignmentGatewayEvent` from `src/lib/gateway-workspace-role-assignment-events.ts` (removing direct aggregate coupling to add/remove decoder modules) while preserving strict fail-closed behavior, and added focused invalid assignment regression coverage in `tests/gateway-workspace-role-events.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck && pnpm -C apps/filament-client-web exec vitest run tests/gateway-workspace-role-events.test.ts tests/gateway-workspace-role-assignment-events.test.ts tests/gateway-workspace-events.test.ts tests/gateway-workspace-dispatch.test.ts` -> 25/25 tests passing).
- 2026-02-14: FE-02 slice 37 completed. Replaced ad hoc aggregate role-assignment payload-decoder mapping in `src/lib/gateway-workspace-role-assignment-events.ts` with explicit type-guard and decoder registries that delegate directly to add/remove role-assignment decoders, preserving strict fail-closed behavior, and added focused invalid assignment-add regression coverage in `tests/gateway-workspace-role-assignment-events.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck && pnpm -C apps/filament-client-web exec vitest run tests/gateway-workspace-role-assignment-events.test.ts tests/gateway-workspace-role-events.test.ts tests/gateway-workspace-events.test.ts tests/gateway-workspace-dispatch.test.ts` -> 26/26 tests passing).
- 2026-02-14: FE-02 slice 38 completed. Extracted role-assignment variant payload delegation from `src/lib/gateway-workspace-role-events.ts` into `src/lib/gateway-workspace-role-assignment-payload-events.ts`, rewired aggregate role event decoding to consume `decodeWorkspaceRoleAssignmentGatewayEventPayload`, and added focused tests in `tests/gateway-workspace-role-assignment-payload-events.test.ts` while preserving strict fail-closed behavior. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck && pnpm -C apps/filament-client-web exec vitest run tests/gateway-workspace-role-assignment-payload-events.test.ts tests/gateway-workspace-role-events.test.ts tests/gateway-workspace-role-assignment-events.test.ts tests/gateway-workspace-events.test.ts tests/gateway-workspace-dispatch.test.ts` -> 28/28 tests passing).
- 2026-02-14: FE-02 slice 39 completed. Extracted `workspace_member_update` decoder/parsing from `src/lib/gateway-workspace-member-events.ts` into `src/lib/gateway-workspace-member-update-events.ts`, rewired aggregate member decoding/classification to delegate update-event handling to the dedicated module while preserving strict fail-closed behavior, and added focused tests in `tests/gateway-workspace-member-update-events.test.ts` plus aggregate delegation/guard regression coverage in `tests/gateway-workspace-member-events.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck && pnpm -C apps/filament-client-web exec vitest run tests/gateway-workspace-member-update-events.test.ts tests/gateway-workspace-member-events.test.ts tests/gateway-workspace-events.test.ts tests/gateway-workspace-dispatch.test.ts` -> 20/20 tests passing).
- 2026-02-14: FE-02 slice 40 completed. Extracted `workspace_member_add` decoder/parsing from `src/lib/gateway-workspace-member-events.ts` into `src/lib/gateway-workspace-member-add-events.ts`, rewired aggregate member decoding/classification to delegate add-event handling to the dedicated module while preserving strict fail-closed behavior, and added focused tests in `tests/gateway-workspace-member-add-events.test.ts` plus aggregate delegation regression coverage in `tests/gateway-workspace-member-events.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck && pnpm -C apps/filament-client-web exec vitest run tests/gateway-workspace-member-add-events.test.ts tests/gateway-workspace-member-events.test.ts tests/gateway-workspace-events.test.ts tests/gateway-workspace-dispatch.test.ts` -> 21/21 tests passing).
- 2026-02-14: FE-02 slice 41 completed. Extracted `workspace_member_remove` decoder/parsing from `src/lib/gateway-workspace-member-events.ts` into `src/lib/gateway-workspace-member-remove-events.ts`, rewired aggregate member decoding/classification to delegate remove-event handling to the dedicated module while preserving strict fail-closed behavior, and added focused tests in `tests/gateway-workspace-member-remove-events.test.ts` plus aggregate delegation regression coverage in `tests/gateway-workspace-member-events.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck && pnpm -C apps/filament-client-web exec vitest run tests/gateway-workspace-member-remove-events.test.ts tests/gateway-workspace-member-events.test.ts tests/gateway-workspace-events.test.ts tests/gateway-workspace-dispatch.test.ts` -> 22/22 tests passing).
- 2026-02-14: FE-02 slice 42 completed. Extracted `workspace_member_ban` decoder/parsing from `src/lib/gateway-workspace-member-events.ts` into `src/lib/gateway-workspace-member-ban-events.ts`, rewired aggregate member decoding/classification to delegate ban-event handling to the dedicated module while preserving strict fail-closed behavior, and added focused tests in `tests/gateway-workspace-member-ban-events.test.ts` plus aggregate delegation regression coverage in `tests/gateway-workspace-member-events.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`; `pnpm -C apps/filament-client-web exec vitest run tests/gateway-workspace-member-ban-events.test.ts tests/gateway-workspace-member-events.test.ts tests/gateway-workspace-events.test.ts tests/gateway-workspace-dispatch.test.ts` -> 24/24 tests passing).
- 2026-02-14: FE-02 slice 43 completed. Hardened aggregate workspace-member event classification in `src/lib/gateway-workspace-member-events.ts` by replacing prototype-chain `in` checks with own-property validation, preserving strict fail-closed behavior for hostile event types (including `__proto__`), and added focused regression coverage in `tests/gateway-workspace-member-events.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck && pnpm -C apps/filament-client-web exec vitest run tests/gateway-workspace-member-events.test.ts tests/gateway-workspace-events.test.ts tests/gateway-workspace-dispatch.test.ts` -> 21/21 tests passing).
- 2026-02-14: FE-02 slice 44 completed. Hardened presence event classification in `src/lib/gateway-presence-events.ts` by replacing prototype-chain `in` checks with own-property validation, preserving strict fail-closed behavior for hostile event types (including `__proto__`), and added focused regression coverage in `tests/gateway-presence-events.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck && pnpm -C apps/filament-client-web exec vitest run tests/gateway-presence-events.test.ts tests/gateway.test.ts` -> 19/19 tests passing).
- 2026-02-14: FE-02 slice 45 completed. Hardened voice participant/stream event classification in `src/lib/gateway-voice-participant-events.ts` and `src/lib/gateway-voice-stream-events.ts` by replacing prototype-chain `in` checks with own-property validation, preserving strict fail-closed behavior for hostile event types (including `__proto__`), and added focused regression coverage in `tests/gateway-voice-participant-events.test.ts`, `tests/gateway-voice-stream-events.test.ts`, and `tests/gateway-voice-events.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck && pnpm -C apps/filament-client-web exec vitest run tests/gateway-voice-participant-events.test.ts tests/gateway-voice-stream-events.test.ts tests/gateway-voice-events.test.ts tests/gateway-voice-dispatch.test.ts` -> 19/19 tests passing).
- 2026-02-14: FE-02 slice 46 completed. Hardened friend event classification in `src/lib/gateway-friend-events.ts` by replacing prototype-chain `in` checks with own-property validation, preserving strict fail-closed behavior for hostile event types (including `__proto__`), and added focused regression coverage in `tests/gateway-friend-events.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web exec vitest run tests/gateway-friend-events.test.ts` -> 5/5 tests passing).
- 2026-02-14: FE-02 slice 47 completed. Hardened profile event classification in `src/lib/gateway-profile-events.ts` by replacing prototype-chain `in` checks with own-property validation, preserving strict fail-closed behavior for hostile event types (including `__proto__`), and added focused regression coverage in `tests/gateway-profile-events.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web exec vitest run tests/gateway-profile-events.test.ts` -> 5/5 tests passing; `pnpm -C apps/filament-client-web run typecheck` -> passed).
- 2026-02-14: FE-02 slice 48 completed. Hardened message event classification in `src/lib/gateway-message-events.ts` by replacing prototype-chain `in` checks with own-property validation, preserving strict fail-closed behavior for hostile event types (including `__proto__`), and added focused regression coverage in `tests/gateway-message-events.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web exec vitest run tests/gateway-message-events.test.ts tests/gateway.test.ts` -> 21/21 tests passing).
- 2026-02-14: FE-02 slice 49 completed. Hardened aggregate workspace role event classification in `src/lib/gateway-workspace-role-events.ts` by replacing prototype-chain `in` checks with own-property validation, preserving strict fail-closed behavior for hostile event types (including `__proto__`), and added focused regression coverage in `tests/gateway-workspace-role-events.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck && pnpm -C apps/filament-client-web exec vitest run tests/gateway-workspace-role-events.test.ts` -> 11/11 tests passing).
- 2026-02-14: FE-02 slice 50 completed. Replaced ad hoc array-based workspace role-assignment aggregate classification/decoding in `src/lib/gateway-workspace-role-assignment-events.ts` with explicit typed type-guard and payload decoder registries plus own-property gating, preserving strict fail-closed behavior for hostile event types (including `__proto__`), and added focused regression coverage in `tests/gateway-workspace-role-assignment-events.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck`; `pnpm -C apps/filament-client-web exec vitest run tests/gateway-workspace-role-assignment-events.test.ts tests/gateway-workspace-role-events.test.ts` -> 18/18 tests passing).
- 2026-02-14: FE-02 slice 51 completed. Hardened `src/lib/gateway-envelope.ts` to fail closed unless parsed envelopes include own-property `{ v, t, d }` fields, preserving strict protocol shape checks for malformed/partial payloads, and added focused regression coverage in `tests/gateway-envelope.test.ts` for missing-`d` rejection. Targeted validation passed (`pnpm -C apps/filament-client-web exec vitest run tests/gateway-envelope.test.ts tests/gateway.test.ts` -> 21/21 tests passing).
- 2026-02-14: FE-02 slice 52 completed. Replaced ad hoc array-based workspace aggregate classification/decoding in `src/lib/gateway-workspace-events.ts` with explicit typed domain registries plus own-property-gated registry iteration, preserving strict fail-closed behavior and decode precedence, and added focused regression coverage in `tests/gateway-workspace-events.test.ts` for hostile `__proto__` event type classification. Targeted validation passed (`pnpm -C apps/filament-client-web exec vitest run tests/gateway-workspace-events.test.ts tests/gateway-workspace-dispatch.test.ts` -> 11/11 tests passing).
- 2026-02-14: FE-02 closeout slice completed. Marked FE-02 complete after confirming exit criteria remain green via targeted validation (`pnpm -C apps/filament-client-web exec vitest run tests/gateway.test.ts tests/gateway-envelope.test.ts` -> 21/21 tests passing; `wc -l apps/filament-client-web/src/lib/gateway.ts | cat` -> 151 lines).
- 2026-02-14: FE-03 slice 1 completed. Extracted auth endpoint wiring into `src/lib/api-auth.ts` and rewired `src/lib/api.ts` to delegate `registerWithPassword`/`loginWithPassword`/`refreshAuthSession`/`logoutAuthSession` through the dedicated module while preserving bounded request primitives and fail-closed response-shape checks. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck` -> passed; `pnpm -C apps/filament-client-web exec vitest run tests/api-auth.test.ts tests/api-boundary.test.ts` -> 16/16 tests passing).
- 2026-02-14: FE-03 slice 2 completed. Extracted friends endpoint wiring into `src/lib/api-friends.ts` and rewired `src/lib/api.ts` to delegate `fetchFriends`/`fetchFriendRequests`/`createFriendRequest`/`acceptFriendRequest`/`deleteFriendRequest`/`removeFriend` through the dedicated module while preserving bounded request primitives and fail-closed `acceptFriendRequest` response-shape checks. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck && pnpm -C apps/filament-client-web exec vitest run tests/api-friends.test.ts tests/api-boundary.test.ts` -> 16/16 tests passing).
- 2026-02-15: FE-03 slice 3 completed. Extracted voice endpoint wiring into `src/lib/api-voice.ts` and rewired `src/lib/api.ts` to delegate `issueVoiceToken` through the dedicated module while preserving bounded request primitives and strict fail-closed voice token DTO parsing. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck` -> passed; `pnpm -C apps/filament-client-web exec vitest run tests/api-voice.test.ts` -> 2/2 tests passing).
- 2026-02-15: FE-03 slice 4 completed. Extracted message endpoint wiring into `src/lib/api-messages.ts` and rewired `src/lib/api.ts` to delegate `fetchChannelMessages`/`createChannelMessage`/`editChannelMessage`/`deleteChannelMessage`/`addMessageReaction`/`removeMessageReaction` through the dedicated module while preserving bounded message-history query constraints, strict fail-closed message/reaction DTO parsing, and `protocol_mismatch` fallback handling for attachment-backed message create. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck` -> passed; `pnpm -C apps/filament-client-web exec vitest run tests/api-messages.test.ts tests/api-boundary.test.ts` -> 16/16 tests passing).
- 2026-02-15: FE-03 slice 5 completed. Extracted workspace role endpoint wiring into `src/lib/api-workspace.ts` and rewired `src/lib/api.ts` to delegate `fetchGuildRoles`/`createGuildRole`/`updateGuildRole`/`deleteGuildRole`/`reorderGuildRoles`/`assignGuildRole`/`unassignGuildRole` through the dedicated module while preserving fail-closed role-update/reorder validation and strict role/moderation DTO parsing. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck` -> passed; `pnpm -C apps/filament-client-web exec vitest run tests/api-workspace.test.ts tests/api-boundary.test.ts` -> 16/16 tests passing).
- 2026-02-15: FE-03 slice 6 completed. Extracted workspace guild core endpoint wiring into `src/lib/api-workspace.ts` and rewired `src/lib/api.ts` to delegate `createGuild`/`fetchGuilds`/`updateGuild` through the dedicated module while preserving strict fail-closed guild-list shape validation and strict guild DTO parsing. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck` -> passed; `pnpm -C apps/filament-client-web exec vitest run tests/api-workspace.test.ts tests/api-boundary.test.ts` -> 19/19 tests passing).
- 2026-02-15: FE-03 slice 7 completed. Extracted public workspace directory endpoint wiring into `src/lib/api-workspace.ts` and rewired `src/lib/api.ts` to delegate `fetchPublicGuildDirectory`/`joinPublicGuild` through the dedicated module while preserving bounded query/limit constraints and strict fail-closed directory/join DTO parsing. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck` -> passed; `pnpm -C apps/filament-client-web exec vitest run tests/api-workspace.test.ts tests/api-boundary.test.ts` -> 21/21 tests passing).
- 2026-02-15: FE-03 slice 8 completed. Extracted workspace channel endpoint wiring into `src/lib/api-workspace.ts` and rewired `src/lib/api.ts` to delegate `fetchGuildChannels`/`createChannel`/`fetchChannelPermissionSnapshot` through the dedicated module while preserving strict fail-closed channel-list shape validation and strict channel/permission DTO parsing. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck` -> passed; `pnpm -C apps/filament-client-web exec vitest run tests/api-workspace.test.ts tests/api-boundary.test.ts` -> 24/24 tests passing).
- 2026-02-15: FE-03 slice 9 completed. Extracted workspace moderation endpoint wiring into `src/lib/api-workspace.ts` and rewired `src/lib/api.ts` to delegate `addGuildMember`/`updateGuildMemberRole`/`kickGuildMember`/`banGuildMember`/`setChannelRoleOverride` through the dedicated module while preserving strict fail-closed moderation DTO parsing and override payload forwarding behavior. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck` -> passed; `pnpm -C apps/filament-client-web exec vitest run tests/api-workspace.test.ts tests/api-boundary.test.ts` -> 26/26 tests passing).
- 2026-02-15: FE-03 slice 10 completed. Extracted search endpoint wiring into `src/lib/api-messages.ts` and rewired `src/lib/api.ts` to delegate `searchGuildMessages`/`rebuildGuildSearchIndex`/`reconcileGuildSearchIndex` through the dedicated module while preserving bounded search query constraints and strict fail-closed search/search-reconcile DTO parsing. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck` -> passed; `pnpm -C apps/filament-client-web exec vitest run tests/api-messages.test.ts tests/api-boundary.test.ts` -> 19/19 tests passing).
- 2026-02-15: FE-03 slice 11 completed. Extracted channel attachment endpoint wiring into `src/lib/api-messages.ts` and rewired `src/lib/api.ts` to delegate `uploadChannelAttachment`/`downloadChannelAttachment`/`downloadChannelAttachmentPreview`/`deleteChannelAttachment` through the dedicated module while preserving strict fail-closed attachment DTO parsing and existing upload/download guardrails (upload size cap, preview timeout, preview max-bytes). Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck` -> passed; `pnpm -C apps/filament-client-web exec vitest run tests/api-messages.test.ts tests/api-boundary.test.ts` -> 21/21 tests passing).
- 2026-02-15: FE-03 slice 12 completed. Extracted authenticated profile self-read endpoint wiring (`fetchMe`) into `src/lib/api-auth.ts` and rewired `src/lib/api.ts` to delegate `fetchMe` through the dedicated auth module while preserving strict fail-closed `/auth/me` response-shape validation and domain parsing. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck && pnpm -C apps/filament-client-web exec vitest run tests/api-auth.test.ts` -> 6/6 tests passing).
- 2026-02-15: FE-03 slice 13 completed. Extracted authenticated profile/user lookup endpoint wiring (`fetchUserProfile`/`updateMyProfile`/`lookupUsersByIds`) into `src/lib/api-auth.ts` and rewired `src/lib/api.ts` to delegate those endpoints through the dedicated auth module while preserving strict fail-closed profile DTO parsing and the existing 1–64 user lookup bound check. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck` -> passed; `pnpm -C apps/filament-client-web exec vitest run tests/api-auth.test.ts` -> 9/9 tests passing).
- 2026-02-15: FE-03 slice 14 completed. Extracted authenticated profile avatar upload endpoint wiring (`uploadMyProfileAvatar`) into `src/lib/api-auth.ts` and rewired `src/lib/api.ts` to delegate avatar uploads through the dedicated auth module while preserving existing avatar upload guardrails (size cap and bounded content-type header forwarding) and strict fail-closed profile DTO parsing. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck` -> passed; `pnpm -C apps/filament-client-web exec vitest run tests/api-auth.test.ts` -> 11/11 tests passing).
- 2026-02-15: FE-03 slice 15 completed. Extracted system endpoint wiring (`fetchHealth`/`echoMessage`) into `src/lib/api-system.ts` and rewired `src/lib/api.ts` to delegate those endpoints through the dedicated system module while preserving strict fail-closed response-shape validation and existing API boundary hardening behavior. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck` -> passed; `pnpm -C apps/filament-client-web exec vitest run tests/api-system.test.ts tests/api-boundary.test.ts` -> 16/16 tests passing).
- 2026-02-15: FE-03 slice 16 completed. Extracted auth-profile avatar URL construction (`profileAvatarUrl`) into `src/lib/api-auth.ts` and rewired `src/lib/api.ts` to delegate avatar URL generation through the dedicated auth module while preserving non-negative integer avatar-version normalization semantics. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck` -> passed; `pnpm -C apps/filament-client-web exec vitest run tests/api-auth.test.ts` -> 12/12 tests passing).
- 2026-02-15: FE-03 slice 17 completed. Extracted auth endpoint export-wiring/delegation from `src/lib/api.ts` into new `src/lib/api-auth-client.ts`, rewired `src/lib/api.ts` to consume the dedicated auth client facade, and added focused auth-client delegation regression coverage in `tests/api-auth-client.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck` -> passed; `pnpm -C apps/filament-client-web exec vitest run tests/api-auth-client.test.ts tests/api-auth.test.ts tests/api-boundary.test.ts` -> 27/27 tests passing).
- 2026-02-15: FE-03 slice 18 completed. Extracted message endpoint export-wiring/delegation from `src/lib/api.ts` into new `src/lib/api-messages-client.ts`, rewired `src/lib/api.ts` to consume the dedicated messages client facade, and added focused message-client delegation regression coverage in `tests/api-messages-client.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck` -> passed; `pnpm -C apps/filament-client-web exec vitest run tests/api-messages-client.test.ts tests/api-messages.test.ts tests/api-boundary.test.ts` -> 24/24 tests passing).
- 2026-02-15: FE-03 slice 19 completed. Extracted friends endpoint export-wiring/delegation from `src/lib/api.ts` into new `src/lib/api-friends-client.ts`, rewired `src/lib/api.ts` to consume the dedicated friends client facade, and added focused friends-client delegation regression coverage in `tests/api-friends-client.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck` -> passed; `pnpm -C apps/filament-client-web exec vitest run tests/api-friends-client.test.ts tests/api-friends.test.ts tests/api-boundary.test.ts` -> 19/19 tests passing).
- 2026-02-15: FE-03 slice 20 completed. Extracted workspace endpoint export-wiring/delegation from `src/lib/api.ts` into new `src/lib/api-workspace-client.ts`, rewired `src/lib/api.ts` to consume the dedicated workspace client facade, and added focused workspace-client delegation regression coverage in `tests/api-workspace-client.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck` -> passed; `pnpm -C apps/filament-client-web exec vitest run tests/api-workspace-client.test.ts tests/api-workspace.test.ts tests/api-boundary.test.ts` -> 30/30 tests passing).
- 2026-02-15: FE-03 slice 21 completed. Extracted voice endpoint export-wiring/delegation from `src/lib/api.ts` into new `src/lib/api-voice-client.ts`, rewired `src/lib/api.ts` to consume the dedicated voice client facade, and added focused voice-client delegation regression coverage in `tests/api-voice-client.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck` -> passed; `pnpm -C apps/filament-client-web exec vitest run tests/api-voice-client.test.ts tests/api-voice.test.ts` -> 4/4 tests passing).
- 2026-02-15: FE-03 slice 22 completed. Extracted system endpoint export-wiring/delegation from `src/lib/api.ts` into new `src/lib/api-system-client.ts`, rewired `src/lib/api.ts` to consume the dedicated system client facade, and added focused system-client delegation regression coverage in `tests/api-system-client.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck` -> passed; `pnpm -C apps/filament-client-web exec vitest run tests/api-system-client.test.ts tests/api-system.test.ts tests/api-boundary.test.ts` -> 18/18 tests passing).
- 2026-02-15: FE-03 slice 23 completed. Extracted shared API transport/boundary request primitives from `src/lib/api.ts` into new `src/lib/api-transport.ts` and rewired `src/lib/api.ts` into a thin client composition root delegating through `createApiTransport`, preserving strict fail-closed caps/timeouts/error mapping behavior. Added focused malformed `content-length` boundary regression coverage in `tests/api-boundary.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck` -> passed; `pnpm -C apps/filament-client-web exec vitest run tests/api-boundary.test.ts` -> 13/13 tests passing).
- 2026-02-15: FE-03 closeout slice completed. Marked FE-03 complete after validating exit criteria with targeted verification (`pnpm -C apps/filament-client-web run typecheck` -> passed; `pnpm -C apps/filament-client-web exec vitest run tests/api-auth.test.ts tests/api-auth-client.test.ts tests/api-friends.test.ts tests/api-friends-client.test.ts tests/api-messages.test.ts tests/api-messages-client.test.ts tests/api-workspace.test.ts tests/api-workspace-client.test.ts tests/api-voice.test.ts tests/api-voice-client.test.ts tests/api-system.test.ts tests/api-system-client.test.ts tests/api-boundary.test.ts` -> 75/75 tests passing).
- 2026-02-15: FE-04 slice 1 completed. Added shared typed async operation state primitives (`AsyncOperationState`, `AsyncOperationEvent`, reducer + idle factory) in `src/features/app-shell/state/async-operation-state.ts` and covered deterministic transition semantics in `tests/app-shell-async-operation-state.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck && pnpm -C apps/filament-client-web exec vitest run tests/app-shell-async-operation-state.test.ts tests/app-shell-state.test.ts tests/app-shell-message-controller.test.ts tests/app-shell-message-history-controller.test.ts tests/app-shell-voice-controller.test.ts` -> 23/23 tests passing).
- 2026-02-15: FE-04 slice 2 completed. Added typed message-send async state signal to `src/features/app-shell/state/message-state.ts` and rewired `createMessageActionsController` in `src/features/app-shell/controllers/message-controller.ts` to emit `start/fail/succeed` transitions for send flows while preserving existing fail-closed status/error behavior; added focused send-state regression coverage in `tests/app-shell-message-controller.test.ts` and default-state coverage in `tests/app-shell-state.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck && pnpm -C apps/filament-client-web exec vitest run tests/app-shell-async-operation-state.test.ts tests/app-shell-state.test.ts tests/app-shell-message-controller.test.ts tests/app-shell-message-history-controller.test.ts tests/app-shell-voice-controller.test.ts` -> 23/23 tests passing).
- 2026-02-15: FE-04 slice 3 completed. Added typed message-history refresh async state signal to `src/features/app-shell/state/message-state.ts` and rewired `createMessageHistoryController` in `src/features/app-shell/controllers/message-history-controller.ts` to emit `reset/start/succeed/fail` transitions for refresh/load-older flows while preserving stale-request fail-closed behavior; added focused refresh-state regression coverage in `tests/app-shell-message-history-controller.test.ts` and default-state coverage in `tests/app-shell-state.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck && pnpm -C apps/filament-client-web exec vitest run tests/app-shell-async-operation-state.test.ts tests/app-shell-state.test.ts tests/app-shell-message-controller.test.ts tests/app-shell-message-history-controller.test.ts tests/app-shell-voice-controller.test.ts` -> 23/23 tests passing).
- 2026-02-15: FE-04 slice 4 completed. Added typed voice-join async state signal to `src/features/app-shell/state/voice-state.ts` and rewired `createVoiceOperationsController` in `src/features/app-shell/controllers/voice-operations-controller.ts` to emit `reset/start/succeed/fail` transitions for voice join flows while preserving least-privilege token requests and fail-closed join-error mapping; added focused voice-join-state regression coverage in `tests/app-shell-voice-controller.test.ts` and default-state coverage in `tests/app-shell-state.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck && pnpm -C apps/filament-client-web exec vitest run tests/app-shell-async-operation-state.test.ts tests/app-shell-state.test.ts tests/app-shell-message-controller.test.ts tests/app-shell-message-history-controller.test.ts tests/app-shell-voice-controller.test.ts` -> 23/23 tests passing).
- 2026-02-15: FE-04 slice 5 completed. Eliminated duplicate mutable message-send busy state by deriving `isSendingMessage` from `sendMessageState.phase` in `src/features/app-shell/state/message-state.ts`, removed send-busy setter mutation from `createMessageActionsController` in `src/features/app-shell/controllers/message-controller.ts`, rewired runtime/controller test harness wiring accordingly, and added focused derived-state assertions in `tests/app-shell-state.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck && pnpm -C apps/filament-client-web exec vitest run tests/app-shell-state.test.ts tests/app-shell-message-controller.test.ts` -> 12/12 tests passing).
- 2026-02-15: FE-04 slice 6 completed. Eliminated duplicate mutable voice-join busy state by deriving `isJoiningVoice` from `voiceJoinState.phase` in `src/features/app-shell/state/voice-state.ts`, removed join-busy setter mutation from `createVoiceOperationsController` in `src/features/app-shell/controllers/voice-operations-controller.ts`, rewired runtime/controller test harness wiring accordingly, and added focused derived-state assertions in `tests/app-shell-state.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck && pnpm -C apps/filament-client-web exec vitest run tests/app-shell-state.test.ts tests/app-shell-voice-controller.test.ts` -> 12/12 tests passing).
- 2026-02-15: FE-04 slice 7 completed. Replaced duplicate mutable message-history loading flags with typed `messageHistoryLoadTarget` plus phase-derived `isLoadingMessages`/`isLoadingOlder` accessors in `src/features/app-shell/state/message-state.ts`, preserving fail-closed async operation defaults and reducing invalid loading-state combinations. Targeted validation passed (`pnpm -C apps/filament-client-web exec vitest run tests/app-shell-state.test.ts` -> 4/4 tests passing).
- 2026-02-15: FE-04 slice 8 completed. Rewired message-history loading orchestration to drive typed load target transitions in `src/features/app-shell/controllers/message-history-controller.ts` and `src/features/app-shell/runtime/create-app-shell-runtime.ts`, preserving stale-request gating and deterministic reset behavior while removing independent mutable loading setters. Targeted validation passed (`pnpm -C apps/filament-client-web exec vitest run tests/app-shell-message-history-controller.test.ts` -> 2/2 tests passing; `pnpm -C apps/filament-client-web run typecheck` -> passed).
- 2026-02-15: FE-04 slice 9 completed. Hardened voice join precondition handling in `src/features/app-shell/controllers/voice-operations-controller.ts` so duplicate join attempts while join/leave is already in progress fail closed without resetting the running async operation state, preserving deterministic `voiceJoinState` transitions. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck && pnpm -C apps/filament-client-web exec vitest run tests/app-shell-voice-controller.test.ts tests/app-shell-message-history-controller.test.ts` -> typecheck passed; `tests/app-shell-voice-controller.test.ts` 9/9 passing, `tests/app-shell-message-history-controller.test.ts` 3/3 passing; 12/12 tests passing total).
- 2026-02-15: FE-04 slice 10 completed. Hardened message-history overlap guards in `src/features/app-shell/controllers/message-history-controller.ts` (and runtime wiring in `src/features/app-shell/runtime/create-app-shell-runtime.ts`) by requiring `loadOlderMessages` to short-circuit while refresh is running, eliminating invalid concurrent async-state combinations while preserving stale-request fail-closed semantics. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck && pnpm -C apps/filament-client-web exec vitest run tests/app-shell-voice-controller.test.ts tests/app-shell-message-history-controller.test.ts` -> typecheck passed; `tests/app-shell-voice-controller.test.ts` 9/9 passing, `tests/app-shell-message-history-controller.test.ts` 3/3 passing; 12/12 tests passing total).
- 2026-02-15: FE-04 slice 11 completed. Strengthened duplicate-join runtime regression coverage in `tests/app-shell-voice-controller.test.ts` by tracking `voiceJoinState` phase transitions and asserting duplicate join attempts during `running` keep transitions bounded (`running` -> terminal outcome) with no `idle`/reset transition emitted. Targeted validation passed (`pnpm -C apps/filament-client-web exec vitest run tests/app-shell-voice-controller.test.ts tests/app-shell-voice-controls.test.tsx` -> `tests/app-shell-voice-controller.test.ts` 9/9 passing, `tests/app-shell-voice-controls.test.tsx` 18/18 passing; 27/27 tests passing total).
- 2026-02-15: FE-04 slice 12 completed. Added focused runtime/UI regression coverage in `tests/app-shell-voice-controls.test.tsx` using a deferred voice-token response to assert repeated `Join Voice` clicks while `voiceJoinState.phase === running` keep the loading state (`Joining...`) stable, prevent reset affordance regressions, and avoid duplicate token requests. Targeted validation passed (`pnpm -C apps/filament-client-web exec vitest run tests/app-shell-voice-controller.test.ts tests/app-shell-voice-controls.test.tsx` -> `tests/app-shell-voice-controller.test.ts` 9/9 passing, `tests/app-shell-voice-controls.test.tsx` 18/18 passing; 27/27 tests passing total).
- 2026-02-15: FE-04 slice 13 completed. Added shared `isMessageHistoryLoadingForTarget` derivation in `src/features/app-shell/state/message-state.ts` and rewired `src/features/app-shell/controllers/message-history-controller.ts` + `src/features/app-shell/runtime/create-app-shell-runtime.ts` to consume canonical `refreshMessagesState`/`messageHistoryLoadTarget` accessors, removing duplicated loading-state interpretation while preserving fail-closed overlap/stale-request guards. Targeted validation passed (`pnpm -C apps/filament-client-web exec vitest run tests/app-shell-message-history-controller.test.ts tests/app-shell-message-controller.test.ts tests/app-shell-state.test.ts` -> `tests/app-shell-message-history-controller.test.ts` 3/3 passing, `tests/app-shell-message-controller.test.ts` 8/8 passing, `tests/app-shell-state.test.ts` 4/4 passing; 15/15 tests passing total).
- 2026-02-15: FE-04 slice 14 completed. Centralized send-message transition application in `src/features/app-shell/controllers/message-controller.ts` so each async transition update atomically synchronizes `sendMessageState`, `messageStatus`, and `messageError`; added focused stale-status fail-closed regression coverage in `tests/app-shell-message-controller.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck` -> passed; `pnpm -C apps/filament-client-web exec vitest run tests/app-shell-message-history-controller.test.ts tests/app-shell-message-controller.test.ts tests/app-shell-state.test.ts` -> `tests/app-shell-message-history-controller.test.ts` 3/3 passing, `tests/app-shell-message-controller.test.ts` 8/8 passing, `tests/app-shell-state.test.ts` 4/4 passing; 15/15 tests passing total).
- 2026-02-15: FE-04 slice 15 completed. Centralized message-history transition application in `src/features/app-shell/controllers/message-history-controller.ts` so each refresh/load-older/reset async transition update atomically synchronizes `refreshMessagesState` and `messageError`; added focused stale-error reset regression coverage in `tests/app-shell-message-history-controller.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck` -> passed; `pnpm -C apps/filament-client-web exec vitest run tests/app-shell-message-history-controller.test.ts tests/app-shell-voice-controller.test.ts` -> `tests/app-shell-message-history-controller.test.ts` 4/4 passing, `tests/app-shell-voice-controller.test.ts` 10/10 passing; 14/14 tests passing total).
- 2026-02-15: FE-04 slice 16 completed. Centralized voice-join transition application in `src/features/app-shell/controllers/voice-operations-controller.ts` so join `reset/start/succeed/fail` async transition updates atomically synchronize `voiceJoinState`, `voiceStatus`, and `voiceError`; added focused stale precondition-reset regression coverage in `tests/app-shell-voice-controller.test.ts` while preserving duplicate-join fail-closed behavior. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck` -> passed; `pnpm -C apps/filament-client-web exec vitest run tests/app-shell-message-history-controller.test.ts tests/app-shell-voice-controller.test.ts` -> `tests/app-shell-message-history-controller.test.ts` 4/4 passing, `tests/app-shell-voice-controller.test.ts` 10/10 passing; 14/14 tests passing total).
- 2026-02-15: FE-04 slice 17 completed. Added focused regression coverage in `tests/app-shell-voice-controller.test.ts` for microphone activation failure after successful voice join to assert `voiceJoinState` remains `succeeded` (`statusMessage: Voice connected.`) while `voiceError` is populated (`Connected, but microphone activation failed.`), guarding centralized join-transition synchronization against stale/overwritten error behavior. Targeted validation: initial run (`pnpm -C apps/filament-client-web exec vitest run tests/app-shell-voice-controller.test.ts && pnpm -C apps/filament-client-web run typecheck`) reported one failure in a newly added stale-error follow-up test; after focused harness correction, rerun passed (`pnpm -C apps/filament-client-web exec vitest run tests/app-shell-voice-controller.test.ts && pnpm -C apps/filament-client-web run typecheck` -> `tests/app-shell-voice-controller.test.ts` 12/12 passing; typecheck passed).
- 2026-02-15: FE-04 slice 18 completed. Added focused fail-then-success join regression coverage in `tests/app-shell-voice-controller.test.ts` to assert stale `voiceError` from a failed join is cleared on subsequent successful join transitions, preserving deterministic fail-closed state progression. Targeted validation passed (`pnpm -C apps/filament-client-web exec vitest run tests/app-shell-voice-controller.test.ts && pnpm -C apps/filament-client-web run typecheck` -> `tests/app-shell-voice-controller.test.ts` 12/12 passing; typecheck passed).
- 2026-02-15: FE-04 slice 19 completed. Hardened same-channel voice-join idempotency in `src/features/app-shell/controllers/voice-operations-controller.ts` by short-circuiting join requests when the requested channel key already matches `voiceSessionChannelKey`, preventing duplicate voice-token requests while preserving deterministic fail-closed async transition semantics; updated runtime wiring in `src/features/app-shell/runtime/create-app-shell-runtime.ts` and added focused idempotent-join regression coverage in `tests/app-shell-voice-controller.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck && pnpm -C apps/filament-client-web exec vitest run tests/app-shell-voice-controller.test.ts` -> typecheck passed; `tests/app-shell-voice-controller.test.ts` 13/13 passing).
- 2026-02-15: FE-04 slice 20 completed. Hardened leave teardown in `src/features/app-shell/controllers/voice-operations-controller.ts` to always apply a typed async `reset` transition for `voiceJoinState` after voice leave teardown, preventing stale join phase/error leakage across post-leave UI state while preserving explicit leave status messages; added focused leave-reset regression coverage in `tests/app-shell-voice-controller.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck && pnpm -C apps/filament-client-web exec vitest run tests/app-shell-voice-controller.test.ts` -> typecheck passed; `tests/app-shell-voice-controller.test.ts` 14/14 passing).
- 2026-02-15: FE-04 slice 21 completed. Hardened `src/features/app-shell/controllers/message-controller.ts` send precondition ordering to short-circuit duplicate submits while `sendMessageState.phase === running`, preventing invalid no-channel precondition failures from overwriting an active send transition and preserving deterministic fail-closed async state semantics; added focused running-duplicate regression coverage in `tests/app-shell-message-controller.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck && pnpm -C apps/filament-client-web exec vitest run tests/app-shell-message-controller.test.ts` -> typecheck passed; `tests/app-shell-message-controller.test.ts` 9/9 passing).
- 2026-02-15: FE-04 slice 22 completed. Moved empty-composer/attachment validation ahead of send `start` transition in `src/features/app-shell/controllers/message-controller.ts`, removing transient `running` phase churn for invalid send attempts while preserving fail-closed validation errors; added focused transition-history regression coverage in `tests/app-shell-message-controller.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web run typecheck && pnpm -C apps/filament-client-web exec vitest run tests/app-shell-message-controller.test.ts` -> typecheck passed; `tests/app-shell-message-controller.test.ts` 9/9 passing).
- 2026-02-15: FE-04 slice 23 completed. Added shared running-phase helper `isMessageHistoryLoading` in `src/features/app-shell/state/message-state.ts` and rewired `isMessageHistoryLoadingForTarget` to consume it, preserving deterministic fail-closed async loading interpretation for message history transitions. Targeted validation passed (`pnpm -C apps/filament-client-web exec vitest run tests/app-shell-state.test.ts tests/app-shell-message-history-controller.test.ts tests/app-shell-voice-controller.test.ts` -> 25/25 tests passing).
- 2026-02-15: FE-04 slice 24 completed. Hardened `src/features/app-shell/controllers/message-history-controller.ts` load-older overlap guard to block whenever history async phase is `running` (including null/indeterminate load-target states) and added focused fail-closed regression coverage in `tests/app-shell-message-history-controller.test.ts` plus helper-state coverage in `tests/app-shell-state.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web exec vitest run tests/app-shell-state.test.ts tests/app-shell-message-history-controller.test.ts tests/app-shell-voice-controller.test.ts` -> 25/25 tests passing).
- 2026-02-15: FE-04 slice 25 completed. Added same-channel idempotent-join stale-state regression in `tests/app-shell-voice-controller.test.ts` to verify stale failed `voiceJoinState` and `voiceError` are cleared by deterministic `succeeded` join transition without issuing a new token. Targeted validation passed (`pnpm -C apps/filament-client-web exec vitest run tests/app-shell-state.test.ts tests/app-shell-message-history-controller.test.ts tests/app-shell-voice-controller.test.ts` -> 25/25 tests passing).
- 2026-02-15: FE-04 closeout slice completed. Marked FE-04 complete after focused validation (`pnpm -C apps/filament-client-web exec vitest run tests/app-shell-state.test.ts tests/app-shell-message-history-controller.test.ts tests/app-shell-voice-controller.test.ts` -> 25/25 tests passing; `pnpm -C apps/filament-client-web run typecheck` -> passed).
- 2026-02-15: FE-05 slice 1 completed. Added focused import-boundary rule helpers in `scripts/import-boundary-rules.mjs` (layer classification, import specifier extraction, relative target resolution, and forbidden-edge detection for `domain !-> lib/features` + `lib !-> features`) and added focused rule regression coverage in `tests/import-boundary-rules.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web exec vitest run tests/import-boundary-rules.test.ts` -> 4/4 tests passing).
- 2026-02-15: FE-05 slice 2 completed. Added boundary-scan runner in `scripts/check-import-boundaries.mjs` with bounded `src/**` source-file discovery and fail-closed violation reporting, and added focused temporary-fixture scanner coverage in `tests/check-import-boundaries.test.ts` to assert both forbidden and allowed layer edges. Targeted validation passed (`pnpm -C apps/filament-client-web exec vitest run tests/import-boundary-rules.test.ts tests/check-import-boundaries.test.ts` -> 6/6 tests passing).
- 2026-02-15: FE-05 slice 3 completed. Wired enforce-mode import-boundary lint command in `apps/filament-client-web/package.json` (`lint:boundaries` + `lint`) and validated current source layering remains compliant. Targeted validation passed (`pnpm -C apps/filament-client-web run lint:boundaries` -> `[import-boundaries] OK: scanned 160 source files in src with no layer violations.`).
- 2026-02-15: FE-05 slice 4 completed. Hardened source-root input validation in `apps/filament-client-web/scripts/check-import-boundaries.mjs` to fail closed when `--source` is absolute or escapes the web root, and added focused scanner regression coverage in `apps/filament-client-web/tests/check-import-boundaries.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web exec vitest run tests/check-import-boundaries.test.ts` -> 4/4 tests passing).
- 2026-02-15: FE-05 slice 5 completed. Added fail-closed source file scan-cap enforcement in `apps/filament-client-web/scripts/check-import-boundaries.mjs` (bounded default and optional `FILAMENT_IMPORT_BOUNDARY_MAX_SCANNED_FILES` override), and added focused cap regression coverage in `apps/filament-client-web/tests/check-import-boundaries.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web exec vitest run tests/check-import-boundaries.test.ts` -> 5/5 tests passing).
- 2026-02-15: FE-05 slice 6 completed. Added import-boundary CI enforcement to `.github/workflows/ci.yml` (`web` job runs `npm run lint:boundaries` before typecheck) and validated the enforce command remains green with current layering. Targeted validation passed (`pnpm -C apps/filament-client-web run lint:boundaries` -> `[import-boundaries] OK: scanned 160 source files in src with no layer violations.`).
- 2026-02-15: FE-05 marked complete after confirming the success metric: CI now fails closed on import-boundary violations (`npm run lint:boundaries` in `web` job) and current source layering remains compliant under enforce mode.
- 2026-02-15: FE-06 slice 1 completed. Added bounded typed diagnostics event counters in `apps/filament-client-web/src/features/app-shell/state/diagnostics-event-counters.ts`, wired counter accessors and update helpers into `apps/filament-client-web/src/features/app-shell/state/diagnostics-state.ts`, and added focused default/saturation + diagnostics state regression coverage in `apps/filament-client-web/tests/app-shell-diagnostics-event-counters.test.ts` and `apps/filament-client-web/tests/app-shell-state.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web exec vitest run tests/app-shell-diagnostics-event-counters.test.ts tests/app-shell-state.test.ts` -> 7/7 tests passing).
- 2026-02-15: FE-06 slice 2 completed. Instrumented `apps/filament-client-web/src/features/app-shell/runtime/session-diagnostics-controller.ts` to emit structured typed diagnostics counter events (`session_refresh_*`, `health_check_*`, `echo_*`, `logout_requested`) while preserving fail-closed status/error mapping, rewired action/runtime wiring in `apps/filament-client-web/src/features/app-shell/runtime/session-diagnostics-actions.ts` and `apps/filament-client-web/src/features/app-shell/runtime/create-app-shell-runtime.ts`, and added focused regression coverage in `apps/filament-client-web/tests/app-shell-session-diagnostics-controller.test.ts` and `apps/filament-client-web/tests/app-shell-session-diagnostics-actions.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web exec vitest run tests/app-shell-session-diagnostics-controller.test.ts tests/app-shell-session-diagnostics-actions.test.ts` -> 5/5 tests passing).
- 2026-02-15: FE-06 slice 3 completed. Added dev-only utility diagnostics wiring and rendering by threading diagnostics counter props through `apps/filament-client-web/src/features/app-shell/runtime/support-panel-host-state-options.ts`, `apps/filament-client-web/src/features/app-shell/runtime/support-panel-prop-groups-options.ts`, `apps/filament-client-web/src/features/app-shell/runtime/utility-panel-props.ts`, `apps/filament-client-web/src/features/app-shell/adapters/panel-host-props.ts`, and `apps/filament-client-web/src/features/app-shell/components/panels/UtilityPanel.tsx`; added focused regression coverage in `apps/filament-client-web/tests/app-shell-utility-panel.test.tsx`, `apps/filament-client-web/tests/app-shell-utility-panel-props.test.ts`, `apps/filament-client-web/tests/app-shell-support-panel-host-state-options.test.ts`, `apps/filament-client-web/tests/app-shell-panel-host-props.test.tsx`, `apps/filament-client-web/tests/app-shell-panel-host-prop-groups.test.ts`, `apps/filament-client-web/tests/app-shell-support-panel-prop-groups-options.test.ts`, and `apps/filament-client-web/tests/app-shell-support-panel-prop-groups.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web exec vitest run tests/app-shell-utility-panel-props.test.ts tests/app-shell-support-panel-host-state-options.test.ts tests/app-shell-panel-host-props.test.tsx tests/app-shell-utility-panel.test.tsx` -> 7/7 tests passing; `pnpm -C apps/filament-client-web exec vitest run tests/app-shell-panel-host-prop-groups.test.ts tests/app-shell-support-panel-prop-groups-options.test.ts tests/app-shell-support-panel-prop-groups.test.ts` -> 3/3 tests passing).
- 2026-02-15: FE-06 slice 4 completed. Extended diagnostics event counter modeling with gateway connectivity events (`gateway_connected`/`gateway_disconnected`) in `apps/filament-client-web/src/features/app-shell/state/diagnostics-event-counters.ts` and aligned default diagnostics state expectations in `apps/filament-client-web/tests/app-shell-diagnostics-event-counters.test.ts` and `apps/filament-client-web/tests/app-shell-state.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web exec vitest run tests/app-shell-diagnostics-event-counters.test.ts tests/app-shell-state.test.ts` -> 7/7 tests passing).
- 2026-02-15: FE-06 slice 5 completed. Wired gateway connectivity diagnostics recording by adding optional connection-change callback handling in `apps/filament-client-web/src/features/app-shell/controllers/gateway-controller.ts`, threading the callback through `apps/filament-client-web/src/features/app-shell/runtime/gateway-controller-registration.ts`, and recording `gateway_connected`/`gateway_disconnected` in `apps/filament-client-web/src/features/app-shell/runtime/create-app-shell-runtime.ts`; added focused gateway callback regression coverage in `apps/filament-client-web/tests/app-shell-gateway-controller.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web exec vitest run tests/app-shell-gateway-controller.test.ts` -> 7/7 tests passing).
- 2026-02-15: FE-06 slice 6 completed. Surfaced gateway connectivity diagnostics counters in the dev-only utility panel (`apps/filament-client-web/src/features/app-shell/components/panels/UtilityPanel.tsx`) and aligned utility/support/panel-host diagnostics fixtures in `apps/filament-client-web/tests/app-shell-utility-panel.test.tsx`, `apps/filament-client-web/tests/app-shell-utility-panel-props.test.ts`, `apps/filament-client-web/tests/app-shell-support-panel-prop-groups.test.ts`, `apps/filament-client-web/tests/app-shell-support-panel-prop-groups-options.test.ts`, `apps/filament-client-web/tests/app-shell-support-panel-host-state-options.test.ts`, `apps/filament-client-web/tests/app-shell-panel-host-props.test.tsx`, and `apps/filament-client-web/tests/app-shell-panel-host-prop-groups.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web exec vitest run tests/app-shell-utility-panel.test.tsx tests/app-shell-utility-panel-props.test.ts tests/app-shell-support-panel-prop-groups.test.ts tests/app-shell-support-panel-prop-groups-options.test.ts tests/app-shell-support-panel-host-state-options.test.ts tests/app-shell-panel-host-props.test.tsx tests/app-shell-panel-host-prop-groups.test.ts` -> 10/10 tests passing).
- 2026-02-15: FE-06 closeout slice completed. Marked FE-06 complete after focused diagnostics regression verification (`pnpm -C apps/filament-client-web exec vitest run tests/app-shell-diagnostics-event-counters.test.ts tests/app-shell-state.test.ts tests/app-shell-gateway-controller.test.ts tests/app-shell-utility-panel.test.tsx tests/app-shell-utility-panel-props.test.ts tests/app-shell-support-panel-prop-groups.test.ts tests/app-shell-support-panel-prop-groups-options.test.ts tests/app-shell-support-panel-host-state-options.test.ts tests/app-shell-panel-host-props.test.tsx tests/app-shell-panel-host-prop-groups.test.ts` -> 24/24 tests passing).
- 2026-02-15: FE-07 slice 1 completed. Added bounded message-list render-window helper primitives in `apps/filament-client-web/src/features/app-shell/components/messages/message-list-window.ts` (default render budget + hard cap with fail-closed integer sanitization), and added focused helper regression coverage in `apps/filament-client-web/tests/app-shell-message-list-window.test.ts`. Targeted validation passed (`pnpm -C apps/filament-client-web exec vitest run tests/app-shell-message-list-window.test.ts` -> 4/4 tests passing).
- 2026-02-15: FE-07 slice 2 completed. Rewired `apps/filament-client-web/src/features/app-shell/components/messages/MessageList.tsx` to consume the shared render-window helper and render a trailing bounded message window for dense histories, added focused component coverage in `apps/filament-client-web/tests/app-shell-message-list.test.tsx`, and re-verified existing history scroll behavior in `apps/filament-client-web/tests/app-shell-message-history-scroll.test.tsx`. Targeted validation passed (`pnpm -C apps/filament-client-web exec vitest run tests/app-shell-message-list-window.test.ts tests/app-shell-message-list.test.tsx tests/app-shell-message-history-scroll.test.tsx` -> 9/9 tests passing).

---

## Backend Pass (Completed First Draft)
Date: 2026-02-12
Scope: `apps/filament-server`, `crates/filament-core`, `crates/filament-protocol`

### Evidence Sampled
- Runtime composition and config: `apps/filament-server/src/main.rs`, `src/server/mod.rs`, `src/server/core.rs`
- Boundary/router surface: `apps/filament-server/src/server/router.rs`
- Auth/security boundaries: `apps/filament-server/src/server/auth.rs`, `docs/SECURITY.md`
- Realtime and protocol: `apps/filament-server/src/server/realtime.rs`, `src/server/gateway_events.rs`, `crates/filament-protocol/src/lib.rs`, `docs/GATEWAY_EVENTS.md`
- Persistence and domain logic: `apps/filament-server/src/server/db.rs`, `src/server/domain.rs`, `src/server/permissions.rs`
- Tests/contracts: `apps/filament-server/tests/security_limits.rs`, `src/server/tests.rs`, `docs/API.md`

### Objective Architecture Snapshot
- Server follows a layered split (`router` -> `handlers` -> `domain`/`db`/`realtime`) with shared `AppState` and runtime security config.
- Security controls are explicit and centralized in config defaults + router validation (body caps, timeouts, route/IP rate limits, gateway ingress caps, token TTL caps).
- Protocol boundary is strongly versioned via `filament-protocol` (`{v,t,d}`, strict event type validation, max payload enforcement).
- Persistence supports Postgres runtime with in-memory fallback paths retained for tests/non-DB flows.
- Search and voice integrations are policy-driven by server-side checks (permissions, quotas, scoped token issuance), consistent with hostile-client assumptions.

### Baseline Metrics
- `apps/filament-server/src/server/realtime.rs`: 1712 lines
- `apps/filament-server/src/server/gateway_events.rs`: 1501 lines
- `apps/filament-server/src/server/domain.rs`: 1583 lines
- `apps/filament-server/src/server/db.rs`: 941 lines
- `apps/filament-server/src/server/tests.rs`: 2404 lines
- `apps/filament-server/tests/*.rs`: 10 files
- Shared crate test files (`crates/filament-core/tests`, `crates/filament-protocol/tests`): 1 file

### Scorecard (Current)
| Dimension | Score | Rationale |
| --- | --- | --- |
| Modularity | 3/5 | Clear module boundaries exist, but realtime/domain/event building remain concentrated in very large files |
| Correctness Safety | 4/5 | Strong contract/security tests and explicit policy docs; some monolithic test files reduce local change confidence |
| Security Hardening | 5/5 | Consistent hard limits, strict auth/protocol checks, hostile-input posture across HTTP/WS/token paths |
| Operability | 4/5 | Structured logging, request IDs, metrics endpoints, and gateway-specific counters are in place |
| Change Velocity | 3/5 | Feature work is possible, but large hotspots increase merge risk and refactor cost |

### Backend Improvement Backlog
| ID | Priority | Area | Observation | Proposed Increment | Success Metric |
| --- | --- | --- | --- | --- | --- |
| BE-01 | P0 | Realtime orchestration | `realtime.rs` mixes WS lifecycle, ingress parsing, message ops, presence/voice/search flows | Split into bounded modules (`connection`, `ingress`, `fanout`, `voice_presence`, `search_ops`) under `server/realtime/` | `realtime` root module < 700 lines; existing gateway tests remain green |
| BE-02 | P0 | Event emission model | `gateway_events.rs` centralizes many payload builders and event constants in one file | Introduce per-domain event emitter modules and shared typed envelope adapter | Event module files are domain-scoped; event contract tests added/updated per domain |
| BE-03 | P0 | Domain service concentration | `domain.rs` combines permission resolution, moderation/IP-ban enforcement, attachments/reactions flows | Extract service-focused submodules (`permissions_eval`, `moderation`, `attachments`, `reactions`) with narrow APIs | Domain root file < 800 lines and no permission regression in role/override tests |
| BE-04 | P1 | DB schema/migration ownership | `db.rs` contains many DDL/backfill concerns alongside runtime helpers | Move schema bootstrap and backfills into versioned migration units and keep runtime DB access in focused repository modules | Reduced churn in `db.rs`; migration tests verify idempotent startup and role/override backfills |
| BE-05 | P1 | Test topology | `src/server/tests.rs` is a large integration omnibus | Split tests by capability (`auth`, `guilds`, `roles`, `gateway`, `directory`, `voice`) with shared fixture helpers | Smaller test files, easier targeted runs, unchanged total behavior coverage |
| BE-06 | P1 | API surface governance | Router currently declares many routes inline; growth risks drift against docs/contracts | Add generated/validated route manifest checks tied to `docs/API.md` and gateway contract docs | CI catches undocumented route/event drift before merge |
| BE-07 | P2 | Runtime state abstraction | `AppState` holds many maps/queues directly, increasing cognitive load and lock-scope risk | Introduce bounded state components (auth/session store, membership store, realtime registry) behind typed facades | Lower lock contention in hotspots and clearer ownership in code review |

### Recommended Iteration Order (Backend)
1. BE-01 Realtime module decomposition
2. BE-02 Event emitter modularization
3. BE-03 Domain service extraction
4. BE-05 Test topology split (parallel with BE-01..03)
5. BE-04 DB migration/repository separation
6. BE-06 Contract drift guardrails
7. BE-07 AppState componentization

### Backend Iteration Log
- 2026-02-12: Initial objective backend assessment captured; no server behavior changed in this pass.