# ITER_BE_2026-02-17_01

## Purpose
Handoff document for a fresh context to continue backend architecture/code improvements without re-discovery.

## Naming System (Proposed)
Use this file pattern for all iterative improvement passes:

`ITER_<SCOPE>_<YYYY-MM-DD>_<NN>.md`

- `SCOPE`: `BE`, `FE`, `GLOBAL`, `RTC`, `UX`, etc.
- `YYYY-MM-DD`: start date of the pass
- `NN`: 2-digit sequence for multiple passes on same date

Examples:
- `ITER_BE_2026-02-17_01.md`
- `ITER_BE_2026-02-17_02.md`
- `ITER_FE_2026-02-18_01.md`

### Rules
- Never rename completed iteration files.
- New pass = new file.
- Keep one stable anchor file per scope (for backend that remains `IMPROVEMENTS_BE.md`) and link to iteration files from there.
- Record only deltas in each iteration file (no full-history copy).

---

## Current Backend Delta
Date: 2026-02-17

### Already Completed In Latest Pass
- Added shared HTTP client in app state and switched captcha verification to reuse it.
- Added opportunistic stale-key sweeping for in-memory limiter maps/leases.
- Added regression test for stale limiter-key pruning.

### Remaining Work (Priority Order)

#### 1) Startup-Only Schema Initialization
Move schema initialization out of handlers and into server startup/bootstrap only.

Outcome target:
- No per-request `ensure_db_schema(&state).await?` calls in handlers.
- Startup fails fast if schema/bootstrap fails.

Acceptance checks:
- Existing endpoint tests stay green.
- New startup/bootstrap test verifies fail-fast on migration failure path.

#### 2) Repository Seam for Auth (Vertical Slice First)
Introduce repository traits for auth/session persistence so handler logic no longer branches on `if let Some(pool)`.

Outcome target:
- Auth flow (`register/login/refresh/logout`) uses an abstraction with DB and in-memory implementations.
- Branching is isolated to repository wiring, not handlers.

Acceptance checks:
- Auth tests pass unchanged in behavior.
- In-memory and DB paths exercise same behavior contract.

#### 3) Session + Replay Retention Cleanup
Add bounded retention strategy for expired sessions and used refresh-token replay records.

Outcome target:
- Expired sessions are periodically removed.
- Replay-token history is pruned with safe retention window.
- No unbounded growth in long-lived runtimes.

Acceptance checks:
- New tests for cleanup idempotence and replay protection preservation.

#### 4) AppState Decomposition (Next Layer)
Continue reducing `AppState` coupling by introducing tighter context components where still broad.

Outcome target:
- Clear ownership boundaries for auth, realtime, media, directory/search concerns.
- Lower fixture complexity in tests.

Acceptance checks:
- No behavior drift in gateway/auth/message integration tests.

#### 5) Hardening + Performance Characterization Tests
Add abuse/perf guard tests specifically for recently changed paths.

Outcome target:
- Tests for many-unique-key rate-limit traffic confirm stale key cleanup keeps maps bounded.
- Tests for refresh replay lifecycle verify cleanup does not weaken replay detection.

Acceptance checks:
- Deterministic pass/fail assertions (no timing-flaky checks).

---

## Suggested Next Execution Sequence
1. Startup-only schema init refactor
2. Auth repository seam (single vertical slice)
3. Session/replay cleanup jobs
4. AppState decomposition follow-ups
5. Hardening/perf characterization tests

## Notes for Fresh Context
- Preserve security-first defaults; do not relax caps/timeouts/rate limits.
- Keep behavior-compatible changes unless explicitly approved.
- Prefer incremental, test-backed slices over broad rewrites.