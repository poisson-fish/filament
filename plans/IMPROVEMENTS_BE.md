# IMPROVEMENTS_BE.md

## Purpose
This document tracks backend architecture improvements for:
1. `filament-server`
2. shared Rust crates (`crates/filament-core`, `crates/filament-protocol`)

## How To Iterate in Backend Context
- Update only backend sections in this file.
- Keep completed items immutable; append deltas in the "Iteration Log".
- Preserve security posture from `AGENTS.md` (no relaxed limits/timeouts/validation).
- For each proposed change, include: objective, risk, smallest safe increment, success metric.

## Shared Scoring Rubric
Use this rubric for objective comparison.

| Dimension | 1 (Weak) | 3 (Moderate) | 5 (Strong) |
| --- | --- | --- | --- |
| Modularity | Large mixed modules, unclear seams | Some separation, partial seams | Small focused modules with clear boundaries |
| Correctness Safety | Sparse guards/tests | Good tests in core paths | Broad characterization + boundary contract tests |
| Security Hardening | Inconsistent input constraints | Core constraints present | Strict boundary validation + limits + hostile-input assumptions throughout |
| Operability | Hard to diagnose failures | Basic status/error surfacing | Explicit metrics/logging/debug signals and deterministic failure modes |
| Change Velocity | Refactors risky/slower | Manageable with care | Incremental changes are predictable and low-risk |

---

## Backend Pass (Completed First Draft)
Date: 2026-02-12
Scope: `apps/filament-server`, `crates/filament-core`, `crates/filament-protocol`

### Evidence Sampled
- Runtime composition and config: `apps/filament-server/src/main.rs`, `src/server/mod.rs`, `src/server/core.rs`
- Boundary/router surface: `apps/filament-server/src/server/router.rs`
- Auth/security boundaries: `apps/filament-server/src/server/auth.rs`, `docs/SECURITY.md`
- Realtime and protocol: `apps/filament-server/src/server/realtime.rs`, `src/server/gateway_events.rs`, `crates/filament-protocol/src/lib.rs`, `docs/GATEWAY_EVENTS.md`
- Persistence and domain logic: `apps/filament-server/src/server/db.rs`, `src/server/domain.rs`, `src/server/permissions.rs`
- Tests/contracts: `apps/filament-server/tests/security_limits.rs`, `src/server/tests.rs`, `docs/API.md`

### Objective Architecture Snapshot
- Server follows a layered split (`router` -> `handlers` -> `domain`/`db`/`realtime`) with shared `AppState` and runtime security config.
- Security controls are explicit and centralized in config defaults + router validation (body caps, timeouts, route/IP rate limits, gateway ingress caps, token TTL caps).
- Protocol boundary is strongly versioned via `filament-protocol` (`{v,t,d}`, strict event type validation, max payload enforcement).
- Persistence supports Postgres runtime with in-memory fallback paths retained for tests/non-DB flows.
- Search and voice integrations are policy-driven by server-side checks (permissions, quotas, scoped token issuance), consistent with hostile-client assumptions.

### Baseline Metrics
- `apps/filament-server/src/server/realtime.rs`: 1712 lines
- `apps/filament-server/src/server/gateway_events.rs`: 1501 lines
- `apps/filament-server/src/server/domain.rs`: 1583 lines
- `apps/filament-server/src/server/db.rs`: 941 lines
- `apps/filament-server/src/server/tests.rs`: 2404 lines
- `apps/filament-server/tests/*.rs`: 10 files
- Shared crate test files (`crates/filament-core/tests`, `crates/filament-protocol/tests`): 1 file

### Scorecard (Current)
| Dimension | Score | Rationale |
| --- | --- | --- |
| Modularity | 3/5 | Clear module boundaries exist, but realtime/domain/event building remain concentrated in very large files |
| Correctness Safety | 4/5 | Strong contract/security tests and explicit policy docs; some monolithic test files reduce local change confidence |
| Security Hardening | 5/5 | Consistent hard limits, strict auth/protocol checks, hostile-input posture across HTTP/WS/token paths |
| Operability | 4/5 | Structured logging, request IDs, metrics endpoints, and gateway-specific counters are in place |
| Change Velocity | 3/5 | Feature work is possible, but large hotspots increase merge risk and refactor cost |

### Backend Improvement Backlog
| ID | Priority | Area | Observation | Proposed Increment | Success Metric |
| --- | --- | --- | --- | --- | --- |
| BE-01 | P0 | Realtime orchestration | `realtime.rs` mixes WS lifecycle, ingress parsing, message ops, presence/voice/search flows | Split into bounded modules (`connection`, `ingress`, `fanout`, `voice_presence`, `search_ops`) under `server/realtime/` | `realtime` root module < 700 lines; existing gateway tests remain green |
| BE-02 | P0 | Event emission model | `gateway_events.rs` centralizes many payload builders and event constants in one file | Introduce per-domain event emitter modules and shared typed envelope adapter | Event module files are domain-scoped; event contract tests added/updated per domain |
| BE-03 | P0 | Domain service concentration | `domain.rs` combines permission resolution, moderation/IP-ban enforcement, attachments/reactions flows | Extract service-focused submodules (`permissions_eval`, `moderation`, `attachments`, `reactions`) with narrow APIs | Domain root file < 800 lines and no permission regression in role/override tests |
| BE-04 | P1 | DB schema/migration ownership | `db.rs` contains many DDL/backfill concerns alongside runtime helpers | Move schema bootstrap and backfills into versioned migration units and keep runtime DB access in focused repository modules | Reduced churn in `db.rs`; migration tests verify idempotent startup and role/override backfills |
| BE-05 | P1 | Test topology | `src/server/tests.rs` is a large integration omnibus | Split tests by capability (`auth`, `guilds`, `roles`, `gateway`, `directory`, `voice`) with shared fixture helpers | Smaller test files, easier targeted runs, unchanged total behavior coverage |
| BE-06 | P1 | API surface governance | Router currently declares many routes inline; growth risks drift against docs/contracts | Add generated/validated route manifest checks tied to `docs/API.md` and gateway contract docs | CI catches undocumented route/event drift before merge |
| BE-07 | P2 | Runtime state abstraction | `AppState` holds many maps/queues directly, increasing cognitive load and lock-scope risk | Introduce bounded state components (auth/session store, membership store, realtime registry) behind typed facades | Lower lock contention in hotspots and clearer ownership in code review |

Item Status
- BE-01: In progress status delta on 2026-02-15 (slices 1-2 completed: extracted gateway ingress rate-limit enforcement into `apps/filament-server/src/server/realtime/ingress_rate_limit.rs` with focused unit coverage, extracted gateway ingress websocket message decoding into `apps/filament-server/src/server/realtime/ingress_message.rs` with focused unit coverage, and rewired `apps/filament-server/src/server/realtime.rs` to delegate both paths while preserving fail-closed event-size and disconnect handling semantics).
- BE-01: In progress status delta on 2026-02-15 (slices 3-4 completed: extracted channel fanout dispatch helper into `apps/filament-server/src/server/realtime/fanout_dispatch.rs` with focused unit coverage for delivered/closed/full queue paths, extracted voice presence helper functions into `apps/filament-server/src/server/realtime/voice_presence.rs` with focused unit coverage for key derivation and snapshot mapping, and rewired `apps/filament-server/src/server/realtime.rs` to delegate both helpers while preserving existing disconnect and event emission behavior).
- BE-01: In progress status delta on 2026-02-15 (slices 5-8 completed: extracted guild fanout dispatch into `apps/filament-server/src/server/realtime/fanout_guild.rs`, extracted user fanout dispatch into `apps/filament-server/src/server/realtime/fanout_user.rs`, extracted presence subscribe transition logic into `apps/filament-server/src/server/realtime/presence_subscribe.rs`, extracted disconnect presence/offline-guild outcome logic into `apps/filament-server/src/server/realtime/presence_disconnect.rs`, and rewired `apps/filament-server/src/server/realtime.rs` to delegate these paths while preserving fail-closed queue handling and scoped presence fanout semantics; BE-01 remains open because `apps/filament-server/src/server/realtime.rs` is still 1595 lines vs. the <700 completion target).
- BE-01: In progress status delta on 2026-02-15 (slices 9-12 completed: extracted slow-connection close signaling into `apps/filament-server/src/server/realtime/connection_control.rs`, extracted voice participant registry mutation helpers into `apps/filament-server/src/server/realtime/voice_registry.rs`, expanded `apps/filament-server/src/server/realtime/voice_presence.rs` with channel snapshot collection/sorting, extracted search abuse-limit validation into `apps/filament-server/src/server/realtime/search_validation.rs`, and rewired `apps/filament-server/src/server/realtime.rs` to delegate these paths while preserving fail-closed queue-close signaling and search boundary checks; BE-01 remains open because `apps/filament-server/src/server/realtime.rs` is still 1554 lines vs. the <700 completion target).
- BE-01: In progress status delta on 2026-02-15 (slices 13-15 completed: extracted voice registration transition/cap enforcement into `apps/filament-server/src/server/realtime/voice_registration.rs`, extracted search reconciliation diff computation into `apps/filament-server/src/server/realtime/search_reconcile.rs`, extracted hydration ordering helper into `apps/filament-server/src/server/realtime/hydration_order.rs`, and rewired `apps/filament-server/src/server/realtime.rs` to delegate all three paths while preserving fail-closed limits and message ordering semantics; BE-01 remains open because `apps/filament-server/src/server/realtime.rs` is still 1492 lines vs. the <700 completion target).
- BE-01: In progress status delta on 2026-02-15 (slices 16-19 completed: extracted parse-validated expired/disconnected voice cleanup planning into `apps/filament-server/src/server/realtime/voice_registry.rs`, extracted voice-sync outbound enqueue outcome handling into `apps/filament-server/src/server/realtime/voice_presence.rs`, extracted presence-sync outbound enqueue outcome handling into `apps/filament-server/src/server/realtime/presence_subscribe.rs`, and rewired `apps/filament-server/src/server/realtime.rs` to delegate all four paths while preserving fail-closed queue/drop handling and invalid-key discard behavior; BE-01 remains open because `apps/filament-server/src/server/realtime.rs` is still 1502 lines vs. the <700 completion target).
- BE-01: In progress status delta on 2026-02-15 (slices 20-22 completed: extracted in-memory all-guild indexed-message collection into `apps/filament-server/src/server/realtime/search_collect_all.rs`, extracted in-memory guild-scoped indexed-message collection with fail-closed cap/not-found behavior into `apps/filament-server/src/server/realtime/search_collect_guild.rs`, extracted message-to-index mapping into `apps/filament-server/src/server/realtime/search_indexed_message.rs`, and rewired `apps/filament-server/src/server/realtime.rs` to delegate all three paths while preserving existing search boundaries and compatibility for existing imports; BE-01 remains open because `apps/filament-server/src/server/realtime.rs` is still 1466 lines vs. the <700 completion target).
- BE-01: In progress status delta on 2026-02-15 (slices 23-24 completed: extracted index message-id collection/query-count cap enforcement into `apps/filament-server/src/server/realtime/search_collect_index_ids.rs`, extracted tantivy query execution/filtering into `apps/filament-server/src/server/realtime/search_query_exec.rs`, and rewired `apps/filament-server/src/server/realtime.rs` to delegate both timeout-wrapped spawn-blocking paths while preserving fail-closed invalid-query and cap behavior; BE-01 remains open because `apps/filament-server/src/server/realtime.rs` is still above the <700 completion target).
- BE-01: In progress status delta on 2026-02-15 (slices 25-27 completed: extracted ingress event-to-command parsing into `apps/filament-server/src/server/realtime/ingress_command.rs`, extracted voice participant removal event planning into `apps/filament-server/src/server/realtime/voice_cleanup_events.rs`, extracted authenticated-user connection target selection into `apps/filament-server/src/server/realtime/fanout_user_targets.rs`, and rewired `apps/filament-server/src/server/realtime.rs` to delegate all three paths while preserving fail-closed unknown-event disconnect handling and existing ingress/voice fanout metrics behavior; BE-01 remains open because `apps/filament-server/src/server/realtime.rs` is still 1379 lines vs. the <700 completion target).
- BE-01: In progress status delta on 2026-02-15 (slices 28-29 completed: extracted Tantivy search schema construction into `apps/filament-server/src/server/realtime/search_schema.rs`, extracted search index operation application into `apps/filament-server/src/server/realtime/search_apply.rs`, and rewired `apps/filament-server/src/server/realtime.rs` through compatibility wrappers to delegate both paths while preserving fail-closed search operation behavior and existing call-site contracts; BE-01 remains open because `apps/filament-server/src/server/realtime.rs` is still 1317 lines vs. the <700 completion target).
- BE-01: In progress status delta on 2026-02-15 (slices 30-32 completed: extracted message body validation/tokenization preparation into `apps/filament-server/src/server/realtime/message_prepare.rs`, extracted in-memory attachment ownership/binding checks into `apps/filament-server/src/server/realtime/message_attachment_bind.rs`, extracted timeout-wrapped spawn-blocking search execution into `apps/filament-server/src/server/realtime/search_blocking.rs`, and rewired `apps/filament-server/src/server/realtime.rs` to delegate all three paths while preserving fail-closed invalid-request and internal-error mapping semantics; BE-01 remains open because `apps/filament-server/src/server/realtime.rs` is still 1299 lines vs. the <700 completion target).
- BE-01: In progress status delta on 2026-02-15 (slices 33-36 completed: extracted voice registration event planning into `apps/filament-server/src/server/realtime/voice_registration_events.rs`, extracted in-memory message hydration map collection into `apps/filament-server/src/server/realtime/hydration_in_memory.rs`, extracted connection subscription-pruning into `apps/filament-server/src/server/realtime/connection_subscriptions.rs`, extracted search worker batch-drain logic into `apps/filament-server/src/server/realtime/search_batch_drain.rs`, and rewired `apps/filament-server/src/server/realtime.rs` to delegate all four paths while preserving fail-closed malformed voice-key discard behavior, not-found hydration behavior, and bounded search batching; BE-01 remains open because `apps/filament-server/src/server/realtime.rs` is still 1200 lines vs. the <700 completion target).
- BE-01: In progress status delta on 2026-02-15 (slices 37-39 completed: extracted search queue enqueue/ack flow into `apps/filament-server/src/server/realtime/search_enqueue.rs`, extracted search worker apply+ack fanout into `apps/filament-server/src/server/realtime/search_apply_batch.rs`, expanded `apps/filament-server/src/server/realtime/voice_cleanup_events.rs` with shared voice removal broadcast planning, and rewired `apps/filament-server/src/server/realtime.rs` cleanup/search paths to delegate while preserving fail-closed internal-error mapping and voice channel-scoped event emission semantics; BE-01 remains open because `apps/filament-server/src/server/realtime.rs` is still 1137 lines vs. the <700 completion target).
- BE-01: In progress status delta on 2026-02-15 (slices 40-43 completed: extracted subscribed-ack outbound enqueue handling into `apps/filament-server/src/server/realtime/subscribe_ack.rs`, extracted hydration attachment/reaction merge into `apps/filament-server/src/server/realtime/hydration_merge.rs`, extracted in-memory message record/response construction into `apps/filament-server/src/server/realtime/message_record.rs`, extracted offline presence-update event planning on disconnect into `apps/filament-server/src/server/realtime/presence_disconnect_events.rs`, and rewired `apps/filament-server/src/server/realtime.rs` to delegate all four paths while preserving fail-closed queue rejection handling and existing disconnect/presence semantics; BE-01 remains open because `apps/filament-server/src/server/realtime.rs` is still 1142 lines vs. the <700 completion target).
- BE-01: In progress status delta on 2026-02-15 (slices 44-46 completed: extracted DB indexed-message row mapping into `apps/filament-server/src/server/realtime/search_collect_db.rs`, extracted DB hydration row fetch+mapping into `apps/filament-server/src/server/realtime/hydration_db.rs`, extracted DB message-create response construction into `apps/filament-server/src/server/realtime/message_create_response.rs`, and rewired `apps/filament-server/src/server/realtime.rs` to delegate all three paths while preserving fail-closed DB/internal error mapping and boundary validation semantics; BE-01 remains open because `apps/filament-server/src/server/realtime.rs` is still 1056 lines vs. the <700 completion target).
- BE-01: In progress status delta on 2026-02-16 (slices 47-50 completed: extracted subscription insertion into `apps/filament-server/src/server/realtime/subscription_insert.rs`, extracted connection state removal into `apps/filament-server/src/server/realtime/connection_registry.rs`, extracted in-memory hydration attachment assignment into `apps/filament-server/src/server/realtime/hydration_in_memory_attachments.rs`, expanded `apps/filament-server/src/server/realtime/presence_subscribe.rs` with online-transition update planning, and rewired `apps/filament-server/src/server/realtime.rs` to delegate all four paths while preserving fail-closed enqueue/drop behavior and presence scoping semantics; BE-01 remains open because `apps/filament-server/src/server/realtime.rs` is still 1053 lines vs. the <700 completion target).
- BE-01: In progress status delta on 2026-02-16 (slices 51-54 completed: expanded `apps/filament-server/src/server/realtime/voice_presence.rs` with typed voice-sync enqueue outcome mapping, expanded `apps/filament-server/src/server/realtime/presence_subscribe.rs` with typed presence-sync enqueue outcome mapping, extracted channel fanout key dispatch/prune flow into `apps/filament-server/src/server/realtime/fanout_channel.rs`, expanded `apps/filament-server/src/server/realtime/search_collect_db.rs` with fail-closed guild DB fetch-limit and result-cap helpers, and rewired `apps/filament-server/src/server/realtime.rs` to delegate all four paths while preserving fail-closed queue/cap semantics; BE-01 remains open because `apps/filament-server/src/server/realtime.rs` is still 1053 lines vs. the <700 completion target).
- BE-01: In progress status delta on 2026-02-16 (slices 55-57 completed: extracted ingress command parse-failure classification into `apps/filament-server/src/server/realtime/ingress_parse.rs`, extracted subscribe command execution into `apps/filament-server/src/server/realtime/ingress_subscribe.rs`, extracted message-create command execution into `apps/filament-server/src/server/realtime/ingress_message_create.rs`, and rewired `apps/filament-server/src/server/realtime.rs` ingress handling to delegate all three paths while preserving fail-closed parse rejection, unknown-event accounting, IP-ban enforcement, channel-permission checks, and outbound-queue rejection behavior; BE-01 remains open because `apps/filament-server/src/server/realtime.rs` is still 984 lines vs. the <700 completion target).
- BE-01: In progress status delta on 2026-02-16 (slices 58-60 completed: extracted voice-sync outbound enqueue outcome handling into `apps/filament-server/src/server/realtime/voice_sync_dispatch.rs`, extracted presence-sync outbound enqueue outcome handling into `apps/filament-server/src/server/realtime/presence_sync_dispatch.rs`, extracted shared search query normalization/effective-limit boundary helpers into `apps/filament-server/src/server/realtime/search_query_input.rs`, and rewired `apps/filament-server/src/server/realtime.rs` to delegate all three paths while preserving fail-closed queue-drop accounting and search boundary validation semantics; BE-01 remains open because `apps/filament-server/src/server/realtime.rs` is still 959 lines vs. the <700 completion target).
- BE-01: In progress status delta on 2026-02-16 (slices 61-62 completed: extracted voice cleanup planning orchestration into `apps/filament-server/src/server/realtime/voice_cleanup_registry.rs` for both expired participant cleanup and disconnected-user cleanup, rewired `apps/filament-server/src/server/realtime.rs` to delegate both call sites under existing locks, and added focused unit coverage for parseable channel-key event planning, target-user-only removal planning, and malformed-key fail-closed discard behavior; BE-01 remains open because `apps/filament-server/src/server/realtime.rs` is still 957 lines vs. the <700 completion target).
- BE-01: In progress status delta on 2026-02-16 (slices 63-64 completed: extracted in-memory message channel append mutation into `apps/filament-server/src/server/realtime/message_store_in_memory.rs`, extracted shared message-create broadcast+search-upsert orchestration into `apps/filament-server/src/server/realtime/message_emit.rs`, and rewired both DB and in-memory paths in `apps/filament-server/src/server/realtime.rs` to delegate these helpers while preserving fail-closed not-found channel/guild handling and existing message-create fanout/indexing semantics; BE-01 remains open because `apps/filament-server/src/server/realtime.rs` is still 942 lines vs. the <700 completion target).
- BE-01: In progress status delta on 2026-02-16 (slices 65-68 completed: extracted disconnect follow-up planning into `apps/filament-server/src/server/realtime/connection_disconnect_followups.rs`, extracted voice subscribe sync-event builder into `apps/filament-server/src/server/realtime/voice_subscribe_sync.rs`, extracted presence subscribe snapshot/online-event planning into `apps/filament-server/src/server/realtime/presence_subscribe_events.rs`, extracted search bootstrap rebuild-op construction into `apps/filament-server/src/server/realtime/search_bootstrap.rs`, and rewired `apps/filament-server/src/server/realtime.rs` to delegate all four paths while preserving fail-closed disconnect cleanup, bounded outbound enqueue handling, and existing search bootstrap semantics; BE-01 remains open because `apps/filament-server/src/server/realtime.rs` is still 954 lines vs. the <700 completion target).
- BE-01: In progress status delta on 2026-02-16 (slices 69-70 completed: extracted shared gateway delivery metrics emission into `apps/filament-server/src/server/realtime/emit_metrics.rs`, extracted voice cleanup broadcast orchestration into `apps/filament-server/src/server/realtime/voice_cleanup_dispatch.rs`, and rewired `apps/filament-server/src/server/realtime.rs` to delegate all touched paths while preserving fail-closed queue-close signaling and voice cleanup broadcast semantics; BE-01 remains open because `apps/filament-server/src/server/realtime.rs` is still 914 lines vs. the <700 completion target).
- BE-01: In progress status delta on 2026-02-16 (slices 71-73 completed: extracted search index-id lookup orchestration into `apps/filament-server/src/server/realtime/search_index_lookup.rs`, extracted search query run-input normalization + timeout-wrapped index execution orchestration into `apps/filament-server/src/server/realtime/search_query_run.rs`, extracted reconciliation planning orchestration into `apps/filament-server/src/server/realtime/search_reconciliation_plan.rs`, and rewired `apps/filament-server/src/server/realtime.rs` to delegate/re-export all three paths while preserving fail-closed timeout/internal error mapping and existing search reconciliation semantics; BE-01 remains open because `apps/filament-server/src/server/realtime.rs` is still 870 lines vs. the <700 completion target).
- BE-01: In progress status delta on 2026-02-16 (slices 74-76 completed: extracted DB/in-memory search collection orchestration into `apps/filament-server/src/server/realtime/search_collect_runtime.rs`, extracted DB/in-memory hydration orchestration into `apps/filament-server/src/server/realtime/hydration_runtime.rs`, expanded `apps/filament-server/src/server/realtime/search_query_input.rs` with fail-closed request validation orchestration, and rewired `apps/filament-server/src/server/realtime.rs` to delegate all three paths while preserving boundary validation and cap enforcement semantics; BE-01 remains open because `apps/filament-server/src/server/realtime.rs` is still 805 lines vs. the <700 completion target).

### Recommended Iteration Order (Backend)
1. BE-01 Realtime module decomposition
2. BE-02 Event emitter modularization
3. BE-03 Domain service extraction
4. BE-05 Test topology split (parallel with BE-01..03)
5. BE-04 DB migration/repository separation
6. BE-06 Contract drift guardrails
7. BE-07 AppState componentization

### Backend Iteration Log
- 2026-02-12: Initial objective backend assessment captured; no server behavior changed in this pass.
- 2026-02-15: BE-01 slice 1 completed. Extracted ingress rate-limit window handling from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/ingress_rate_limit.rs` and added focused unit tests covering under-limit allow, at-limit reject, and expired-entry eviction behavior. Targeted validation passed (`cargo test -p filament-server ingress_rate_limit` -> 3 passed, 0 failed).
- 2026-02-15: BE-01 slice 2 completed. Extracted websocket ingress message decoding (text/binary payload caps plus close/ping handling) from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/ingress_message.rs` and added focused unit tests for payload decode, oversized binary fail-closed disconnect, close disconnect reason mapping, and ping passthrough. Targeted validation passed (`cargo test -p filament-server ingress_message` -> 4 passed, 0 failed).
- 2026-02-15: BE-01 slice 3 completed. Extracted channel gateway fanout dispatch helper from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/fanout_dispatch.rs` and added focused unit tests covering open-listener delivery, full-queue slow-consumer marking, and closed-listener pruning behavior. Targeted validation passed (`cargo test -p filament-server fanout_dispatch -- --nocapture` -> 2 passed, 0 failed) and existing guild fanout behavior remained green (`cargo test -p filament-server guild_broadcast_delivers_once_per_connection_and_skips_other_guilds -- --nocapture` -> 1 passed, 0 failed).
- 2026-02-15: BE-01 slice 4 completed. Extracted voice presence helper functions (`voice_channel_key`, `voice_snapshot_from_record`) from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/voice_presence.rs` and added focused unit tests for namespaced key derivation and snapshot field mapping integrity. Targeted validation passed (`cargo test -p filament-server voice_presence -- --nocapture` -> 2 passed, 0 failed) and a focused existing voice integration check remained green (`cargo test -p filament-server --test phase5_livekit_voice voice_token_is_scoped_signed_and_short_lived -- --nocapture` -> 1 passed, 0 failed).
- 2026-02-15: BE-01 slice 5 completed. Extracted guild fanout dispatch and stale-listener pruning from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/fanout_guild.rs` with focused unit tests for per-connection dedupe across guild channels and closed/full queue handling. Targeted validation passed (`cargo test -p filament-server fanout_guild -- --nocapture` -> 2 passed, 0 failed).
- 2026-02-15: BE-01 slice 6 completed. Extracted user fanout dispatch and sender pruning from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/fanout_user.rs` with focused unit tests for targeted delivery and closed/full queue handling. Targeted validation passed (`cargo test -p filament-server fanout_user -- --nocapture` -> 2 passed, 0 failed).
- 2026-02-15: BE-01 slice 7 completed. Extracted presence subscribe transition logic from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/presence_subscribe.rs` with focused unit tests for first-online detection, already-online behavior, and missing-connection fail-closed handling. Targeted validation passed (`cargo test -p filament-server presence_subscribe -- --nocapture` -> 3 passed, 0 failed).
- 2026-02-15: BE-01 slice 8 completed. Extracted disconnect presence outcome logic from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/presence_disconnect.rs` with focused unit tests for offline guild detection and same-user/other-user connection separation. Targeted validation passed (`cargo test -p filament-server presence_disconnect -- --nocapture` -> 3 passed, 0 failed) and focused existing fanout/presence behavior remained green (`cargo test -p filament-server guild_broadcast_delivers_once_per_connection_and_skips_other_guilds -- --nocapture && cargo test -p filament-server user_broadcast_targets_only_requested_authenticated_user -- --nocapture && cargo test -p filament-server --test phase4_roles_presence_reactions presence_events_do_not_leak_across_guilds -- --nocapture` -> 3 passed, 0 failed).
- 2026-02-15: BE-01 slice 9 completed. Extracted slow-consumer close signaling from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/connection_control.rs` and added focused unit coverage for targeted/registered connection close signaling behavior. Targeted validation passed (`cargo test -p filament-server connection_control -- --nocapture` -> 1 passed, 0 failed).
- 2026-02-15: BE-01 slice 10 completed. Extracted voice registry mutation helpers from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/voice_registry.rs` and added focused unit coverage for expired participant pruning and disconnected-user participant removal with empty-channel pruning. Targeted validation passed (`cargo test -p filament-server voice_registry -- --nocapture` -> 2 passed, 0 failed).
- 2026-02-15: BE-01 slice 11 completed. Expanded `apps/filament-server/src/server/realtime/voice_presence.rs` with voice channel snapshot collection/sorting and rewired `handle_voice_subscribe` in `apps/filament-server/src/server/realtime.rs` to delegate the snapshot path. Targeted validation passed (`cargo test -p filament-server voice_presence -- --nocapture` -> 4 passed, 0 failed) and focused existing presence behavior remained green (`cargo test -p filament-server --test phase4_roles_presence_reactions presence_events_do_not_leak_across_guilds -- --nocapture` -> 1 passed, 0 failed).
- 2026-02-15: BE-01 slice 12 completed. Extracted search query abuse-limit validation from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/search_validation.rs` and rewired `validate_search_query` to delegate the boundary check helper. Targeted validation passed (`cargo test -p filament-server search_validation -- --nocapture` -> 4 passed, 0 failed) and focused existing voice integration behavior remained green (`cargo test -p filament-server --test phase5_livekit_voice voice_token_is_scoped_signed_and_short_lived -- --nocapture` -> 1 passed, 0 failed).
- 2026-02-15: BE-01 slice 13 completed. Extracted voice participant registration transition/cap checks from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/voice_registration.rs` (including move-between-channel, per-channel cap, and tracked-channel cap logic) and rewired `register_voice_participant_from_token` to delegate the state mutation path under lock. Targeted validation passed (`cargo test -p filament-server voice_registration -- --nocapture` -> 4 passed, 0 failed).
- 2026-02-15: BE-01 slice 14 completed. Extracted search reconciliation diff planning from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/search_reconcile.rs` and rewired `plan_search_reconciliation` to delegate sorting/upsert/delete set computation. Targeted validation passed (`cargo test -p filament-server search_reconcile -- --nocapture && cargo test -p filament-server --test phase3_search search_reconcile_reports_noop_when_index_is_consistent -- --nocapture` -> unit: 2 passed, 0 failed; integration: 1 passed, 0 failed).
- 2026-02-15: BE-01 slice 15 completed. Extracted hydrated message ordering helper from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/hydration_order.rs` and rewired both DB and in-memory `hydrate_messages_by_id` branches to delegate request-order assembly. Targeted validation passed (`cargo test -p filament-server hydration_order -- --nocapture && cargo test -p filament-server --test phase3_search search_indexes_create_edit_delete_and_rebuild_paths -- --nocapture` -> unit: 2 passed, 0 failed; integration: 1 passed, 0 failed).
- 2026-02-15: BE-01 slice 16 completed. Expanded `apps/filament-server/src/server/realtime/voice_registry.rs` with parse-validated expired-removal planning (`take_expired_voice_participant_removals`) and rewired expired voice participant cleanup in `apps/filament-server/src/server/realtime.rs` to consume typed removals while dropping malformed channel keys fail-closed. Targeted validation passed (`cargo test -p filament-server voice_registry -- --nocapture` -> 3 passed, 0 failed).
- 2026-02-15: BE-01 slice 17 completed. Expanded `apps/filament-server/src/server/realtime/voice_registry.rs` with parse-validated disconnected-user removal planning (`remove_user_voice_participant_removals`) and rewired disconnected user voice cleanup in `apps/filament-server/src/server/realtime.rs` to consume typed removals while dropping malformed channel keys fail-closed. Targeted validation passed (`cargo test -p filament-server voice_registry -- --nocapture` -> 4 passed, 0 failed).
- 2026-02-15: BE-01 slice 18 completed. Expanded `apps/filament-server/src/server/realtime/voice_presence.rs` with `try_enqueue_voice_sync_event` and explicit enqueue outcome typing, then rewired `handle_voice_subscribe` in `apps/filament-server/src/server/realtime.rs` to delegate drop/full/closed handling without changing metrics behavior. Targeted validation passed (`cargo test -p filament-server voice_presence -- --nocapture` -> 7 passed, 0 failed).
- 2026-02-15: BE-01 slice 19 completed. Expanded `apps/filament-server/src/server/realtime/presence_subscribe.rs` with `try_enqueue_presence_sync_event` and explicit enqueue outcome typing, then rewired `handle_presence_subscribe` in `apps/filament-server/src/server/realtime.rs` to delegate drop/full/closed handling. Targeted validation passed (`cargo test -p filament-server presence_subscribe -- --nocapture && cargo test -p filament-server --test phase4_roles_presence_reactions presence_events_do_not_leak_across_guilds -- --nocapture && cargo test -p filament-server --test phase5_livekit_voice voice_token_is_scoped_signed_and_short_lived -- --nocapture` -> unit: 6 passed, 0 failed; integration: 2 passed, 0 failed).
- 2026-02-15: BE-01 slice 20 completed. Extracted in-memory all-guild indexed-message collection from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/search_collect_all.rs` and rewired `collect_all_indexed_messages` to delegate the in-memory path. Targeted validation passed (`cargo test -p filament-server search_collect_all -- --nocapture` -> 1 passed, 0 failed).
- 2026-02-15: BE-01 slice 21 completed. Extracted in-memory guild-scoped indexed-message collection from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/search_collect_guild.rs` (including fail-closed max-doc cap and missing-guild handling) and rewired `collect_indexed_messages_for_guild` to delegate the in-memory path. Targeted validation passed (`cargo test -p filament-server search_collect_guild -- --nocapture` -> 3 passed, 0 failed).
- 2026-02-15: BE-01 slice 22 completed. Extracted `indexed_message_from_response` from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/search_indexed_message.rs`, restored a thin compatibility wrapper in `apps/filament-server/src/server/realtime.rs`, and kept call sites unchanged. Targeted validation passed (`cargo test -p filament-server search_indexed_message -- --nocapture && cargo test -p filament-server --test phase3_search search_reconcile_reports_noop_when_index_is_consistent -- --nocapture` -> unit: 1 passed, 0 failed; integration: 1 passed, 0 failed).
- 2026-02-15: BE-01 slice 23 completed. Extracted guild-scoped search index message-id collection/count-cap enforcement from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/search_collect_index_ids.rs` and rewired `collect_index_message_ids_for_guild` to delegate the spawn-blocking index read path. Targeted validation passed (`cargo test -p filament-server search_collect_index_ids -- --nocapture` -> 2 passed, 0 failed).
- 2026-02-15: BE-01 slice 24 completed. Extracted search query parse/boolean-filter/top-doc execution from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/search_query_exec.rs` and rewired `run_search_query` to delegate execution while preserving timeout-wrapped fail-closed invalid-query behavior. Targeted validation passed (`cargo test -p filament-server search_query_exec -- --nocapture && cargo test -p filament-server --test phase3_search search_reconcile_reports_noop_when_index_is_consistent -- --nocapture` -> unit: 2 passed, 0 failed; integration: 1 passed, 0 failed).
- 2026-02-15: BE-01 slice 25 completed. Extracted gateway ingress event-to-command parsing from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/ingress_command.rs` and rewired the ingress loop to handle typed parse outcomes while preserving fail-closed disconnect reasons and unknown-event metric tagging. Targeted validation passed (`cargo test -p filament-server ingress_command -- --nocapture` -> 4 passed, 0 failed).
- 2026-02-15: BE-01 slice 26 completed. Extracted voice participant cleanup event planning from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/voice_cleanup_events.rs` and rewired expired/disconnected cleanup paths to broadcast planned events without changing existing unpublish/leave semantics. Targeted validation passed (`cargo test -p filament-server voice_cleanup_events -- --nocapture` -> 2 passed, 0 failed).
- 2026-02-15: BE-01 slice 27 completed. Extracted authenticated-user connection target selection from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/fanout_user_targets.rs` and rewired `broadcast_user_event` to delegate connection-id selection before sender dispatch. Targeted validation passed (`cargo test -p filament-server fanout_user_targets -- --nocapture && cargo test -p filament-server --test gateway_network_flow gateway_ingress_rejections_and_unknown_events_are_counted_in_metrics -- --nocapture` -> unit: 2 passed, 0 failed; integration: 1 passed, 0 failed).
- 2026-02-15: BE-01 slice 28 completed. Extracted search schema construction from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/search_schema.rs`, added focused unit coverage for expected field registration and `created_at_unix` typing, and rewired `build_search_schema` in `apps/filament-server/src/server/realtime.rs` to delegate through a thin compatibility wrapper. Targeted validation passed (`cargo test -p filament-server search_schema -- --nocapture` -> 2 passed, 0 failed).
- 2026-02-15: BE-01 slice 29 completed. Extracted search index operation application from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/search_apply.rs`, added focused unit coverage for upsert replacement, delete removal, and reconcile upsert/delete behavior, and rewired `apply_search_operation` in `apps/filament-server/src/server/realtime.rs` to delegate through a thin compatibility wrapper. Targeted validation passed (`cargo test -p filament-server search_apply -- --nocapture && cargo test -p filament-server --test phase3_search search_reconcile_reports_noop_when_index_is_consistent -- --nocapture` -> unit: 3 passed, 0 failed; integration: 1 passed, 0 failed).
- 2026-02-15: BE-01 slice 30 completed. Extracted message body validation/tokenization preparation from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/message_prepare.rs`, rewired `create_message_internal` to delegate empty-content/attachment gate and markdown token generation, and added focused unit coverage for empty/no-attachment rejection, empty/attachment acceptance, non-empty tokenization, and oversize fail-closed behavior. Targeted validation passed (`cargo test -p filament-server message_prepare -- --nocapture` -> 4 passed, 0 failed).
- 2026-02-15: BE-01 slice 31 completed. Extracted in-memory attachment ownership/context/already-bound validation from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/message_attachment_bind.rs`, rewired `create_message_internal` attachment mutation to delegate under lock, and added focused unit coverage for successful multi-attachment binding plus missing/invalid-owner/already-bound fail-closed paths. Targeted validation passed (`cargo test -p filament-server message_attachment_bind -- --nocapture` -> 3 passed, 0 failed).
- 2026-02-15: BE-01 slice 32 completed. Extracted timeout-wrapped spawn-blocking execution into `apps/filament-server/src/server/realtime/search_blocking.rs`, rewired both `collect_index_message_ids_for_guild` and `run_search_query` in `apps/filament-server/src/server/realtime.rs` to delegate timeout/internal failure mapping through the helper, and added focused unit coverage for success, timeout fail-closed, and panic-to-internal mapping semantics. Targeted validation passed (`cargo test -p filament-server search_blocking -- --nocapture && cargo test -p filament-server --test phase3_search search_reconcile_reports_noop_when_index_is_consistent -- --nocapture` -> unit: 3 passed, 0 failed; integration: 1 passed, 0 failed).
- 2026-02-15: BE-01 slice 33 completed. Extracted voice registration event planning from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/voice_registration_events.rs`, rewired `register_voice_participant_from_token` to broadcast planned events, and added focused unit coverage for malformed prior-channel key fail-closed handling plus join/update/publish/unpublish/leave event planning. Targeted validation passed (`cargo test -p filament-server voice_registration_events -- --nocapture` -> 2 passed, 0 failed).
- 2026-02-15: BE-01 slice 34 completed. Extracted in-memory hydration response-map collection from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/hydration_in_memory.rs`, rewired `hydrate_messages_by_id` in-memory flow to delegate collection, and added focused unit coverage for channel-scoped collection, all-channel collection, and missing-channel fail-closed behavior. Targeted validation passed (`cargo test -p filament-server hydration_in_memory -- --nocapture` -> 3 passed, 0 failed).
- 2026-02-15: BE-01 slice 35 completed. Extracted subscription-pruning on disconnect from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/connection_subscriptions.rs`, rewired `remove_connection` to delegate listener removal and empty-subscription pruning, and added focused unit coverage for empty-key pruning and remaining-listener retention. Targeted validation passed (`cargo test -p filament-server connection_subscriptions -- --nocapture` -> 2 passed, 0 failed).
- 2026-02-15: BE-01 slice 36 completed. Extracted search worker queue batch-drain logic from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/search_batch_drain.rs`, rewired `init_search_service` worker loop to delegate bounded drain behavior, and added focused unit coverage for max-batch enforcement and zero-cap fail-closed single-item behavior. Targeted validation passed (`cargo test -p filament-server search_batch_drain -- --nocapture` -> 2 passed, 0 failed).
- 2026-02-15: BE-01 slice 37 completed. Extracted search queue enqueue/ack handling from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/search_enqueue.rs`, rewired `enqueue_search_operation` to delegate send/ack wait logic, and added focused unit coverage for no-ack enqueue, ack-success wait, ack-closed fail-closed internal mapping, and sender-closed fail-closed internal mapping. Targeted validation passed (`cargo test -p filament-server search_enqueue -- --nocapture` -> 4 passed, 0 failed).
- 2026-02-15: BE-01 slice 38 completed. Extracted search batch apply + ack fanout flow from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/search_apply_batch.rs`, rewired `apply_search_batch` to delegate operation application with ack propagation, and added focused unit coverage for successful apply ack delivery and writer-lock failure fail-closed internal ack mapping. Targeted validation passed (`cargo test -p filament-server search_apply_batch -- --nocapture` -> 2 passed, 0 failed).
- 2026-02-15: BE-01 slice 39 completed. Expanded `apps/filament-server/src/server/realtime/voice_cleanup_events.rs` with shared `plan_voice_removal_broadcasts` planning, rewired both expired and disconnected voice cleanup paths in `apps/filament-server/src/server/realtime.rs` to delegate channel/event planning, and added focused unit coverage for per-channel broadcast tuple generation with unpublish/leave ordering. Targeted validation passed (`cargo test -p filament-server voice_cleanup_events -- --nocapture` -> 3 passed, 0 failed).
- 2026-02-15: BE-01 slice 40 completed. Extracted subscribed acknowledgement outbound enqueue handling from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/subscribe_ack.rs`, rewired subscribe flow to consume typed enqueue outcomes, and added focused unit coverage for queue-capacity success and fail-closed full/closed rejection behavior. Targeted validation passed (`cargo test -p filament-server subscribe_ack -- --nocapture` -> 2 passed, 0 failed).
- 2026-02-15: BE-01 slice 41 completed. Extracted DB hydration attachment/reaction merge application from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/hydration_merge.rs`, rewired hydration to delegate map-merge behavior, and added focused unit coverage for per-message attachment/reaction mapping. Targeted validation passed (`cargo test -p filament-server hydration_merge -- --nocapture` -> 1 passed, 0 failed).
- 2026-02-15: BE-01 slice 42 completed. Extracted in-memory message record and response construction from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/message_record.rs`, rewired in-memory create-message flow to delegate record/response mapping, and added focused unit coverage for empty reaction initialization and response field mapping integrity. Targeted validation passed (`cargo test -p filament-server message_record -- --nocapture` -> 2 passed, 0 failed).
- 2026-02-15: BE-01 slice 43 completed. Extracted offline disconnect presence-update event planning from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/presence_disconnect_events.rs`, rewired disconnect flow to delegate offline update planning, and added focused unit coverage for per-guild update generation and empty-input no-op behavior. Targeted validation passed (`cargo test -p filament-server presence_disconnect_events -- --nocapture` -> 2 passed, 0 failed).
- 2026-02-15: BE-01 slice 44 completed. Extracted DB indexed-message tuple-to-domain mapping from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/search_collect_db.rs`, rewired both DB `collect_all_indexed_messages` and DB guild-scoped `collect_indexed_messages_for_guild` paths to delegate typed-row mapping, and added focused unit coverage for full field mapping plus row-order preservation. Targeted validation passed (`cargo test -p filament-server search_collect_db -- --nocapture` -> 2 passed, 0 failed).
- 2026-02-15: BE-01 slice 45 completed. Extracted DB hydration row fetch+mapping from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/hydration_db.rs`, rewired DB `hydrate_messages_by_id` to delegate optional-channel query selection and markdown-token hydration map construction, and added focused unit coverage for tokenized mapping integrity plus duplicate-id last-row overwrite behavior. Targeted validation passed (`cargo test -p filament-server hydration_db -- --nocapture` -> 2 passed, 0 failed).
- 2026-02-15: BE-01 slice 46 completed. Extracted DB create-message response construction from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/message_create_response.rs`, rewired DB `create_message_internal` response build path to delegate through the helper, and added focused unit coverage for field mapping and fail-closed empty-reaction initialization. Targeted validation passed (`cargo test -p filament-server message_create_response -- --nocapture && cargo test -p filament-server --test phase3_search search_reconcile_reports_noop_when_index_is_consistent -- --nocapture` -> unit: 1 passed, 0 failed; integration: 1 passed, 0 failed).
- 2026-02-16: BE-01 slice 47 completed. Extracted subscription insertion from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/subscription_insert.rs`, rewired `add_subscription` to delegate map insertion, and added focused unit coverage for new-key insertion and existing-key multi-connection retention. Targeted validation passed (`cargo test -p filament-server subscription_insert -- --nocapture` -> unit: 2 passed, 0 failed).
- 2026-02-16: BE-01 slice 48 completed. Extracted connection presence/control/sender removal from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/connection_registry.rs`, rewired `remove_connection` to delegate state pruning under lock, and added focused unit coverage for full-state removal and missing-presence fail-closed pruning of residual maps. Targeted validation passed (`cargo test -p filament-server connection_registry -- --nocapture` -> unit: 2 passed, 0 failed).
- 2026-02-16: BE-01 slice 49 completed. Extracted in-memory hydration attachment assignment from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/hydration_in_memory_attachments.rs`, rewired `hydrate_messages_by_id` in-memory branch to delegate attachment-map application, and added focused unit coverage for mapped attachment assignment and missing-entry fail-closed empty attachment behavior. Targeted validation passed (`cargo test -p filament-server hydration_in_memory_attachments -- --nocapture` -> unit: 2 passed, 0 failed).
- 2026-02-16: BE-01 slice 50 completed. Expanded `apps/filament-server/src/server/realtime/presence_subscribe.rs` with online-transition presence update planning, rewired `handle_presence_subscribe` in `apps/filament-server/src/server/realtime.rs` to delegate update creation, and added focused unit coverage for online-only emission and non-transition no-op behavior. Targeted validation passed (`cargo test -p filament-server presence_subscribe -- --nocapture && cargo test -p filament-server channel_broadcast_targets_only_matching_subscription_key -- --nocapture && cargo test -p filament-server --test phase4_roles_presence_reactions presence_events_do_not_leak_across_guilds -- --nocapture` -> unit: 8 passed, 0 failed; integration: 2 passed, 0 failed).
- 2026-02-16: BE-01 slices 51-54 completed. Expanded `apps/filament-server/src/server/realtime/voice_presence.rs` with `voice_sync_dispatch_outcome` mapping and added focused unit coverage for all enqueue outcomes, expanded `apps/filament-server/src/server/realtime/presence_subscribe.rs` with `presence_sync_dispatch_outcome` mapping and added focused unit coverage for all enqueue outcomes, extracted channel fanout dispatch/prune state handling from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/fanout_channel.rs` with focused unit coverage for delivery and closed/full-listener pruning behavior, expanded `apps/filament-server/src/server/realtime/search_collect_db.rs` with fail-closed DB fetch-limit and doc-cap helpers plus focused unit coverage, and rewired call sites in `apps/filament-server/src/server/realtime.rs` with unchanged fail-closed behavior. Targeted validation passed (`cargo test -p filament-server voice_presence -- --nocapture && cargo test -p filament-server presence_subscribe -- --nocapture && cargo test -p filament-server fanout_channel -- --nocapture && cargo test -p filament-server search_collect_db -- --nocapture && cargo test -p filament-server channel_broadcast_targets_only_matching_subscription_key -- --nocapture` -> voice_presence: 8 passed, 0 failed; presence_subscribe: 9 passed, 0 failed; fanout_channel: 2 passed, 0 failed; search_collect_db: 4 passed, 0 failed; focused regression: 1 passed, 0 failed).
- 2026-02-16: BE-01 slices 55-57 completed. Extracted ingress parse-failure classification from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/ingress_parse.rs` with focused unit coverage for invalid-subscribe, invalid-message-create, and unknown-event classification; extracted subscribe command execution from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/ingress_subscribe.rs` with focused unit coverage for subscribe-ack rejection detection; extracted message-create command execution from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/ingress_message_create.rs` with focused unit coverage for attachment-id normalization. Rewired ingress call sites in `apps/filament-server/src/server/realtime.rs` to delegate all three paths with unchanged fail-closed disconnect reasons and metrics accounting. Targeted validation passed (`cargo test -p filament-server ingress_parse -- --nocapture && cargo test -p filament-server ingress_subscribe -- --nocapture && cargo test -p filament-server ingress_message_create -- --nocapture && cargo test -p filament-server --test gateway_network_flow gateway_ingress_rejections_and_unknown_events_are_counted_in_metrics -- --nocapture` -> ingress_parse: 3 passed, 0 failed; ingress_subscribe: 2 passed, 0 failed; ingress_message_create: 2 passed, 0 failed; focused regression: 1 passed, 0 failed).
- 2026-02-16: BE-01 slices 58-60 completed. Extracted voice-sync dispatch+metrics handling from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/voice_sync_dispatch.rs` with focused unit coverage for enqueued/full/closed queue outcomes; extracted presence-sync dispatch+metrics handling from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/presence_sync_dispatch.rs` with focused unit coverage for enqueued/full/closed queue outcomes; extracted shared query boundary helpers into `apps/filament-server/src/server/realtime/search_query_input.rs` and rewired both `validate_search_query` and `run_search_query` in `apps/filament-server/src/server/realtime.rs` to consume normalized query/effective-limit values. Targeted validation passed (`cargo test -p filament-server voice_sync_dispatch -- --nocapture && cargo test -p filament-server presence_sync_dispatch -- --nocapture && cargo test -p filament-server search_query_input -- --nocapture && cargo test -p filament-server --test gateway_network_flow gateway_ingress_rejections_and_unknown_events_are_counted_in_metrics -- --nocapture` -> voice_sync_dispatch: 4 passed, 0 failed; presence_sync_dispatch: 4 passed, 0 failed; search_query_input: 4 passed, 0 failed; focused regression: 1 passed, 0 failed).
- 2026-02-16: BE-01 slices 61-62 completed. Extracted voice cleanup planning orchestration from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/voice_cleanup_registry.rs` (expired cleanup and disconnected-user cleanup), rewired `prune_expired_voice_participants` and `remove_disconnected_user_voice_participants` in `apps/filament-server/src/server/realtime.rs` to delegate while preserving fail-closed malformed-key discard behavior, and added focused unit coverage for parseable key planning, malformed key discard, and target-user-only disconnected cleanup planning. Targeted validation passed (`cargo test -p filament-server voice_cleanup_registry -- --nocapture` -> 4 passed, 0 failed; `cargo test -p filament-server --test phase5_livekit_voice voice_token_is_scoped_signed_and_short_lived -- --nocapture` -> 1 passed, 0 failed).
- 2026-02-16: BE-01 slices 63-64 completed. Extracted in-memory message append mutation from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/message_store_in_memory.rs` with focused unit coverage for successful append and fail-closed missing guild/channel rejection; extracted shared message-create broadcast+search-upsert orchestration into `apps/filament-server/src/server/realtime/message_emit.rs` with focused unit coverage for response-to-upsert mapping; rewired both DB and in-memory `create_message_internal` paths in `apps/filament-server/src/server/realtime.rs` to delegate these helpers with unchanged fail-closed behavior. Targeted validation passed (`cargo test -p filament-server message_store_in_memory -- --nocapture && cargo test -p filament-server message_emit -- --nocapture && cargo test -p filament-server gateway_broadcasts_message_to_subscribed_connection -- --nocapture` -> message_store_in_memory: 2 passed, 0 failed; message_emit: 1 passed, 0 failed; focused regression: 1 passed, 0 failed).
- 2026-02-16: BE-01 slices 65-68 completed. Extracted disconnect follow-up planning from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/connection_disconnect_followups.rs` with focused unit coverage for offline voice-cleanup gating and offline presence-update planning; extracted voice subscribe sync-event construction into `apps/filament-server/src/server/realtime/voice_subscribe_sync.rs` with focused unit coverage for populated and empty participant snapshots; extracted presence subscribe snapshot/online-event planning into `apps/filament-server/src/server/realtime/presence_subscribe_events.rs` with focused unit coverage for online transition emission, non-transition no-op, and snapshot membership preservation; extracted search bootstrap rebuild-operation construction into `apps/filament-server/src/server/realtime/search_bootstrap.rs` with focused unit coverage for populated and empty rebuild docs; rewired call sites in `apps/filament-server/src/server/realtime.rs` and removed now-unused `build_presence_online_update` in `apps/filament-server/src/server/realtime/presence_subscribe.rs` with unchanged fail-closed behavior. Targeted validation passed (`cargo test -p filament-server connection_disconnect_followups -- --nocapture && cargo test -p filament-server voice_subscribe_sync -- --nocapture && cargo test -p filament-server presence_subscribe_events -- --nocapture && cargo test -p filament-server search_bootstrap -- --nocapture && cargo test -p filament-server --test gateway_network_flow gateway_ingress_rejections_and_unknown_events_are_counted_in_metrics -- --nocapture` -> connection_disconnect_followups: 2 passed, 0 failed; voice_subscribe_sync: 2 passed, 0 failed; presence_subscribe_events: 3 passed, 0 failed; search_bootstrap: 2 passed, 0 failed; focused regression: 1 passed, 0 failed).
- 2026-02-16: BE-01 slices 69-70 completed. Extracted shared gateway delivery metrics emission from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/emit_metrics.rs` with focused unit coverage for zero-delivery no-op and delivered-count handling; extracted voice cleanup broadcast orchestration from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/voice_cleanup_dispatch.rs` with focused unit coverage for empty/non-empty cleanup planning cardinality; rewired `broadcast_channel_event`, `broadcast_guild_event`, `broadcast_user_event`, `prune_expired_voice_participants`, and disconnected voice cleanup handling in `apps/filament-server/src/server/realtime.rs` to delegate with unchanged fail-closed behavior. Targeted validation passed (`cargo test -p filament-server emit_metrics -- --nocapture && cargo test -p filament-server voice_cleanup_dispatch -- --nocapture && cargo test -p filament-server --test gateway_network_flow gateway_ingress_rejections_and_unknown_events_are_counted_in_metrics -- --nocapture && cargo test -p filament-server --test phase5_livekit_voice voice_token_is_scoped_signed_and_short_lived -- --nocapture` -> emit_metrics: 2 passed, 0 failed; voice_cleanup_dispatch: 2 passed, 0 failed; gateway focused regression: 1 passed, 0 failed; voice focused regression: 1 passed, 0 failed).
- 2026-02-16: BE-01 slices 71-73 completed. Extracted search index-id lookup orchestration from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/search_index_lookup.rs` with focused unit coverage for lookup-input cloning/preservation; extracted search query run-input normalization + timeout-wrapped index execution orchestration into `apps/filament-server/src/server/realtime/search_query_run.rs` with focused unit coverage for trimmed query/channel-scope input shaping; extracted reconciliation planning orchestration into `apps/filament-server/src/server/realtime/search_reconciliation_plan.rs` with focused unit coverage for sorted upsert/delete outcomes and no-op matching-set behavior. Rewired `apps/filament-server/src/server/realtime.rs` to delegate/re-export all three paths with unchanged fail-closed timeout/internal mapping and search reconciliation behavior. Targeted validation passed (`cargo test -p filament-server search_index_lookup -- --nocapture && cargo test -p filament-server search_query_run -- --nocapture && cargo test -p filament-server search_reconciliation_plan -- --nocapture && cargo test -p filament-server --test phase3_search search_reconcile_reports_noop_when_index_is_consistent -- --nocapture` -> search_index_lookup: 2 passed, 0 failed; search_query_run: 2 passed, 0 failed; search_reconciliation_plan: 2 passed, 0 failed; focused regression: 1 passed, 0 failed).
- 2026-02-16: BE-01 slices 74-76 completed. Extracted DB/in-memory search collection orchestration from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/search_collect_runtime.rs` with focused unit coverage for row mapping order and fail-closed over-cap rejection; extracted DB/in-memory hydration orchestration from `apps/filament-server/src/server/realtime.rs` into `apps/filament-server/src/server/realtime/hydration_runtime.rs` with focused unit coverage for request-order assembly and missing-ID fail-closed omission behavior; expanded `apps/filament-server/src/server/realtime/search_query_input.rs` with `validate_search_query_request` orchestration and focused unit coverage for blank-query fail-closed rejection and default-limit behavior. Rewired `apps/filament-server/src/server/realtime.rs` to delegate all three paths with unchanged boundary validation and cap enforcement behavior. Targeted validation passed (`cargo test -p filament-server search_collect_runtime -- --nocapture && cargo test -p filament-server hydration_runtime -- --nocapture && cargo test -p filament-server search_query_input -- --nocapture && cargo test -p filament-server --test phase3_search search_reconcile_reports_noop_when_index_is_consistent -- --nocapture` -> search_collect_runtime: 2 passed, 0 failed; hydration_runtime: 2 passed, 0 failed; search_query_input: 6 passed, 0 failed; focused regression: 1 passed, 0 failed).
