services:
  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${FILAMENT_POSTGRES_USER:-filament}
      POSTGRES_PASSWORD: ${FILAMENT_POSTGRES_PASSWORD:-filament}
      POSTGRES_DB: ${FILAMENT_POSTGRES_DB:-filament}
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${FILAMENT_POSTGRES_USER:-filament} -d ${FILAMENT_POSTGRES_DB:-filament}",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - pg-data:/var/lib/postgresql/data
    networks:
      - filament-internal
    security_opt:
      - no-new-privileges:true

  livekit:
    image: livekit/livekit-server:v1.8.3
    restart: unless-stopped
    entrypoint:
      - /bin/sh
      - -ec
    environment:
      LIVEKIT_PORT: ${LIVEKIT_PORT:-7880}
      LIVEKIT_TCP_PORT: ${LIVEKIT_TCP_PORT:-7881}
      LIVEKIT_UDP_PORT: ${LIVEKIT_UDP_PORT:-7882}
      LIVEKIT_USE_EXTERNAL_IP: ${LIVEKIT_USE_EXTERNAL_IP:-false}
      LIVEKIT_NODE_IP: ${LIVEKIT_NODE_IP:-}
      FILAMENT_LIVEKIT_API_KEY: ${FILAMENT_LIVEKIT_API_KEY:-devkey}
      FILAMENT_LIVEKIT_API_SECRET: ${FILAMENT_LIVEKIT_API_SECRET:-devsecret}
    command:
      - |
        cat > /tmp/livekit.yaml <<EOF
        port: ${LIVEKIT_PORT}
        rtc:
          tcp_port: ${LIVEKIT_TCP_PORT}
          udp_port: ${LIVEKIT_UDP_PORT}
          use_external_ip: ${LIVEKIT_USE_EXTERNAL_IP}
        EOF
        if [ -n "${LIVEKIT_NODE_IP}" ]; then
          printf "  node_ip: %s\n" "${LIVEKIT_NODE_IP}" >> /tmp/livekit.yaml
        fi
        cat >> /tmp/livekit.yaml <<EOF
        keys:
          ${FILAMENT_LIVEKIT_API_KEY}: ${FILAMENT_LIVEKIT_API_SECRET}
        logging:
          level: info
        EOF
        exec /livekit-server --config /tmp/livekit.yaml
    ports:
      - "${LIVEKIT_PORT:-7880}:${LIVEKIT_PORT:-7880}"
      - "${LIVEKIT_TCP_PORT:-7881}:${LIVEKIT_TCP_PORT:-7881}"
      - "${LIVEKIT_UDP_PORT:-7882}:${LIVEKIT_UDP_PORT:-7882}/udp"
    networks:
      - filament-internal
      - filament-edge
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp

  filament-server:
    build:
      context: ..
      dockerfile: apps/filament-server/Dockerfile
    restart: unless-stopped
    environment:
      RUST_LOG: ${FILAMENT_RUST_LOG:-info}
      FILAMENT_BIND_ADDR: ${FILAMENT_BIND_ADDR:-0.0.0.0:3000}
      FILAMENT_MAX_CREATED_GUILDS_PER_USER: ${FILAMENT_MAX_CREATED_GUILDS_PER_USER:-5}
      FILAMENT_DATABASE_URL: ${FILAMENT_DATABASE_URL:-postgres://${FILAMENT_POSTGRES_USER:-filament}:${FILAMENT_POSTGRES_PASSWORD:-filament}@postgres:5432/${FILAMENT_POSTGRES_DB:-filament}}
      FILAMENT_ATTACHMENT_ROOT: ${FILAMENT_ATTACHMENT_ROOT:-/var/lib/filament/attachments}
      FILAMENT_LIVEKIT_API_KEY: ${FILAMENT_LIVEKIT_API_KEY:-devkey}
      FILAMENT_LIVEKIT_API_SECRET: ${FILAMENT_LIVEKIT_API_SECRET:-devsecret}
      FILAMENT_LIVEKIT_URL: ${FILAMENT_LIVEKIT_URL:-ws://localhost:7880}
      FILAMENT_HCAPTCHA_SITE_KEY: ${FILAMENT_HCAPTCHA_SITE_KEY:-}
      FILAMENT_HCAPTCHA_SECRET: ${FILAMENT_HCAPTCHA_SECRET:-}
    volumes:
      - filament-attachments:/var/lib/filament/attachments
    depends_on:
      postgres:
        condition: service_healthy
      livekit:
        condition: service_started
    networks:
      - filament-internal
      - filament-edge
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp

  # Optional bundled web client container.
  # Disabled by default; enable with: docker compose --profile web ...
  # When enabled, set CADDY_WEB_UPSTREAM=filament-web:4173 in infra/.env.
  filament-web:
    profiles: ["web"]
    build:
      context: ..
      dockerfile: apps/filament-client-web/Dockerfile
      args:
        VITE_FILAMENT_HCAPTCHA_SITE_KEY: ${VITE_FILAMENT_HCAPTCHA_SITE_KEY:-}
    restart: unless-stopped
    networks:
      - filament-internal
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp

  reverse-proxy:
    image: caddy:2.8.4-alpine
    restart: unless-stopped
    depends_on:
      filament-server:
        condition: service_started
    environment:
      CADDY_TLS_CERT_PATH: ${CADDY_TLS_CERT_PATH:-/etc/caddy/certs/cert.pem}
      CADDY_TLS_KEY_PATH: ${CADDY_TLS_KEY_PATH:-/etc/caddy/certs/key.pem}
      CADDY_HTTP_REDIRECT_HOSTS: ${CADDY_HTTP_REDIRECT_HOSTS:-filamentapp.net app.filament.local api.filament.local}
      CADDY_APP_HTTPS_HOSTS: ${CADDY_APP_HTTPS_HOSTS:-filamentapp.net app.filament.local}
      CADDY_API_HTTPS_HOSTS: ${CADDY_API_HTTPS_HOSTS:-api.filament.local}
      CADDY_WEB_UPSTREAM: ${CADDY_WEB_UPSTREAM:-host.docker.internal:4173}
      CADDY_LIVEKIT_PROXY_PORT: ${CADDY_LIVEKIT_PROXY_PORT:-8443}
      CADDY_LEGACY_SERVER_PORT: ${CADDY_LEGACY_SERVER_PORT:-8080}
      LIVEKIT_PORT: ${LIVEKIT_PORT:-7880}
    ports:
      - "${CADDY_HTTP_PORT:-80}:80"
      - "${CADDY_HTTPS_PORT:-443}:443"
      - "${CADDY_LIVEKIT_PROXY_PORT:-8443}:${CADDY_LIVEKIT_PROXY_PORT:-8443}"
      - "${CADDY_LEGACY_SERVER_PORT:-8080}:${CADDY_LEGACY_SERVER_PORT:-8080}"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - ./certs:/etc/caddy/certs:ro
      - caddy-data:/data
      - caddy-config:/config
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - filament-internal
      - filament-edge
    security_opt:
      - no-new-privileges:true

volumes:
  pg-data:
  filament-attachments:
  caddy-data:
  caddy-config:

networks:
  filament-internal:
    internal: true
  filament-edge:
