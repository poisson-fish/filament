{
  # Cloudflare "Full (Strict)" requires a valid certificate on the origin.
  # We use the Cloudflare Origin CA certificate mounted at /etc/caddy/certs.
  auto_https off
  admin off
}


(tls_origin_cert) {
  tls {$CADDY_TLS_CERT_PATH} {$CADDY_TLS_KEY_PATH}
}

(security_headers) {
  header {
    X-Content-Type-Options "nosniff"
    X-Frame-Options "DENY"
    Referrer-Policy "no-referrer"
    Strict-Transport-Security "max-age=31536000; includeSubDomains"
  }
}

(api_gateway_routes) {
  @api_path path /api /api/*
  handle @api_path {
    uri strip_prefix /api
    reverse_proxy filament-server:3000 {
      header_up X-Forwarded-For {header.CF-Connecting-IP}
      header_up X-Real-IP {header.CF-Connecting-IP}
    }
  }

  @gateway_path path /gateway/ws /gateway/ws*
  handle @gateway_path {
    reverse_proxy filament-server:3000 {
      header_up X-Forwarded-For {header.CF-Connecting-IP}
      header_up X-Real-IP {header.CF-Connecting-IP}
    }
  }
}

# Redirect all HTTP to HTTPS
:80 {
  redir https://{host}{uri}
}

# App host: SPA + same-origin API/gateway paths
https://{$CADDY_APP_HTTPS_HOSTS} {
  import tls_origin_cert
  encode zstd gzip
  import security_headers
  import api_gateway_routes

  # Frontend upstream (for example host Vite dev server or filament-web:4173)
  handle {
    reverse_proxy {$CADDY_WEB_UPSTREAM}
  }
}

# API host: API + gateway only
https://{$CADDY_API_HTTPS_HOSTS} {
  import tls_origin_cert
  encode zstd gzip
  import security_headers
  import api_gateway_routes

  handle {
    respond 404
  }
}

# LiveKit Signaling Proxy
# Allows clients to connect via wss://<host>:<port>
:{$CADDY_LIVEKIT_PROXY_PORT} {
  import tls_origin_cert
  reverse_proxy livekit:{$LIVEKIT_PORT}
}

# Keep the old port for direct access if needed (optional, can be removed)
:{$CADDY_LEGACY_SERVER_PORT} {
  reverse_proxy filament-server:3000 {
    header_up X-Forwarded-For {remote_host}
    header_up X-Real-IP {remote_host}
  }
}
