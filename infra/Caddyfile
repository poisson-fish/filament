{
  # Cloudflare "Full (Strict)" requires a valid certificate on the origin.
  # We use the Cloudflare Origin CA certificate mounted at /etc/caddy/certs.
  auto_https off
  admin off
}

# Redirect HTTP to HTTPS
http://filamentapp.net {
  redir https://filamentapp.net{uri}
}

https://filamentapp.net {
  encode zstd gzip

  # SSL Configuration
  tls /etc/caddy/certs/cert.pem /etc/caddy/certs/key.pem

  header {
    X-Content-Type-Options "nosniff"
    X-Frame-Options "DENY"
    Referrer-Policy "no-referrer"
    Strict-Transport-Security "max-age=31536000; includeSubDomains"
  }

  # Backend API
  handle /api/* {
    uri strip_prefix /api
    reverse_proxy filament-server:3000
  }

  # Backend WebSocket Gateway
  handle /gateway/* {
    uri strip_prefix /gateway
    reverse_proxy filament-server:3000
  }

  # Frontend (Vite Dev Server running on Host)
  # Requires "host.docker.internal" to be mapped in docker-compose.yml
  handle /* {
    reverse_proxy host.docker.internal:4173
  }
}

# LiveKit Signaling Proxy
# Allows clients to connect via wss://filamentapp.net:8443
:8443 {
  tls /etc/caddy/certs/cert.pem /etc/caddy/certs/key.pem
  reverse_proxy livekit:7880
}

# Keep the old port for direct access if needed (optional, can be removed)
:8080 {
  reverse_proxy filament-server:3000
}
